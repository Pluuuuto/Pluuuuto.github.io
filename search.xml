<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>2024MoeCTF-hidden_poly</title>
      <link href="/2025/03/10/2024MoeCTF-hidden-poly/"/>
      <url>/2025/03/10/2024MoeCTF-hidden-poly/</url>
      
        <content type="html"><![CDATA[<h1 id="hidden_poly">hidden_poly</h1><p>是一个比较基础的格题，但是我还是一下没做出来...也值得学习记录一下</p><p>题目给出的等式即存在 <spanclass="math inline">\(k\in\mathbb{Z}\)</span>，使得 <spanclass="math display">\[\sum_{i=0}^{15}key_{i}*root^{i}+kq=0\]</span></p><h2 id="常规思路">常规思路</h2><p>构造格基即 <span class="math display">\[(key_0,key_1,\dots,key_{15},k)\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; \dots&amp; 0 &amp; root^0\\0 &amp; 1 &amp; 0 &amp; \dots&amp; 0 &amp; root^1\\\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp;\vdots\\0 &amp; 0 &amp; 0 &amp; \dots&amp; 1 &amp; root^{15}\\0 &amp; 0 &amp; 0 &amp; \dots&amp; 0 &amp; q\end{pmatrix}=(key_0,key_1,\dots,key_{15},0)\]</span> 算一下范数，格基是 <span class="math inline">\(\sqrt {16}q^{\frac{1}{16}}\)</span> 大概 <span class="math inline">\(10\)</span>位，而目标向量按最长算也就是 <spanclass="math inline">\(\sqrt{(2^7)^2*16}\)</span> 大概 <spanclass="math inline">\(9\)</span> 位，是平衡的</p><p>但是这里有一个问题，就是这个格基的最短向量不是目标向量，而是这里的第一行向量<span class="math display">\[\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; 0 &amp; \dots &amp; root^0\end{pmatrix}\]</span> <span class="math inline">\(root^0\)</span> 即 <spanclass="math inline">\(1\)</span>，这个向量显然比 <spanclass="math display">\[(key_0,key_1,\dots,key_{15},0)\]</span>要短，故规约出来的结果第一个行向量，即最短向量，不是目标向量</p><p>规约出来的结果如下</p><img src="/2025/03/10/2024MoeCTF-hidden-poly/image-20250310231040133.png" class="" title="image-20250310231040133"><p>可以看到，第一行向量，即最短向量确实是 <spanclass="math inline">\(\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; 0 &amp; \dots &amp; root^0\end{pmatrix}\)</span>，所以要往下寻找目标向量</p><p>第二行中，出现了值为 <span class="math inline">\(142\)</span>的分量，超过了 <span class="math inline">\(key_i\)</span> 的范围 <spanclass="math inline">\(0 \sim 2^7\)</span> ，也不是要找的目标向量</p><p>第三行的向量分量全都符合范围，应该就是要找的目标向量</p><p>但是这里又出现了一个问题，回看刚才构造的格基和等式，可以看到目标向量的最后一个分量应当是<span class="math inline">\(0\)</span>，但是这里并不是 <spanclass="math inline">\(0\)</span>，为什么呢？</p><p>再次回到等式 <span class="math display">\[\sum_{i=0}^{15}key_{i}*root^{i}+kq=0\]</span> 展开来写 <span class="math display">\[key_0*root^0+key_{1}*root^{1}+key_{2}*root^{2}+\dots+key_{15}*root^{15}+kq=0\]</span> 即 <span class="math display">\[key_0+key_{1}*root^{1}+key_{2}*root^{2}+\dots+key_{15}*root^{15}+kq=0\]</span>写成这样就能看出来，多出来的值是从哪里来的了：这个多项式只有第一项 <spanclass="math inline">\(key_0\)</span> 是在 <spanclass="math inline">\(0\sim2^7\)</span>内，所以其实规约出来的结果，<span class="math inline">\(key_0\)</span>的正确值应当是第三行的第一个分量的值减去最后一个分量的值</p><p>exp 如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"> </span><br><span class="line">q = <span class="number">264273181570520944116363476632762225021</span></span><br><span class="line">root = <span class="number">122536272320154909907460423807891938232</span></span><br><span class="line">n = <span class="number">16</span></span><br><span class="line">iv = <span class="string">b&#x27;Gc\xf2\xfd\x94\xdc\xc8\xbb\xf4\x84\xb1\xfd\x96\xcd6\\&#x27;</span></span><br><span class="line">ciphertext = <span class="string">&#x27;d23eac665cdb57a8ae7764bb4497eb2f79729537e596600ded7a068c407e67ea75e6d76eb9e23e21634b84a96424130e&#x27;</span></span><br><span class="line">ciphertext=<span class="built_in">bytes</span>.fromhex(ciphertext)</span><br><span class="line"></span><br><span class="line">M = Matrix(ZZ, n+<span class="number">1</span>, n+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    M[i, i] = <span class="number">1</span></span><br><span class="line">    M[i, -<span class="number">1</span>] = root^i</span><br><span class="line">M[-<span class="number">1</span>, -<span class="number">1</span>] = q</span><br><span class="line">M = M.LLL()</span><br><span class="line"><span class="built_in">print</span>(M)</span><br><span class="line"></span><br><span class="line">key = [<span class="literal">None</span>]*n</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,n):</span><br><span class="line">    key[i] = <span class="built_in">chr</span>(<span class="built_in">abs</span>(<span class="built_in">int</span>(M[<span class="number">2</span>][i])))</span><br><span class="line">key[<span class="number">0</span>] = <span class="built_in">chr</span>(<span class="built_in">abs</span>(<span class="built_in">int</span>(M[<span class="number">2</span>][<span class="number">0</span>]-M[<span class="number">2</span>][-<span class="number">1</span>])))</span><br><span class="line">key = <span class="string">&#x27;&#x27;</span>.join(key)</span><br><span class="line"></span><br><span class="line">cipher = AES.new(key.encode(),AES.MODE_CBC, iv)</span><br><span class="line">plaintext = cipher.decrypt(ciphertext)</span><br><span class="line"><span class="built_in">print</span>(plaintext)</span><br></pre></td></tr></table></figure><h2 id="改进思路">改进思路</h2><p>既然上面说了，最短的向量是 <spanclass="math inline">\(\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; 0 &amp; \dots &amp; root^0\end{pmatrix}\)</span>，那么可以直接把它避开</p><p>有 <span class="math display">\[key_0+key_{1}*root^{1}+key_{2}*root^{2}+\dots+key_{15}*root^{15}+kq=0\]</span> 则 <span class="math display">\[key_{1}*root^{1}+key_{2}*root^{2}+\dots+key_{15}*root^{15}+kq=-key_0\]</span> 构造 <span class="math display">\[(key_1,key_2,\dots,key_{15},k)\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; \dots&amp; 0 &amp; root^1\\0 &amp; 1 &amp; 0 &amp; \dots&amp; 0 &amp; root^2\\\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp;\vdots\\0 &amp; 0 &amp; 0 &amp; \dots&amp; 1 &amp; root^{15}\\0 &amp; 0 &amp; 0 &amp; \dots&amp; 0 &amp; q\end{pmatrix}=(key_1,key_2,\dots,key_{15}, -key_0)\]</span> 这样还把最后一列规约不出来 <spanclass="math inline">\(0\)</span> 的问题一并解决了，是一个改进的方法</p><p>exp 如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">q = <span class="number">264273181570520944116363476632762225021</span></span><br><span class="line">root = <span class="number">122536272320154909907460423807891938232</span></span><br><span class="line">n = <span class="number">16</span></span><br><span class="line">iv = <span class="string">b&#x27;Gc\xf2\xfd\x94\xdc\xc8\xbb\xf4\x84\xb1\xfd\x96\xcd6\\&#x27;</span></span><br><span class="line">ciphertext = <span class="string">&#x27;d23eac665cdb57a8ae7764bb4497eb2f79729537e596600ded7a068c407e67ea75e6d76eb9e23e21634b84a96424130e&#x27;</span></span><br><span class="line">ciphertext=<span class="built_in">bytes</span>.fromhex(ciphertext)</span><br><span class="line"></span><br><span class="line">M = Matrix(ZZ, n, n)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n-<span class="number">1</span>):</span><br><span class="line">    M[i, i] = <span class="number">1</span></span><br><span class="line">    M[i, -<span class="number">1</span>] = root^(i+<span class="number">1</span>)</span><br><span class="line">M[-<span class="number">1</span>, -<span class="number">1</span>] = q</span><br><span class="line">M = M.LLL()</span><br><span class="line"><span class="built_in">print</span>(M)</span><br><span class="line"></span><br><span class="line">key = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    key.append(<span class="built_in">chr</span>(<span class="built_in">abs</span>(<span class="built_in">int</span>(M[<span class="number">0</span>][i]))))</span><br><span class="line">key = <span class="string">&#x27;&#x27;</span>.join(key)</span><br><span class="line">key = key[-<span class="number">1</span>]+key[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">cipher = AES.new(key.encode(),AES.MODE_CBC, iv)</span><br><span class="line">plaintext = cipher.decrypt(ciphertext)</span><br><span class="line"><span class="built_in">print</span>(plaintext)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> crypto </tag>
            
            <tag> lattice </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-Reverse工具与环境配置</title>
      <link href="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
      <url>/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="ctf-reverse工具与环境配置">CTF-Reverse工具与环境配置</h1><h2 id="什么是-re">什么是 re？</h2><p>用《逆向工程核心原理》中的定义</p><blockquote><p>软件逆向工程是一种探究应用程序内部组成结构及工作原理的技术，运用逆向分析技术,窥探程序内部结构, 掌握其工作原理。</p></blockquote><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250220210716651.png" class="" title="image-20250220210716651"><p>逆过来就是</p><blockquote><p>识别程序文件的类型 ---&gt; 利用合适的反编译工具将程序还原成流程图 or伪代码 ---&gt; 静态分析反编译后的程序 or 动态调试程序 ---&gt;根据分析结果获得 flag</p></blockquote><h2 id="知识储备">知识储备</h2><ul><li>基础课程——C 语言、数据结构、计算机系统基础及实验</li><li>必要语言——C/C++、Python、Java（可选）、JavaScripts（可选）</li><li>扩展知识——基本 x86汇编指令、常用加解密算法、可执行程序相关知识、cmake</li></ul><h2 id="查壳工具">查壳工具</h2><h3 id="exeinfo-pe"><a href="http://www.exeinfo.byethost18.com/">ExeinfoPE</a></h3><p>正常二进制程序</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250220200728052.png" class="" title="image-20250220200728052"><p>加了 UPX 壳的</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250220201435261.png" class="" title="image-20250220201435261"><h3 id="die"><ahref="https://github.com/horsicq/DIE-engine">DIE</a></h3><p>正常二进制程序</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250220200627658.png" class="" title="image-20250220200627658"><p>加了 UPX 壳的</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250220201549485.png" class="" title="image-20250220201549485"><h3 id="peid"><ahref="https://www.softpedia.com/get/Programming/Packers-Crypters-Protectors/PEiD-updated.shtml">PEiD</a></h3><p>自行下载体验</p><h2 id="逆向必备神器ida-pro">逆向必备神器——IDA Pro</h2><p><a href="https://www.52pojie.cn/">吾爱破解</a>下载</p><h3 id="插件下载">插件下载</h3><p>在 Github 上下载后放到 IDA 安装目录下的 plugins 文件夹中即可</p><h4 id="findcrypt"><ahref="https://github.com/polymorf/findcrypt-yara">findcrypt</a></h4><p>识别算法的插件，需要 Python 环境，IDA9.0 不自带Python，建议自己下载一个放在 IDA 安装目录下</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250221152604060.png" class="" title="image-20250221152604060"><h4 id="patching"><ahref="https://github.com/gaasedelen/patching">patching</a></h4><p>keypatch 的替代，keypatch生成的汇编代码有的时候会变长，而且目前已经停更，patching在持续更新中</p><h4 id="obpo"><ahref="https://github.com/obpo-project/obpo-plugin">obpo</a></h4><p>反ollvm混淆的插件，目前在 Github 上已 archived（已归档）</p><h2 id="动态调试工具">动态调试工具</h2><h3 id="x64dbg"><a href="https://x64dbg.com/">x64dbg</a></h3><p>适用于 windows 平台的 32 位/64 位调试器</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250220210614668.png" class="" title="image-20250220210614668"><h3 id="ollydbg"><a href="https://www.ollydbg.de/">Ollydbg</a></h3><p>也可在<ahref="https://www.52pojie.cn/">吾爱破解</a>下载，同样是适用于 windows平台的调试器</p><h3 id="ida">IDA</h3><p>一般来说，简单的调试在 IDA 中就可以进行，方便快捷；同时 IDA还可以进行 Linux 下的 elf 文件动态调试，建议新手可以先学 IDA的动态调试</p><h2 id="文件编辑器">文件编辑器</h2><h3 id="editor">010editor</h3><p>自行检索资源下载，安装需要的文件类型的模板</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250220210446987.png" class="" title="image-20250220210446987"><h3 id="winhex">winhex</h3><p>自行下载体验</p><h2 id="环境配置">环境配置</h2><h3 id="cc-环境配置">C/C++ 环境配置</h3><p>首先分清楚 <strong>编译器（Compiler） </strong>与<strong>IDE（Integrated Development Environment，集成开发环境）</strong>的区别</p><p>编译器是</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250220215755755.png" class="" title="image-20250220215755755"><p>IDE 是</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250220215927382.png" class="" title="image-20250220215927382"><h4 id="gcc-编译器">GCC 编译器</h4><p>GCC (GNU Compiler Collection) 是 GNU项目中的编译器集合，支持多种编程语言，包括 C、C++、Fortran、Ada等。它是开源且跨平台的，广泛应用于 Linux 和其他操作系统中</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/522c612dbc613668fe630bac1d1dd30d.jpeg" class="" title="522c612dbc613668fe630bac1d1dd30d"><h5 id="windows-中的-gcc">Windows 中的 GCC</h5><blockquote><p>如果按照老师上课教的去下载 IDE，老师会告诉你不需要自己配置 GCC的环境，因为下载的 IDE 里自带了 MinGW，那么 MinGW 又是什么？</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/%E4%B8%8B%E8%BD%BD.jpg" class="" title="下载"></blockquote><p>MinGW 是一个为 Windows 平台提供的 GNU 工具链，包含了 GCC和其他工具，如 gdb 调试器，MinGW 的目标是为 Windows提供一个本地的编译器，使开发者能够使用 GCC 工具集进行 Windows 开发</p><p>GCC 本身是跨平台的，支持多种操作系统，主要用于 Linux、macOS 等类 Unix系统的开发，但也能在 Windows 上使用，通常需要通过 Cygwin 或 MinGW等工具来运行</p><h4 id="环境变量配置">环境变量配置</h4><p>一般下载 codeblocks 或 MinGW 会自动配置</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250221150903329.png" class="" title="image-20250221150903329"><h5 id="演示">演示</h5><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250220224713327.png" class="" title="image-20250220224713327"><h4 id="msvc-编译器">MSVC 编译器</h4><p>MSVC（Microsoft Visual C++） 是微软提供的 C 和 C++ 编译器，作为Visual Studio 集成开发环境的一部分，它在 Windows 操作系统中广泛使用</p><h5 id="特点">特点</h5><ul><li>专为 Windows 系统优化</li><li>与 Visual Studio 集成，提供强大的调试和开发工具</li><li>支持 Windows API 和其他微软的库</li></ul><h5 id="下载与环境配置">下载与环境配置</h5><p>推荐直接下载 <ahref="https://visualstudio.microsoft.com/zh-hans/">VisualStudio</a>，下载时勾选 “使用 C++ 的桌面开发”，自动勾选 MSVC编译器下载（后期还可以通过 Visual Studio Installer 安装其他工具）</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250221145720106.png" class="" title="image-20250221145720106"><p>配置 PATH 环境变量</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250221150033488.png" class="" title="image-20250221150033488"><p>配置 INCLUDE 与 LIB 环境变量</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250221145459970.png" class="" title="image-20250221145459970"><p>INCLUDE 变量详情</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250221145927428.png" class="" title="image-20250221145927428"><p>LIB 变量详情</p><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250221145939349.png" class="" title="image-20250221145939349"><h5 id="演示-1">演示</h5><img src="/2025/02/20/CTF-Reverse%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/image-20250221150753244.png" class="" title="image-20250221150753244"><h4 id="其他编译器">其他编译器</h4><p>Clang 编译器是一个由 LLVM 项目开发的编译器，支持 C、C++、Objective-C和 Swift 等语言，它被设计为一个现代、高效的编译器，macOS使用 Clang作为默认编译器</p><h2 id="python-环境配置">Python 环境配置</h2><blockquote><p>python 是 IDA 支持的脚本语言 IDC 的基础，了解并学习 python不仅可以简化解题脚本的编写，而且方便在后续的学习中利用开源社区的现有工具以及入门IDC</p></blockquote><p>之前扫盲课已经介绍了一部分，这里主要说的是使用 Conda 进行 Python版本管理</p><h3 id="conda-下载">Conda 下载</h3><p><a href="https://anaconda.org/anaconda/conda">官网链接</a></p><h3 id="常见命令">常见命令</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 查看环境中安装了哪些包，默认是base环境</span><br><span class="line">conda list</span><br><span class="line"># 查看当前存在哪些虚拟环境</span><br><span class="line">conda env list </span><br><span class="line"># 创建虚拟环境</span><br><span class="line">conda create -n [env_name] python=x.x</span><br><span class="line"># 或者克隆</span><br><span class="line">conda create -n your_name --clone env_name</span><br><span class="line"># 激活或者切换虚拟环境</span><br><span class="line">conda activate [env_name]</span><br><span class="line"># 退出虚拟环境</span><br><span class="line">conda deactivate</span><br><span class="line"># 删除虚拟环境</span><br><span class="line">conda remove -n [env_name] --all</span><br></pre></td></tr></table></figure><p>Conda的服务器在国外，安装多个packages时，下载速度经常很慢，清华TUNA镜像源有Anaconda仓库的镜像，将其加入conda的配置即可</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 设置国内镜像</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/msys2/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</span><br><span class="line">conda config --<span class="built_in">set</span> show_channel_urls yes</span><br></pre></td></tr></table></figure><h2 id="如何学-re">如何学 re？</h2><h3 id="动手写代码">动手写代码</h3><p><strong>一定一定一定要自己动手写代码</strong>，锻炼代码能力，包括C/C++、 Python 代码，安卓还涉及到 Java、JavaScripts</p><p>另外，平时多积累一些密码算法的板子，如 TEA 系列算法、RC4 算法、AES算法等</p><p><a href="https://gchq.github.io/CyberChef/">CyberChef</a></p><h3 id="多刷题">多刷题</h3><p><a href="https://ctf.xidian.edu.cn/">西电CTF平台</a>（里面的 MoeCTF比赛比较适合新生）</p><p><a href="https://buuoj.cn/">BUUOJ</a></p><p><a href="https://ctf.show/">CTFshow</a></p><p><a href="https://www.nssctf.cn/">NSSCTF</a></p><h3 id="多看文章">多看文章</h3><p><a href="https://www.52pojie.cn/">吾爱破解</a></p><p><a href="https://www.kanxue.com/">看雪论坛</a></p>]]></content>
      
      
      <categories>
          
          <category> reverse笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Reverse </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WP-[2025.1西湖论剑]matrixRSA</title>
      <link href="/2025/02/03/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-matrixRSA/"/>
      <url>/2025/02/03/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-matrixRSA/</url>
      
        <content type="html"><![CDATA[<h1 id="matrixrsa">matrixRSA</h1><h2 id="初次复现">初次复现</h2><p>比赛的时候在哈尔滨🧊玩，队友太给力了，差点干进决赛了🐮，赛后复现一下</p><p>这是一道不难的 RSA，第一段是一个泄露 <spanclass="math inline">\(p\)</span> 高位，<spanclass="math inline">\(512\)</span> 位的 <spanclass="math inline">\(p\)</span> 泄露了 <spanclass="math inline">\(412\)</span> 位，绰绰有余，套板子即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">132298777672085547096511087266255066285502135020124093900452138262993155381766816424955849796168059204379325075568094431259877923353664926875986223020472585645919414821322880213299188157427622804140996898685564075484754918339670099806186873974594139182324884620018780943630196754736972805036038798946726414009</span></span><br><span class="line">p4 = <span class="number">9707529668721508094878754383636813058761407528950189013789315732447048631740849315894253576415843631107370002912949379757275</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">pbits = <span class="number">512</span></span><br><span class="line"></span><br><span class="line">kbits=pbits - p4.nbits()</span><br><span class="line"><span class="built_in">print</span>(p4.nbits())</span><br><span class="line">p4 = p4 &lt;&lt; kbits</span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">f = x + p4</span><br><span class="line">roots = f.small_roots(X=<span class="number">2</span>^kbits,beta=<span class="number">0.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> roots:</span><br><span class="line">    p = p4 + <span class="built_in">int</span>(roots[<span class="number">0</span>])</span><br><span class="line">    q = n/p</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&quot;n:&quot;</span>,n)</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&quot;p:&quot;</span>,p)</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&quot;q:&quot;</span>,q)</span><br></pre></td></tr></table></figure><p>第二段是一个论文题，<ahref="https://www.researchtrend.net/ijet/pdf/13%20%20Matrix%20Modification%20of%20RSA%20Public%20Key%20Cryptosystem%20and%20its%20Variant%20Manju%20Sanghi%203513.pdf">论文链接在此</a></p><p>根据论文中的结论，这种基于矩阵的 RSA 在求 <spanclass="math inline">\(d\)</span> 时， <spanclass="math inline">\(e\)</span> 的逆元是在模 <spanclass="math inline">\(N\prime\)</span> 意义下的，<spanclass="math inline">\(N \prime\)</span> 的值为 <spanclass="math inline">\((p^h-1)(q^h-1)\)</span>，其中 <spanclass="math inline">\(h\)</span> 为矩阵的阶</p><p>但是，经过测试，实际上不管矩阵的阶是多少，<spanclass="math inline">\(N \prime\)</span> 的值取 <spanclass="math inline">\((p^2-1)(q^2-1)\)</span> 都可以得到正确的 <spanclass="math inline">\(d\)</span>，而且目前看到的所有wp，不管是各个师傅的，还是官方的，用的都是 <spanclass="math inline">\((p^2-1)(q^2-1)\)</span>，但这道题里明明是一个三阶矩阵，按照论文中的结论应该用<span class="math inline">\((p^3-1)(q^3-1)\)</span>才对，事实却是错的，至于原因，现在还没想清楚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">d = <span class="built_in">pow</span>(e,-<span class="number">1</span>,(p**<span class="number">2</span>-<span class="number">1</span>)*(q**<span class="number">2</span>-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">C = Matrix(Zmod(n),[[..., ..., ...],</span><br><span class="line">[..., ..., ...],</span><br><span class="line">[..., ..., ...]])</span><br><span class="line"></span><br><span class="line">M = C**<span class="built_in">int</span>(d)</span><br><span class="line"><span class="keyword">for</span> MM <span class="keyword">in</span> M:</span><br><span class="line">    <span class="keyword">for</span> MMM <span class="keyword">in</span> MM:</span><br><span class="line">        <span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(MMM)).decode(),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="探究正确模数">探究正确模数</h2><p>实际上，刚才上面引用的论文中，有提及前人已有的成果，这篇文章也是在此基础上总结，推测可以使用模数<spanclass="math inline">\((p^h-1)(q^h-1)\)</span>，而前人已有成果中，就有取<span class="math display">\[g=\prod_{i=0}^{h-1}(p^h-p^i)\prod_{i=0}^{h-1}(q^h-q^i)\]</span> <img src="/2025/02/03/2025%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-matrixRSA/image-20250201214230733.png" class=""></p><p>经过测试，使用这个 <span class="math inline">\(g\)</span>作为模数也是正确的，也就是在这题中取 <span class="math display">\[d = \mathrm{pow}(e,-1,(p^3-p^2)(p^3-p)(p^3-1)(q^3-q^2)(q^3-q)(q^3-1))\]</span> 也是可以得到正确的 <span class="math inline">\(d\)</span>的</p><p>而上面提到的这个结论，也就是上图中框出的 Andrew Pangia 提出的结论，<ahref="https://www.gcsu.edu/sites/files/page-assets/node-808/attachments/pangia.pdf">论文链接在此</a>，文章中对结论在<span class="math inline">\(h=2\)</span>的情况时做了证明，下面做一个简单整理</p><h3 id="证明过程">证明过程</h3><p>首先根据一般线性群的性质，有群 <spanclass="math inline">\(GF_2(\mathbb{Z_p})\)</span> 的阶为 <spanclass="math display">\[g_p=(p^2-p)(p^2-1)\]</span> 同理，群 <spanclass="math inline">\(GF_2(\mathbb{Z_q})\)</span> 的阶为 <spanclass="math display">\[g_q=(q^2-q)(q^2-1)\]</span> 采用的模数 <span class="math display">\[g=g_pg_q\]</span> 即 <span class="math display">\[ed\equiv1\bmod g\]</span> 即 <span class="math display">\[ed=1+kg,k\in\mathbb{Z}\]</span> 故 <span class="math display">\[\begin{aligned}C^d&amp;=M^{ed}\bmod n\\&amp;=M^{1+kg}\bmod n\\&amp;=M\cdot M^{kg_pg_q}\bmod p\\&amp;=M\cdot ((M^{g_p})^{g_q})^k\bmod p\\\end{aligned}\]</span> 由于明文矩阵 <span class="math inline">\(\langleM\rangle\)</span> 是 <spanclass="math inline">\(GF_2(\mathbb{Z_q})\)</span>的子群，由拉格朗日定理，群 <span class="math inline">\(\langleM\rangle\)</span> 的阶的是群 <spanclass="math inline">\(GF_2(\mathbb{Z_q})\)</span> 的阶的因子，设为 <spanclass="math inline">\(x\)</span>，即有 <span class="math display">\[g_p=jx,j\in\mathbb{Z}\]</span> 故 <span class="math display">\[\begin{aligned}C^d&amp;=M\cdot ((M^{g_p})^{g_q})^k\bmod p\\&amp;=M\cdot ((M^{jx})^{g_q})^k\bmod p\\&amp;=M\cdot ((M^{x})^{jg_q})^k\bmod p\\&amp;=M\cdot I^{jg_qk}\bmod p\\&amp;=M\bmod p\\\end{aligned}\]</span> 其中，<span class="math inline">\(I\)</span> 为单位矩阵，因为<span class="math inline">\(x\)</span> 是群 <spanclass="math inline">\(\langle M\rangle\)</span> 的阶</p><blockquote><p>需要注意这里得到 <span class="math inline">\(M^x=I\)</span> 需要在<span class="math inline">\(\mathbb{Z_p}\)</span>下才能成立，这是一般线性群的定义要求的，这也是为什么上面从<spanclass="math inline">\(\bmod n\)</span> 变成了<spanclass="math inline">\(\bmod p\)</span></p></blockquote><p>同理，还可以得到 <span class="math display">\[C^d=M\bmod q\\\]</span> 故 <span class="math display">\[C^d=M\bmod n\\\]</span> 证明完毕</p><h3 id="推广">推广</h3><p>可以看到，以上证明过程，与所涉及的一般线性群的阶的值 <spanclass="math inline">\(g_p,g_q\)</span>并无直接关系，因此可以将结论推广至高阶，即 <spanclass="math inline">\(h\)</span> 阶的基于矩阵的 RSA 加密，在求 <spanclass="math inline">\(d\)</span> 时所用的模数为 <spanclass="math display">\[\begin{aligned}g&amp;=g_pg_q\\&amp;=\prod_{i=0}^{h-1}(p^h-p^i)\prod_{i=0}^{h-1}(q^h-q^i)\end{aligned}\]</span> 同样，当 <span class="math inline">\(h\)</span> 取 <spanclass="math inline">\(1\)</span> 的时候，<spanclass="math inline">\(g\)</span> 的值就是 <spanclass="math inline">\((p-1)(q-1)\)</span>，也就是正常 RSA 的 <spanclass="math inline">\(\varphi\)</span> 值，因为 <spanclass="math inline">\(h\)</span> 取 <spanclass="math inline">\(1\)</span> 的时候，是一个 <spanclass="math inline">\(1\times1\)</span>的矩阵，也就相当于没有矩阵，是一个正常的 RSA</p><h3 id="新-wp">新 wp</h3><p>修改后的 wp 如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gp = (p**<span class="number">3</span>-p**<span class="number">2</span>)*(p**<span class="number">3</span>-p)*(p**<span class="number">3</span>-<span class="number">1</span>)</span><br><span class="line">gq = (q**<span class="number">3</span>-q**<span class="number">2</span>)*(q**<span class="number">3</span>-q)*(q**<span class="number">3</span>-<span class="number">1</span>)</span><br><span class="line">d = <span class="built_in">pow</span>(e,-<span class="number">1</span>,gp*gq)</span><br><span class="line"></span><br><span class="line">C = Matrix(Zmod(n),[[..., ..., ...],</span><br><span class="line">[..., ..., ...],</span><br><span class="line">[..., ..., ...]])</span><br><span class="line"></span><br><span class="line">M = C**<span class="built_in">int</span>(d)</span><br><span class="line"><span class="keyword">for</span> MM <span class="keyword">in</span> M:</span><br><span class="line">    <span class="keyword">for</span> MMM <span class="keyword">in</span> MM:</span><br><span class="line">        <span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(MMM)).decode(),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="仍存在的问题">仍存在的问题</h3><p>目前为止，还存在一个问题，就是为什么用这个 <spanclass="math inline">\(d\)</span> 也可以 <span class="math display">\[d = \mathrm{pow}(e,-1,(p^2-p)(p^2-1)(q^2-q)(q^2-1))\]</span> 用这个 <span class="math inline">\(d\)</span>也可以恢复出一样的明文矩阵 <span class="math inline">\(M\)</span></p>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> crypto </tag>
            
            <tag> RSA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WP-[2025.1软件系统安全赛]happylock</title>
      <link href="/2025/01/14/2025%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E8%B5%9B-happylock/"/>
      <url>/2025/01/14/2025%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E8%B5%9B-happylock/</url>
      
        <content type="html"><![CDATA[<h1 id="happylock">HappyLock</h1><p>比赛的时候写了好久，可惜还是差一些，没有写出来...</p><h2 id="赛中进度">赛中进度</h2><p>模拟器里运行一下，这是一个手势密码验证程序，通过输入正确手势密码得到一个哈希值作为<code>flag</code></p><h3 id="框架oncomplete方法">框架<code>oncomplete</code>方法</h3><p>jadx反编译，核心在<code>com.crackme.happylock.MainActivity</code>类的<code>oncomplete</code>方法中，这个方法实现了将用户输入的手势密码进行编码加密处理以及与预设值进行对比</p><p><img src="image-20250111111423716.png" /></p><p>解析如下，其中<code>StringObf.decode</code>方法就是 base64 解码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="comment">// com.andrognito.patternlockview.listener.PatternLockViewListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">(List&lt;PatternLockView.Dot&gt; list)</span> &#123;</span><br><span class="line">    <span class="type">MainActivity</span> <span class="variable">$r2</span> <span class="operator">=</span> MainActivity.<span class="built_in">this</span>;</span><br><span class="line">    <span class="type">PatternLockView</span> <span class="variable">$r3</span> <span class="operator">=</span> $r2.mPatternLockView;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">$r4</span> <span class="operator">=</span> PatternLockUtils.enc($r3, list); <span class="comment">// 将用户绘制的图案进行加密</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">$z0</span> <span class="operator">=</span> Utils.cmp($r4); <span class="comment">// 比较加密后的图案和预设的图案</span></span><br><span class="line">        <span class="keyword">if</span> (!$z0) &#123;</span><br><span class="line">            <span class="comment">// 如果图案不匹配</span></span><br><span class="line">            <span class="type">MainActivity</span> <span class="variable">$r22</span> <span class="operator">=</span> MainActivity.<span class="built_in">this</span>;</span><br><span class="line">            <span class="type">PatternLockView</span> <span class="variable">$r32</span> <span class="operator">=</span> $r22.mPatternLockView;</span><br><span class="line">            $r32.setViewMode(<span class="number">2</span>); <span class="comment">// 设置图案锁为错误模式（显示错误提示）</span></span><br><span class="line">            <span class="type">MainActivity</span> <span class="variable">$r23</span> <span class="operator">=</span> MainActivity.<span class="built_in">this</span>;</span><br><span class="line">            <span class="type">Context</span> <span class="variable">$r5</span> <span class="operator">=</span> $r23.context;</span><br><span class="line">            <span class="type">Toast</span> <span class="variable">$r8</span> <span class="operator">=</span> Toast.makeText($r5, StringObf.decode(<span class="string">&quot;VHJ5IGFnYWlu&quot;</span>), <span class="number">0</span>); <span class="comment">// 解密提示信息，base64解码为&quot;Try again&quot;</span></span><br><span class="line">            $r8.show(); <span class="comment">// 显示提示信息</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果图案匹配</span></span><br><span class="line">        <span class="type">MainActivity</span> <span class="variable">$r24</span> <span class="operator">=</span> MainActivity.<span class="built_in">this</span>;</span><br><span class="line">        <span class="type">PatternLockView</span> <span class="variable">$r33</span> <span class="operator">=</span> $r24.mPatternLockView;</span><br><span class="line">        $r33.setViewMode(<span class="number">0</span>); <span class="comment">// 设置图案锁为正常模式（显示成功提示）</span></span><br><span class="line">        <span class="type">MainActivity</span> <span class="variable">$r25</span> <span class="operator">=</span> MainActivity.<span class="built_in">this</span>;</span><br><span class="line">        <span class="type">Context</span> <span class="variable">$r52</span> <span class="operator">=</span> $r25.context;</span><br><span class="line">        <span class="type">String</span> <span class="variable">$r7</span> <span class="operator">=</span> StringObf.decode(<span class="string">&quot;U3VibWl0IGRhcnR7&quot;</span>); <span class="comment">// 解密成功提示的字符串，base64解码为&quot;Submit dart&#123;&quot;</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">$r6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>($r7);</span><br><span class="line">        <span class="type">Toast</span> <span class="variable">$r82</span> <span class="operator">=</span> Toast.makeText($r52, $r6.append($r4).append(StringObf.decode(<span class="string">&quot;fQ==&quot;</span>)).toString(), <span class="number">1</span>); <span class="comment">// 显示包含加密图案的提示信息，base64解码为&quot;&#125;&quot;</span></span><br><span class="line">        $r82.show(); <span class="comment">// 显示提示</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException | NoSuchAlgorithmException $r9) &#123;</span><br><span class="line">        <span class="comment">// 异常处理</span></span><br><span class="line">        <span class="type">RuntimeException</span> <span class="variable">$r10</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>($r9);</span><br><span class="line">        <span class="keyword">throw</span> $r10; <span class="comment">// 抛出运行时异常</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，调用<code>PatternLockUtils.enc</code>方法对用户输入进行加密处理，调用<code>Utils.cmp</code>方法比较加密后的图案和预设的图案，正确会将结果用<code>Submit dart&#123;&#125;</code>包裹起来显示，错误会显示<code>Try again</code></p><h3 id="hookutils.cmp方法">Hook<code>Utils.cmp</code>方法</h3><p>于是先尝试直接在<code>onComplete</code>里hook比较函数<code>Utils.cmp</code>，将返回值修改为正确，看一下加密结果的格式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookUtilsCmp</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable constant_">C06201</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.crackme.happylock.MainActivity$1&quot;</span>);</span><br><span class="line">    <span class="variable constant_">C06201</span>[<span class="string">&quot;onComplete&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">list</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">Utils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.crackme.happylock.Utils&quot;</span>);</span><br><span class="line">        <span class="title class_">Utils</span>.<span class="property">cmp</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">str</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Original input string: <span class="subst">$&#123;str&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="variable language_">this</span>[<span class="string">&quot;onComplete&quot;</span>](list);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">hookUtilsCmp</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure><p>不出所料，结果是一个40位十六进制的哈希值，可能是<code>SHA-1</code>做的哈希</p><p><img src="image-20250111124414814.png" /></p><p>同时，安卓端也显示了加密结果</p><p><img src="image-20250111124802874.png" /></p><p>但是上面的代码也可以看到，虽然绕过了<code>cmp</code>的检验，这里显示的哈希值还是我们随机输入的手势密码的结果，并不是目标密码的结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Toast</span> <span class="variable">$r82</span> <span class="operator">=</span> Toast.makeText($r52, $r6.append($r4).append(StringObf.decode(<span class="string">&quot;fQ==&quot;</span>)).toString(), <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>那么就要去看<code>Utils.cmp</code>方法的具体实现了</p><p><img src="image-20250111132922994.png" /></p><p>主要实现的是反射调用<code>clz.cmp</code>方法</p><h3 id="反射调用clz.cmp方法">反射调用<code>clz.cmp</code>方法</h3><p>于是hook查看一下反射调用的<code>clz</code>的具体信息</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookUtilsCmp</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">Utils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.crackme.happylock.Utils&quot;</span>);</span><br><span class="line">    <span class="title class_">Utils</span>[<span class="string">&quot;cmp&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Utils.cmp is called: str=<span class="subst">$&#123;str&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">var</span> clz = <span class="variable language_">this</span>.<span class="property">clz</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Reflection will invoke method in class: &quot;</span> + clz);</span><br><span class="line">        <span class="keyword">let</span> result = <span class="variable language_">this</span>[<span class="string">&quot;cmp&quot;</span>](str);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Utils.cmp result=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">hookUtilsCmp</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure><p>这个时候程序运行崩溃了，打印了<code>clz</code>的相关信息，可以看到<code>clz</code>实际上是一个<code>Java.Field</code>类型对象，它的<code>value</code>属性是一个名为<code>com.crackme.happylock.Check</code>的类，比较可疑</p><p><img src="image-20250111140600164.png" /></p><p>于是我们通过<code>clz.value</code>来访问</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookUtilsCmp</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">Utils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.crackme.happylock.Utils&quot;</span>);</span><br><span class="line">    <span class="title class_">Utils</span>[<span class="string">&quot;cmp&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Utils.cmp is called: str=<span class="subst">$&#123;str&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">var</span> clz = <span class="variable language_">this</span>.<span class="property">clz</span>.<span class="property">value</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Reflection will invoke method in class: &quot;</span> + clz);</span><br><span class="line">        <span class="keyword">let</span> result = <span class="variable language_">this</span>[<span class="string">&quot;cmp&quot;</span>](str);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Utils.cmp result=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">hookUtilsCmp</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure><p>遗憾的是虽然 <code>clz</code> 被成功获取为<code>class com.crackme.happylock.Check</code>，但是崩溃仍然发生，后续还换了各种方法，还是一直崩溃</p><p><img src="image-20250111142509017.png" /></p><p>同时注意到，其实 jadx中并没有<code>com.crackme.happylock.Check</code>类，可能是动态加载的</p><h3 id="动态加载check类">动态加载<code>Check</code>类</h3><p>先尝试一下用<code>java.use()</code>强制加载</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookUtilsCmp</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">Utils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.crackme.happylock.Utils&quot;</span>);</span><br><span class="line">    <span class="title class_">Utils</span>[<span class="string">&quot;cmp&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Utils.cmp is called: str=<span class="subst">$&#123;str&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">var</span> clz = <span class="variable language_">this</span>.<span class="property">clz</span>.<span class="property">value</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Reflection will invoke method in class: &quot;</span> + clz);</span><br><span class="line">        <span class="keyword">let</span> check = <span class="title class_">Java</span>.<span class="title function_">use</span>(clz.<span class="title function_">getName</span>());</span><br><span class="line">        <span class="keyword">let</span> result = <span class="variable language_">this</span>[<span class="string">&quot;cmp&quot;</span>](str);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Utils.cmp result=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">hookUtilsCmp</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure><p>果然不行，应该就是动态加载的</p><p><img src="image-20250111162631704.png" /></p><p>同时观察到<code>com.crackme.happylock.Utils</code>里有一个<code>loadclass</code>方法，猜测<code>Check</code>类是由它加载的，但是jadx 并没有把它反编译出来，没法看到它的具体实现</p><p><img src="image-20250111173046052.png" /></p><p>hook检查一下它是否调用了 <code>DexClassLoader</code>或其他类似的类加载器</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookDexClassLoader</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">DexClassLoader</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;dalvik.system.DexClassLoader&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hook DexClassLoader 的构造函数</span></span><br><span class="line">    <span class="title class_">DexClassLoader</span>.<span class="property">$init</span>.<span class="title function_">overload</span>(</span><br><span class="line">        <span class="string">&quot;java.lang.String&quot;</span>,</span><br><span class="line">        <span class="string">&quot;java.lang.String&quot;</span>,</span><br><span class="line">        <span class="string">&quot;java.lang.String&quot;</span>,</span><br><span class="line">        <span class="string">&quot;java.lang.ClassLoader&quot;</span></span><br><span class="line">    ).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">dexPath, optimizedDirectory, librarySearchPath, parent</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;DexClassLoader initialized:&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;  dexPath: &quot;</span> + dexPath);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;  optimizedDirectory: &quot;</span> + optimizedDirectory);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;  librarySearchPath: &quot;</span> + librarySearchPath);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;  parent: &quot;</span> + parent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.$init(dexPath, optimizedDirectory, librarySearchPath, parent);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hook loadClass 方法</span></span><br><span class="line">    <span class="title class_">DexClassLoader</span>.<span class="property">loadClass</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">className</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;DexClassLoader.loadClass called for class: &quot;</span> + className);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">loadClass</span>(className);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">hookDexClassLoader</span>(); <span class="comment">// Hook DexClassLoader</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure><p>可以看到，<code>Check</code>类的加载确实调用了<code>DexClassLoader.loadClass</code>方法，而且在下面还看到了<code>SHA-1</code>字样，验证了之前的猜测，手势密码加密编码之后是用<code>SHA-1</code>做哈希的</p><p><img src="image-20250111181557996.png" /></p><p>我赛中的进度就至此了，后面一直在捣鼓反射的事情，再到后面还尝试了全局扫描<code>SHA-1</code>哈希算法的调用情况，试图扫到目标手势密码编码后做哈希的过程，都失败了...</p><p>而且，其实gpt当时给了我正确解法，但我一直忽略了，在纠结反射、自己的<code>loadclass</code>方法什么的...</p><h2 id="赛后复现">赛后复现</h2><h3 id="dumpclasses.dex">dump<code>classes.dex</code></h3><p>正确解法就是去 dump运行时的<code>dex</code>文件<code>classes.dex</code>，这里用到了一个新工具<code>GDA</code>，具体的介绍见<ahref="https://zhuanlan.zhihu.com/p/28354064">作者知乎</a></p><blockquote><p>需要注意的是先将<code>Gdump</code>push到安卓端，同时将<code>GDA</code>的<code>adb</code>环境变量放在模拟器<code>adb</code>环境变量之上</p></blockquote><p>打开 GDA，点击导航栏安卓图标的 dump功能打开<code>GDA Device Dumper</code>，在左侧选择<code>com.crackme.happylock</code>进程，右侧筛选<code>DEX</code>文件，可以看到<code>/data/data/com.crackme.happylock/files/classes.dex</code>，右键<code>Dump Module</code>即可</p><blockquote><p>一开始我也一直 dump不出来，只能说多试几次，重启一下之类的就可以了，或者就是 GDA 的Gdump、adb 没有配好，就是我上面说的</p></blockquote><p><img src="image-20250112115020163.png" /></p><p>也可以全局查找，显示了 PID、地址范围等信息</p><p><img src="image-20250112115336327.png" /></p><p>也可以在下方输入要 dump 的文件的 PID、start_addr 和 size</p><p><img src="image-20250112115435981.png" /></p><p>dump 出来的文件在<code>GDA.exe</code>的同级目录下，拖到 jadx里分析，但是报错了</p><p>日志显示错误为<code>Bad checksum</code>，看大佬的解释是 hook之后填充字节改变了<code>sum</code>值</p><p><img src="image-20250112124255770.png" /></p><p>修改 dump 出来的<code>classes.dex</code>的<code>sum</code>值即可</p><p><img src="image-20250112125902731.png" /></p><p>但是 jadx 还是反编译失败了</p><p><img src="image-20250112144514538.png" /></p><p>同样，也可以选择拖到 GDA 里面分析，但仍然反编译不出来什么东西</p><p><img src="image-20250112145233210.png" /></p><p>在学习大佬写的文章复现的时候，还看到了一个<code>frida-dump</code>的<ahref="\https://github.com/lasting-yang/frida_dump">脚本库</a>，在这里跑出来的结果也是一样的</p><p>根据参考的两篇文章，这里是字节码有问题，代码被抽取，这道题实际上就是用ShadowHook 实现类抽取</p><h3 id="修复classes.dex">修复<code>classes.dex</code></h3><p>Java 层卡住了，就要去 Native 层看一下了</p><p><img src="image-20250112164750262.png" /></p><p>ida 分析 libhappylock.so 文件（不得不说 ida9.0 确实好用，8.3 没有arm、mips 什么的反编译器，还得去用 7.7 反编译，现在 9.0都有了，定位到<code>JNI_OnLoad</code>函数</p><p><img src="image-20250114110829013.png" /></p><p>一般来说，<code>JNI_OnLoad</code>函数里会有本地方法注册<code>RegisterNatives</code>，但这里并没有</p><p>到这里，对于<code>JNI_OnLoad</code>函数的分析，我参考的两篇大佬的文章用了不一样的方法，我这里就复现了一种</p><h4 id="使用bindiff恢复符号">使用<code>Bindiff</code>恢复符号</h4><blockquote><p>至于怎么看出来是 ShadowHook 的，我就不知道了...</p></blockquote><p>ShadowHook 是字节跳动的一个<ahref="https://github.com/bytedance/android-inline-hook">开源 inline hook框架</a></p><p>于是下载抖音 apk，提取<code>libshadowhook.so</code>文件，用 ida打开，保存得到 i64 文件，ida打开<code>libhappylock.so</code>文件，ctrl+6调用<code>bindiff</code>，选择 DiffDatabase，选择<code>libshadowhook.so</code>的 i64 文件</p><blockquote><p>需要注意<code>Bindiff</code>不支持中文路径，所选择的 i64文件路径不要有中文，也不要有除下划线外的特殊符号</p></blockquote><p><img src="image-20250114154737249.png" /></p><p>在 Matched Functions 窗口中选中所有匹配的函数符号</p><p><img src="image-20250114154710365.png" /></p><p>右键点击 Import symbols/comments 即可恢复匹配的符号</p><p><img src="image-20250114155102195.png" /></p><p>可以看到，确实有大量 ShadowHook相关函数，而且<code>JNI_OnLoad</code>函数中就有调用</p><p><img src="image-20250114160155875.png" /></p><h4 id="shadowhook-分析">ShadowHook 分析</h4><p>其中，由于有符号信息，<code>shadowhook_hook_func_addr</code>函数就是调用<code>shadowhook_hook_sym_name</code>函数</p><p><img src="image-20250114160541263.png" /></p><p>参考<ahref="https://github.com/bytedance/android-inline-hook/blob/main/doc/manual.zh-CN.md">ShadowHook手册</a>，ShadowHook 支持通过“函数地址”或“库名 + 函数名”指定 hook位置</p><p>参考手册，<code>shadowhook_hook_sym_name</code>函数声明如下</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;shadowhook.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">shadowhook_hook_sym_name</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *lib_name, <span class="type">const</span> <span class="type">char</span> *sym_name, <span class="type">void</span> *new_addr, <span class="type">void</span> **orig_addr)</span></span>;s</span><br></pre></td></tr></table></figure><p>参数</p><ul><li><code>lib_name</code>（必须指定）：需要被 hook 的函数所在的库名</li><li><code>sym_addr</code>（必须指定）：需要被 hook 的函数的符号名</li><li><code>new_addr</code>（必须指定）：新函数（proxy函数）的绝对地址</li><li><code>orig_addr</code>（不需要的话可传<code>NULL</code>）：返回原函数地址</li></ul><p>这种方式可以 hook “当前已加载到进程中的动态库”，也可以 hook“还没有加载到进程中的动态库”，即如果 hook 时动态库还未加载，ShadowHook内部会记录当前的 hook“诉求”，后续一旦目标动态库被加载到内存中，将立刻执行 hook 操作</p><p>参考以上，观察这里的<code>shadowhook_hook_sym_name</code>函数的参数，前两个参数如下，但是需要注意的是这里显示的数据不是正确的，交叉引用可以看到对这些值有动态修改</p><p><img src="image-20250114192731996.png" /></p><p><code>sub_12414</code>函数如下，可以看到其中对<code>0x430C0-0x430C6</code>有一个异或4的操作，对<code>0x430B8</code>有一个异或<code>0xE1E1E1E1E1E1E1E1</code>的操作</p><p><img src="image-20250114192827317.png" /></p><p>而查看<code>sub_12414</code>的交叉引用就能发现它在<code>.init_array</code>段，也就意味着这些异或操作程序一运行就会进行</p><p><img src="image-20250114194047000.png" /></p><p>本来想动调的，但是有点问题，那就手动异或回去吧，可以看到<code>lib_name</code>是<code>libc.so</code>，<code>sym_name</code>是<code>execve</code>，<code>execve</code>是一个系统调用，用来启动一个新程序</p><p><img src="image-20250114201453009.png" /></p><p><img src="image-20250114201555986.png" /></p><p>看到不是目标函数我就没继续下去了，看大佬的文章，后面代理函数<code>sub_121E4</code>中判断系统调用是否为<code>dex2oat</code>，如果是则不执行,如果不是则执行</p><p>下面<code>shadowhook_hook_sym_name_callback</code>里也调用了<code>shadowhook_hook_sym_name</code></p><p><img src="image-20250114201827585.png" /></p><p>同样地，之前的<code>sub_12414</code>函数中也看到了，对<code>0x430C8</code>有一个异或<code>0x7D7D7D7D7D7D7D7D</code>的操作，异或之后得到<code>lib_name</code>为<code>libart.so</code></p><p><img src="image-20250114204451933.png" /></p><p>我这里 ida识别的有点问题，需要手动把下面<code>0x430D0</code>的<code>0x12</code>带上</p><p><img src="image-20250114204549459.png" /></p><p>这里符号恢复得也有点问题，别人的恢复除了这里的<code>sym_name</code>，也就是<code>sub_1216C</code>，是<code>__android_log_print</code>函数，而代理函数正是我们苦苦寻求的目标函数</p><p><img src="image-20250114205834218.png" /></p><p>这个函数实现的功能是检测<code>dex</code>文件大小，如果匹配到目标<code>dex</code>则执行回填操作，从偏移为<code>0x178(376)</code>开始的<code>0x98</code>大小的字节，回填的内容就是<code>0x42D90</code>处内容</p><p><img src="image-20250114210022136.png" /></p><p>而检测<code>dex</code>文件大小为<code>0x3AC</code>,实际上就是之前dump 出来的<code>dex</code>文件的有效部分，后面都是0</p><p><img src="image-20250114210259268.png" /></p><p>同时，偏移为<code>0x217(535)</code>的地方也要赋值为<code>0x430A0</code>处的值，同样也要进行异或</p><p><img src="image-20250114211420838.png" /></p><p>把这些内容按照上面的说的偏移位置填入，即修复成功</p><p><img src="image-20250113170400495.png" /></p><p>终于反编译成功！！！</p><p><img src="image-20250114211511417.png" /></p><p>很简单的异或逻辑，<code>exp</code>如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">enc = [<span class="number">118</span>, <span class="number">17</span>, <span class="number">2</span>, <span class="number">80</span>, <span class="number">9</span>, <span class="number">125</span>, <span class="number">6</span>, <span class="number">22</span>, <span class="number">113</span>, <span class="number">66</span>, <span class="number">0</span>, <span class="number">81</span>, <span class="number">94</span>, <span class="number">41</span>, <span class="number">87</span>, <span class="number">20</span>, <span class="number">122</span>, <span class="number">65</span>, <span class="number">88</span>, <span class="number">5</span>, <span class="number">94</span>, <span class="number">41</span>, <span class="number">7</span>, <span class="number">19</span>, <span class="number">118</span>, <span class="number">22</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">90</span>, <span class="number">41</span>, <span class="number">87</span>, <span class="number">71</span>, <span class="number">117</span>, <span class="number">68</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">95</span>, <span class="number">116</span>, <span class="number">4</span>, <span class="number">67</span>]</span><br><span class="line">key = <span class="string">b&#x27;CrackMe!CrackMe!&#x27;</span></span><br><span class="line">flag = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    flag.append(enc[i]^key[i%<span class="built_in">len</span>(key)])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>(flag).decode())</span><br></pre></td></tr></table></figure><h2 id="参考">参考</h2><p><ahref="https://bbs.kanxue.com/thread-285135.htm">[2025软件系统安全赛]HappyLock（对抗使用SHadowHook实现的类抽取）</a></p><p><ahref="http://www.yxfzedu.com/article/12160">Android安全-全国高校大学生软件创新大赛-软件系统安全赛HappyLock复现</a></p>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> android </tag>
            
            <tag> hook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WP-[2025.1软件系统安全赛]donntyousee</title>
      <link href="/2025/01/10/2025%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E8%B5%9B-donntyousee/"/>
      <url>/2025/01/10/2025%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E8%B5%9B-donntyousee/</url>
      
        <content type="html"><![CDATA[<h1 id="donntyousee">donntyousee</h1><h2 id="初看">初看</h2><p>比赛的时候没有细看，就简单调了一会，没找到输入的地方，觉得有点奇怪，就去看另一道happylock 了（虽然也没写出来</p><h2 id="初步处理">初步处理</h2><p>在<code>start</code>函数中的<code>sub_405559</code>里可以看到有异常</p><p><img src="image-20250108191600363.png" /></p><p><img src="image-20250108194703557.png" /></p><p>汇编视图往上看有个莫名其妙的<code>retn</code></p><p><img src="image-20250108194754301.png" /></p><p>nop 掉即可反汇编</p><p><img src="image-20250108194819599.png" /></p><p>输入函数即<code>sub_4D9660</code>，<code>unk_56602C</code>即为<code>%s</code></p><p><img src="image-20250108222936992.png" /></p><p>同时在<code>unk_56602C</code>下方看到<code>rc4</code>字样，猜测可能是<code>RC4</code>加密</p><p><img src="image-20250108223044499.png" /></p><p>但是我们并没有在<code>sub_4D9660</code>的伪代码中看到调用<code>RC4</code>加密以及<code>flag</code>验证的相关函数，于是回到汇编视图，发现有<code>call r8</code>语句，动调看一下<code>call r8</code>是调用了哪个函数</p><p><img src="image-20250110130021262.png" /></p><p>可以看到第一条<code>call r8</code>调用的是<code>sub_405848</code>函数</p><p><img src="image-20250110130357037.png" /></p><p>第二条<code>call r8</code>调用的是<code>sub_405EAA</code>函数</p><p><img src="image-20250110130456097.png" /></p><p>同样，这两个函数里也有<code>retn</code>花指令，去除即可反汇编</p><p><img src="image-20250110125326424.png" /></p><p><img src="image-20250110130841965.png" /></p><p><code>sub_405848</code>函数是<code>RC4</code>的密钥初始化（KSA）阶段</p><p><img src="image-20250110130705586.png" /></p><p><code>sub_405EAA</code>函数是加密（PRGA）阶段，注意有个魔改，最后异或了<code>0x23</code></p><p><img src="image-20250110130854613.png" /></p><p>伪代码中可以看到都是临时变量，于是密钥和密文需要动调 dump 出来</p><p><code>sub_405848</code>函数中，参数<code>a3</code>就是密钥数组，<code>a4</code>为密钥长度</p><p><img src="image-20250110135357841.png" /></p><p><img src="image-20250110135530715.png" /></p><p><code>sub_405EAA</code>函数中参数<code>a3</code>是输入的<code>flag</code>，<code>a2</code>是KSA 生成的密钥流，<code>a4</code>是密文长度</p><p>同时注意到，输入的<code>flag</code>存放的位置是<code>bss</code>段，未初始化的全局变量，起始地址为<code>0x5C6CC0</code></p><p><img src="image-20250110135901377.png" /></p><p><img src="image-20250110135911927.png" /></p><p><img src="image-20250110135853018.png" /></p><h2 id="寻找密文">寻找密文</h2><p>得到了密钥，但是没有密文，在<code>sub_4D9660</code>汇编里也没找到</p><p>但是可以想到，一般来说是将输入的<code>flag</code>进行加密与预设的密文进行比较，上面也提到，存放输入的<code>flag</code>的地方是<code>bss</code>段，于是去<code>0x5C6CC0</code>处查看交叉引用，发现果然有另外一个函数调用</p><p><img src="image-20250110173035880.png" /></p><p>同样，这个函数里也有花指令</p><p><img src="image-20250110173108323.png" /></p><p>但其实去了之后也没用，这个函数很短，而且注意到里面也有<code>call 寄存器</code>的操作，同样动调看一下</p><p><img src="image-20250110173549668.png" /></p><p>可以看到是调用了<code>sub_405CAA</code>函数</p><p><img src="image-20250110173616903.png" /></p><p>同样有花指令</p><p><img src="image-20250110173723309.png" /></p><p>反汇编</p><p><img src="image-20250110173803532.png" /></p><p>最好在动调的时候看，可以看到参数<code>a2</code>是<code>0x5C6CC0</code>，就是存放输入的地方</p><p><img src="image-20250110174858284.png" /></p><p>下面的比较逻辑说明密文就是<code>v8</code>数组</p><p>（至于密文大小为什么不是上面动调得到的<code>0x32</code>我还没搞懂</p><p><img src="image-20250110175018579.png" /></p><h2 id="反调试">反调试</h2><p>但是解了一下发现还是不对，怀疑是反调试搞的鬼</p><p>回去看存储密钥的地方，是<code>data</code>段<code>0x5C5110</code>处，可以看到<code>sub_4053A5</code>函数调用了此数组</p><p><img src="image-20250110210827528.png" /></p><p>同样有花指令</p><p><img src="image-20250110210924503.png" /></p><p>反汇编可以看到，这里有一个反调试操作，将<code>0x5C5110</code>异或了<code>0x45</code></p><p><img src="image-20250110213703546.png" /></p><p>所以动调出来的密钥要异或<code>0x45</code>，或者因为密钥在<code>data</code>段，也可以直接静态情况下去<code>0x5C5110</code>处取密钥</p><p><img src="image-20250110215551053.png" /></p><p>发现有反调试，除了感觉不对，还可以通过<code>strace</code>来检测，可以看到，有一个<code>ptrace</code>，且<code>ptrace(PTRACE_TRACEME) = -1 EPERM (Operation not permitted)</code></p><p><code>ptrace</code> 是用于调试的系统调用，这里的返回值<code>-1 EPERM</code>表示没有权限进行追踪操作，通常是因为程序没有足够的权限或被禁止进行调试，也可以由此发现存在反调试</p><p><img src="image-20250115220837644.png" /></p><h2 id="init_array段"><code>.init_array</code>段</h2><p>同时，查看<code>sub_4053A5</code>的交叉引用发现，这个函数在<code>.init_array</code>段中，也就意味着这个函数会在程序一运行就执行，因此一检测到调试器就会改变密钥的值</p><p><img src="image-20250115200328813.png" /></p><p>看到这里，让我想起了一开始做这道题，查找字符串的时候并没有<code>plz input your flag</code>，猜想也是在<code>.init_array</code>段中初始化了，可以去看一下</p><p>ida 中 View-Open Subviews-Segments打开段视图，定位到<code>.init_array</code>段</p><p><img src="image-20250115201656571.png" /></p><p>还挺多的</p><p><img src="image-20250115203643554.png" /></p><p>额额，翻了半天，其实初始化就是在<code>sub_4053A5</code>函数里</p><p><img src="image-20250115203742561.png" /></p><p>按照这个步骤来就可以得到</p><p><img src="image-20250115203834628-1736944815688-5.png" /></p><h2 id="exp">EXP</h2><p>exp 如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">RC4_decrypt</span>(<span class="params">ciphertext</span>):</span><br><span class="line">    key = [<span class="number">146</span>, <span class="number">28</span>, <span class="number">43</span>, <span class="number">31</span>, <span class="number">186</span>, <span class="number">251</span>, <span class="number">162</span>, <span class="number">255</span>, <span class="number">7</span>, <span class="number">105</span>, <span class="number">125</span>, <span class="number">119</span>, <span class="number">24</span>, <span class="number">140</span>]</span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    out = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># KSA (Key Scheduling Algorithm)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># PRGA (Pseudo Random Generation Algorithm)</span></span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> ciphertext:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span>   </span><br><span class="line">        j = (j + S[i]) % <span class="number">256</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        out.append(<span class="number">0x23</span> ^ char ^ S[(S[i] + S[j]) % <span class="number">256</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line">ciphertext = [<span class="number">37</span>, <span class="number">205</span>, <span class="number">84</span>, <span class="number">175</span>, <span class="number">81</span>, <span class="number">28</span>, <span class="number">88</span>, <span class="number">211</span>, <span class="number">168</span>, <span class="number">75</span>, <span class="number">79</span>, <span class="number">86</span>, <span class="number">236</span>, <span class="number">131</span>, <span class="number">93</span>, <span class="number">212</span>, <span class="number">246</span>, <span class="number">71</span>, <span class="number">74</span>, <span class="number">111</span>, <span class="number">224</span>, <span class="number">115</span>, <span class="number">176</span>, <span class="number">165</span>, <span class="number">168</span>, <span class="number">195</span>, <span class="number">23</span>, <span class="number">129</span>, <span class="number">94</span>, <span class="number">43</span>, <span class="number">244</span>, <span class="number">246</span>, <span class="number">113</span>, <span class="number">234</span>, <span class="number">47</span>, <span class="number">255</span>, <span class="number">168</span>, <span class="number">99</span>, <span class="number">153</span>, <span class="number">87</span>]</span><br><span class="line">plaintext = RC4_decrypt(ciphertext)</span><br><span class="line"><span class="built_in">print</span>(plaintext.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> 动调 </tag>
            
            <tag> 反调试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WP-[2024.12CISCN初赛]fffffhash</title>
      <link href="/2024/12/22/2025CISCN%E5%88%9D%E8%B5%9B-fffffhash/"/>
      <url>/2024/12/22/2025CISCN%E5%88%9D%E8%B5%9B-fffffhash/</url>
      
        <content type="html"><![CDATA[<h1 id="fffffhash">fffffhash</h1><h2 id="wp初稿">12.16wp初稿</h2><h3 id="题目代码">题目代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">giaogiao</span>(<span class="params">hex_string</span>):</span><br><span class="line">base_num = <span class="number">0x6c62272e07bb014262b821756295c58d</span></span><br><span class="line">x = <span class="number">0x0000000001000000000000000000013b</span></span><br><span class="line">MOD = <span class="number">2</span>**<span class="number">128</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> hex_string:</span><br><span class="line">base_num = (base_num * x) &amp; (MOD - <span class="number">1</span>) </span><br><span class="line">base_num ^= i</span><br><span class="line"><span class="keyword">return</span> base_num</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">giao=<span class="number">201431453607244229943761366749810895688</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;1geiwoligiaogiao&quot;</span>)</span><br><span class="line">hex_string = <span class="built_in">int</span>(<span class="built_in">input</span>(),<span class="number">16</span>)</span><br><span class="line">s = long_to_bytes(hex_string)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> giaogiao(s) == giao:</span><br><span class="line"><span class="built_in">print</span>(os.getenv(<span class="string">&#x27;FLAG&#x27;</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="思路">思路</h3><p>这题是一个自写的fnv哈希，存在问题，其实和<ahref="https://github.com/DownUnderCTF/Challenges_2023_Public/tree/main/crypto/fnv">DUCTF2023fnv</a>是一样的</p><p>因为与的数 <span class="math inline">\(MOD-1\)</span> 是 <spanclass="math inline">\(2^{128}-1\)</span>，是一个二进制全1的数，所以就相当于<span class="math inline">\(\bmod MOD\)</span>，而异或的数 <spanclass="math inline">\(i\)</span> 处于 <spanclass="math inline">\(0-255\)</span>之间，相比之下是一个相当小的数，于是考虑造格规约</p><p>把哈希的过程翻译一下大致就是 <span class="math display">\[\begin{gathered}n_{1}\equiv xn_0+b_0\bmod MOD\\n_{2}\equiv xn_1+b_1\bmod MOD\\n_3\equiv xn_2+b_2\bmod MOD\\\vdots \\n_{16}\equiv xn_{15}+b_{15}\bmod MOD\end{gathered}\]</span> 其中，<span class="math inline">\(n_i\)</span>代表每次的<code>base_num</code>，<spanclass="math inline">\(+b_i\)</span> 相当于每次的异或数 <spanclass="math inline">\(i\)</span> ，至于为什么是16个等式，猜的吧，因为<span class="math inline">\(128/8=16\)</span></p><p>于是可以得到 <span class="math display">\[\begin{aligned}giao=n_{16}&amp;\equiv xn_{15}+b_{15}\bmod MOD\\&amp;\equiv x(xn_{14}+b_{14})+b_{15}\bmod MOD\\&amp;\equiv x^2n_{14}+b_{14}x+b_{15}\bmod MOD\\&amp;\equiv \dots\\&amp;\equiv n_0x^{16}+b_0x^{15}+b_1x^{14}+\dots+b_{15}x^0\bmod MOD\end{aligned}\]</span> 于是可以构造格 <span class="math display">\[\begin{pmatrix}b_{15} &amp; b_{14} &amp; \dots &amp; b_0 &amp; 1 &amp; 1 &amp; k\end{pmatrix}\begin{pmatrix}1&amp;&amp;&amp;&amp;&amp;&amp;x^0\\&amp;1&amp;&amp;&amp;&amp;&amp;x^1\\&amp;&amp;\ddots&amp;&amp;&amp;&amp;\vdots\\&amp;&amp;&amp;1&amp;&amp;&amp;x^{15}\\&amp;&amp;&amp;&amp;1&amp;&amp;n_0x^{16}\\&amp;&amp;&amp;&amp;&amp;1&amp;-giao\\&amp;&amp;&amp;&amp;&amp;&amp;MOD\end{pmatrix}=\begin{pmatrix}b_{15} &amp; b_{14} &amp; \dots &amp; b_0 &amp; 1 &amp; 1 &amp; 0\end{pmatrix}\]</span> 脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">base_num = <span class="number">0x6c62272e07bb014262b821756295c58d</span></span><br><span class="line">x = <span class="number">0x0000000001000000000000000000013b</span></span><br><span class="line">MOD = <span class="number">2</span>**<span class="number">128</span></span><br><span class="line">giao=<span class="number">201431453607244229943761366749810895688</span></span><br><span class="line">h0=base_num</span><br><span class="line">n=<span class="number">16</span></span><br><span class="line"></span><br><span class="line">M = Matrix(ZZ,n+<span class="number">3</span>,n+<span class="number">3</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    M[i,i]=<span class="number">1</span></span><br><span class="line">    M[i,-<span class="number">1</span>]=x^i</span><br><span class="line">M[-<span class="number">3</span>,-<span class="number">1</span>]=h0*(x^n)</span><br><span class="line">M[-<span class="number">3</span>,-<span class="number">3</span>]=<span class="number">1</span></span><br><span class="line">M[-<span class="number">2</span>,-<span class="number">1</span>]=-giao</span><br><span class="line">M[-<span class="number">2</span>,-<span class="number">2</span>]=<span class="number">1</span></span><br><span class="line">M[-<span class="number">1</span>,-<span class="number">1</span>]=MOD</span><br><span class="line">LM=M.LLL()</span><br><span class="line">res=LM[<span class="number">1</span>]</span><br><span class="line">res=res[:-<span class="number">3</span>][::-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment"># (-2, -1, 1, -8, 5, 4, 9, 0, -1, -3, 6, -2, 6, -5, -5, 1)</span></span><br></pre></td></tr></table></figure><p>需要注意的是，这里规出来之后得用第2行的结果，因为第一行基本全是0，显然不是预期的<span class="math inline">\(b_i\)</span>，而且第二行的末尾才是正确的<span class="math inline">\(1\quad1 \quad0\)</span></p><p><img src="image-20241220215339956.png" /></p><p>现在得到了 <spanclass="math inline">\(b_i\)</span>，接下来需要寻找异或的时候用的 <spanclass="math inline">\(i\)</span>，二者对于<code>base_num</code>的影响是等效的，由此可以逐字节在<span class="math inline">\(0-255\)</span> 之间爆破</p><p>由之前的推导 <span class="math display">\[\begin{gathered}n_{1}\equiv xn_0+b_0\bmod MOD\\n_{2}\equiv xn_1+b_1\bmod MOD\\n_3\equiv xn_2+b_2\bmod MOD\\\vdots \\n_{16}\equiv xn_{15}+b_{15}\bmod MOD\end{gathered}\]</span> 可以知道每次 <span class="math inline">\(+b_i\)</span> 是在<span class="math inline">\(xn_i\)</span>的基础上，所以需要在每次循环时做爆破，得到正确的结果 <spanclass="math inline">\(b_i\)</span> 后，才能继续爆破下一个 <spanclass="math inline">\(b_{i+1}\)</span></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">flag=[]</span><br><span class="line">target=base_num</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    target*=x</span><br><span class="line">    target%=MOD</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xff</span>):</span><br><span class="line">        <span class="keyword">if</span> (target^^j==target+res[i]):</span><br><span class="line">            flag.append(j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    target^^=j</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>(flag).<span class="built_in">hex</span>())</span><br><span class="line"><span class="comment"># 020101081b04390001051a020a3d0f0f</span></span><br></pre></td></tr></table></figure><h2 id="做原题">12.20做原题</h2><p>原题链接<ahref="https://github.com/DownUnderCTF/Challenges_2023_Public/tree/main/crypto/fnv">DUCTF2023fnv</a></p><h3 id="题目代码-1">题目代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fnv1</span>(<span class="params">s</span>):</span><br><span class="line">h = <span class="number">0xcbf29ce484222325</span></span><br><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> s:</span><br><span class="line">h *= <span class="number">0x00000100000001b3</span></span><br><span class="line">h &amp;= <span class="number">0xffffffffffffffff</span></span><br><span class="line">h ^= b</span><br><span class="line"><span class="keyword">return</span> h</span><br><span class="line"></span><br><span class="line">TARGET = <span class="number">0x1337133713371337</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to FNV!&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Please enter a string in hex that hashes to 0x<span class="subst">&#123;TARGET:016x&#125;</span>:&quot;</span>)</span><br><span class="line">s = <span class="built_in">bytearray</span>.fromhex(<span class="built_in">input</span>())</span><br><span class="line"><span class="keyword">if</span> fnv1(s) == TARGET:</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(fnv1(s)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Well done!&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(os.getenv(<span class="string">&#x27;FLAG&#x27;</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(fnv1(s)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Try again... :(&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="最初思路">最初思路</h3><p>用一样的思路构造格如下 <span class="math display">\[\begin{pmatrix}b_{9} &amp; b_{8} &amp; \dots &amp; b_0 &amp; 1 &amp; 1 &amp; k\end{pmatrix}\begin{pmatrix}1&amp;&amp;&amp;&amp;&amp;&amp;x^0\\&amp;1&amp;&amp;&amp;&amp;&amp;x^1\\&amp;&amp;\ddots&amp;&amp;&amp;&amp;\vdots\\&amp;&amp;&amp;1&amp;&amp;&amp;x^{9}\\&amp;&amp;&amp;&amp;1&amp;&amp;h_0x^{10}\\&amp;&amp;&amp;&amp;&amp;1&amp;-TARGET\\&amp;&amp;&amp;&amp;&amp;&amp;MOD\end{pmatrix}=\begin{pmatrix}b_{9} &amp; b_{8} &amp; \dots &amp; b_0 &amp; 1 &amp; 1 &amp; 0\end{pmatrix}\]</span> 但可惜的是这题这样构造的话规不出来</p><p>这个时候回头去看国赛那道题，其实有点问题，当时做的时候直接就规出来了，就没细算，现在马后炮算一下范数，发现确实有点问题</p><p>格基的模长如果每个 <span class="math inline">\(b_i\)</span>都按最长的算，为 <spanclass="math inline">\(\sqrt{16*2^{8*2}+2}\)</span>，大概是10位，而<spanclass="math inline">\(\sqrt{n}det(L)^{\frac{1}{n}}\)</span> 为 <spanclass="math inline">\(\sqrt{19}\times2^{128/19}\)</span>，大概是9位，其实是不够大的</p><p>那为什么能规出来呢？</p><p>原因就是 <span class="math inline">\(b_i\)</span>的位数其实没有那么大，从规出来的结果来看，<spanclass="math inline">\(b_i\)</span>全是个位数，所以其实格基的模长很小，满足能格出来的条件</p><p>所以解决这道题的关键，是不是在于配平？</p><h3 id="仿照官方exp">仿照官方exp</h3><p>于是我去找了当时这道题的wp，由于是国外的比赛，网上能找到的wp很少，用格来做的就找到官方exp一份，代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">TARGET = <span class="number">0x1337133713371337</span></span><br><span class="line">h0 = <span class="number">0xcbf29ce484222325</span></span><br><span class="line">p = <span class="number">0x00000100000001b3</span></span><br><span class="line">MOD = <span class="number">2</span>^<span class="number">64</span></span><br><span class="line"></span><br><span class="line">n = <span class="number">10</span></span><br><span class="line">M = Matrix.column([p^(n - i - <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)] + [-(TARGET - h0*p^n), MOD])</span><br><span class="line">M = M.augment(identity_matrix(n+<span class="number">1</span>).stack(vector([<span class="number">0</span>] * (n+<span class="number">1</span>))))</span><br><span class="line">Q = Matrix.diagonal([<span class="number">2</span>^<span class="number">128</span>] + [<span class="number">2</span>^<span class="number">4</span>] * n + [<span class="number">2</span>^<span class="number">8</span>])</span><br><span class="line">M *= Q</span><br><span class="line">M = M.BKZ()</span><br><span class="line">M /= Q</span><br><span class="line"><span class="keyword">for</span> r <span class="keyword">in</span> M:</span><br><span class="line">    <span class="keyword">if</span> r[<span class="number">0</span>] == <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">abs</span>(r[-<span class="number">1</span>]) == <span class="number">1</span>:</span><br><span class="line">        r *= r[-<span class="number">1</span>]</span><br><span class="line">        good = r[<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line">        <span class="built_in">print</span>(good)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">inp = []</span><br><span class="line">y = <span class="built_in">int</span>(h0*p)</span><br><span class="line">t = (h0*p^n + good[<span class="number">0</span>] * p^(n-<span class="number">1</span>)) % MOD</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        y_ = (<span class="built_in">int</span>(y) ^^ <span class="built_in">int</span>(x)) * p^(n-i-<span class="number">1</span>) % MOD</span><br><span class="line">        <span class="keyword">if</span> y_ == t:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;good&#x27;</span>, i, x)</span><br><span class="line">            inp.append(x)</span><br><span class="line">            <span class="keyword">if</span> i &lt; n-<span class="number">1</span>:</span><br><span class="line">                t = (t + good[i+<span class="number">1</span>] * p^(n-i-<span class="number">2</span>)) % MOD</span><br><span class="line">                y = ((<span class="built_in">int</span>(y) ^^ <span class="built_in">int</span>(x)) * p) % MOD</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;bad&#x27;</span>, i)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>(inp).<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure><p>这份wp的格构造如下 <span class="math display">\[\begin{pmatrix}b_0&amp;b_1&amp;\dots&amp;b_9&amp;1&amp;k\end{pmatrix}\begin{pmatrix}x^9&amp;1&amp;&amp;&amp;&amp;&amp;&amp;\\x^8&amp;&amp;1&amp;&amp;&amp;&amp;&amp;\\\vdots&amp;&amp;&amp;\ddots&amp;&amp;&amp;&amp;\\x^1&amp;&amp;&amp;&amp;1&amp;&amp;&amp;\\x^0&amp;&amp;&amp;&amp;&amp;1&amp;&amp;\\-TARGET+h_0x^{10}&amp;&amp;&amp;&amp;&amp;&amp;1&amp;\\MOD&amp;&amp;&amp;&amp;&amp;&amp;&amp;0\end{pmatrix}=\begin{pmatrix}0&amp;b_0&amp;b_1&amp;\dots&amp;b_9&amp;1&amp;0\end{pmatrix}\]</span></p><p>然后乘了一个对角矩阵做配平</p><p><span class="math display">\[\begin{pmatrix}2^{128}&amp;&amp;&amp;&amp;&amp;&amp;\\&amp;2^4&amp;&amp;&amp;&amp;\\&amp;&amp;2^4&amp;&amp;&amp;\\&amp;&amp;&amp;\ddots&amp;&amp;\\&amp;&amp;&amp;&amp;2^4&amp;\\&amp;&amp;&amp;&amp;&amp;2^8\end{pmatrix}\]</span></p><p>也就是 <span class="math display">\[\begin{pmatrix}b_0&amp;b_1&amp;\dots&amp;b_9&amp;1&amp;k\end{pmatrix}\begin{pmatrix}2^{128}*x^9&amp;2^4&amp;&amp;&amp;&amp;&amp;&amp;\\2^{128}*x^8&amp;&amp;2^4&amp;&amp;&amp;&amp;&amp;\\\vdots&amp;&amp;&amp;\ddots&amp;&amp;&amp;&amp;\\2^{128}*x^1&amp;&amp;&amp;&amp;2^4&amp;&amp;&amp;\\2^{128}*x^0&amp;&amp;&amp;&amp;&amp;2^4&amp;&amp;\\2^{128}*(-TARGET+h_0x^{10})&amp;&amp;&amp;&amp;&amp;&amp;2^8&amp;\\2^{128}*MOD&amp;&amp;&amp;&amp;&amp;&amp;&amp;0\end{pmatrix}=\begin{pmatrix}0&amp;2^4*b_0&amp;2^4*b_1&amp;\dots&amp;2^4*b_9&amp;2^8&amp;0\end{pmatrix}\]</span> 我直接按照这个格的配平方法，给我之前构造的格做配平如下 <spanclass="math display">\[\begin{pmatrix}b_{9} &amp; b_{8} &amp; \dots &amp; b_0 &amp; 1 &amp; 1 &amp; k\end{pmatrix}\begin{pmatrix}2^4&amp;&amp;&amp;&amp;&amp;&amp;2^{128}*x^0\\&amp;2^4&amp;&amp;&amp;&amp;&amp;2^{128}*x^1\\&amp;&amp;\ddots&amp;&amp;&amp;&amp;\vdots\\&amp;&amp;&amp;2^4&amp;&amp;&amp;2^{128}*x^{9}\\&amp;&amp;&amp;&amp;2^8&amp;&amp;2^{128}*h_0x^{10}\\&amp;&amp;&amp;&amp;&amp;2^8&amp;2^{128}*(-TARGET)\\&amp;&amp;&amp;&amp;&amp;&amp;2^{128}*MOD\end{pmatrix}=\begin{pmatrix}2^4*b_{9} &amp; 2^4*b_{8} &amp; \dots &amp; 2^4*b_0 &amp; 2^8 &amp; 2^8&amp; 0\end{pmatrix}\]</span> 遗憾的是，还是规不出来...</p><h2 id="领悟配平">12.21领悟配平</h2><p>在与做Crypto的学长交流之后，仔细观察官网exp构造格与配平方式，终于发现问题，对格的构造与配平有了新的领悟</p><h3 id="减小格的维数规约出来">减小格的维数规约出来</h3><p>观察发现，我的构造与官方exp中的区别在于，我的是13x13的，而它的是12x12的，我把我的格改成12x12的之后，再按照官方exp中的配平方式来配平并平衡范数，就规约出来了，至于为什么改小就行了，之后会说，先看看配平的原理</p><h3 id="为什么要乘系数-212824...2428">为什么要乘系数 <spanclass="math inline">\(2^{128},2^4,...,2^4,2^8\)</span> ?</h3><p>这与 LLL 格基规约算法的原理有关，因为 LLL规约出来的格基向量每个分量会趋于等大正交，所以除了最后一个分量固定是0，前面的格基应该让其尽量等大，所以才要配平成<span class="math display">\[\begin{pmatrix}2^4*b_{9} &amp; 2^4*b_{8} &amp; \dots &amp; 2^4*b_0 &amp; 2^8 &amp; 0\end{pmatrix}\]</span> 所以其实就是 <span class="math display">\[\begin{pmatrix}b_{9} &amp; b_{8} &amp; \dots &amp; b_0 &amp; 2^5 &amp; 0\end{pmatrix}\]</span>这样规约出来的效果一样，这样的话调整的参数少一点，不妨称这个参数为配平系数，接下来讨论配平系数的选取</p><h3 id="调整配平系数">调整配平系数</h3><h4 id="最佳配平系数">最佳配平系数</h4><p>最佳配平系数是 <span class="math inline">\(2^5\)</span>，至于为什么，马后炮来说是 <span class="math inline">\(b_i\)</span>分布在 <span class="math inline">\(2^5\)</span>附近的方差最小，如果不知道结果的前提下应该是慢慢尝试出来的</p><p>规约出来的结果如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[ -<span class="number">5</span>  <span class="number">41</span> -<span class="number">11</span> -<span class="number">10</span> -<span class="number">34</span>  <span class="number">18</span>   <span class="number">5</span>  -<span class="number">7</span>  <span class="number">15</span> -<span class="number">40</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">43</span>  <span class="number">17</span>   <span class="number">6</span> -<span class="number">56</span>  <span class="number">36</span> -<span class="number">13</span> -<span class="number">30</span>   <span class="number">5</span> -<span class="number">32</span>  <span class="number">12</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[  <span class="number">9</span> -<span class="number">24</span> -<span class="number">24</span>  <span class="number">43</span>   <span class="number">2</span> -<span class="number">27</span> -<span class="number">25</span>  <span class="number">37</span>  <span class="number">59</span>  <span class="number">20</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">14</span>  -<span class="number">9</span> -<span class="number">67</span>  <span class="number">10</span>  <span class="number">36</span> -<span class="number">12</span>   <span class="number">9</span>   <span class="number">1</span>   <span class="number">9</span>  <span class="number">13</span> -<span class="number">32</span>   <span class="number">0</span>] &lt;-</span><br><span class="line">[-<span class="number">18</span>  <span class="number">24</span>   <span class="number">3</span> -<span class="number">53</span> -<span class="number">12</span> -<span class="number">17</span> -<span class="number">13</span>  -<span class="number">7</span>  <span class="number">32</span>   <span class="number">9</span>  <span class="number">64</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">12</span>  -<span class="number">4</span>  -<span class="number">2</span>  <span class="number">13</span>  <span class="number">16</span> -<span class="number">18</span>  <span class="number">58</span>  <span class="number">55</span>  <span class="number">44</span>  <span class="number">10</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[ -<span class="number">9</span>  <span class="number">17</span>  <span class="number">38</span>  <span class="number">19</span> -<span class="number">50</span>   <span class="number">9</span>  <span class="number">35</span>  -<span class="number">6</span>  <span class="number">58</span>  <span class="number">19</span> -<span class="number">32</span>   <span class="number">0</span>] &lt;-</span><br><span class="line">[ -<span class="number">9</span> -<span class="number">50</span> -<span class="number">22</span> -<span class="number">34</span>  -<span class="number">3</span>  <span class="number">29</span> -<span class="number">14</span> -<span class="number">10</span>  -<span class="number">7</span> -<span class="number">50</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[ <span class="number">32</span> -<span class="number">34</span> -<span class="number">11</span> -<span class="number">47</span>   <span class="number">5</span> -<span class="number">32</span>  <span class="number">43</span>  -<span class="number">2</span> -<span class="number">10</span> -<span class="number">12</span> -<span class="number">32</span>   <span class="number">0</span>] &lt;-</span><br><span class="line">[-<span class="number">19</span> -<span class="number">59</span>   <span class="number">5</span>  <span class="number">42</span> -<span class="number">50</span>  -<span class="number">8</span>  -<span class="number">1</span>  -<span class="number">8</span> -<span class="number">42</span> -<span class="number">22</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[ <span class="number">19</span> -<span class="number">48</span> -<span class="number">17</span> -<span class="number">13</span> -<span class="number">13</span>  <span class="number">41</span> -<span class="number">21</span>  <span class="number">45</span>  <span class="number">28</span>  <span class="number">49</span>  <span class="number">32</span>   <span class="number">0</span>] &lt;-</span><br></pre></td></tr></table></figure><p>根据倒数第二列为 <spanclass="math inline">\(\pm2^5\)</span>，可以看到有四组解，但其实只有以下三组解是正确的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="comment"># [-19, -58, 6, -35, -9, 50, -19, -38, -17, 9]</span></span><br><span class="line"><span class="comment"># 13ce3a25097efd663119</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="comment"># [12, 10, 2, -43, 32, -5, 47, 11, 34, -32]</span></span><br><span class="line"><span class="comment"># 340a0237200751376660</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="comment"># [-13, -9, -1, -9, 12, -36, -10, 67, 9, 14]</span></span><br><span class="line"><span class="comment"># 0d1b013bfc241ac5191e</span></span><br></pre></td></tr></table></figure><p>规出来的剩下一组解是错的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [49, 28, 45, -21, 41, -13, -13, -17, -48, 19]</span></span><br><span class="line"><span class="comment"># 3c1d1f7513d015</span></span><br></pre></td></tr></table></figure><h4 id="缩小配平系数">缩小配平系数</h4><p>配平系数为 <span class="math inline">\(2^4\)</span>时规约出来的结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[ -<span class="number">5</span>  <span class="number">41</span> -<span class="number">11</span> -<span class="number">10</span> -<span class="number">34</span>  <span class="number">18</span>   <span class="number">5</span>  -<span class="number">7</span>  <span class="number">15</span> -<span class="number">40</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">14</span>  -<span class="number">9</span> -<span class="number">67</span>  <span class="number">10</span>  <span class="number">36</span> -<span class="number">12</span>   <span class="number">9</span>   <span class="number">1</span>   <span class="number">9</span>  <span class="number">13</span> -<span class="number">16</span>   <span class="number">0</span>] &lt;-</span><br><span class="line">[  <span class="number">7</span> -<span class="number">19</span> -<span class="number">35</span> -<span class="number">20</span>  <span class="number">20</span>  -<span class="number">7</span>  <span class="number">46</span> -<span class="number">41</span>  -<span class="number">1</span>  <span class="number">30</span>  <span class="number">16</span>   <span class="number">0</span>] &lt;-</span><br><span class="line">[-<span class="number">18</span>  <span class="number">24</span>   <span class="number">3</span> -<span class="number">53</span> -<span class="number">12</span> -<span class="number">17</span> -<span class="number">13</span>  -<span class="number">7</span>  <span class="number">32</span>   <span class="number">9</span>  <span class="number">32</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">34</span>  <span class="number">10</span>  <span class="number">41</span>  <span class="number">16</span>  -<span class="number">2</span>  <span class="number">13</span>  <span class="number">18</span>   <span class="number">6</span>  -<span class="number">6</span>  <span class="number">22</span> -<span class="number">48</span>   <span class="number">0</span>] </span><br><span class="line">[ <span class="number">30</span> -<span class="number">34</span>   <span class="number">8</span>  <span class="number">13</span> -<span class="number">14</span> -<span class="number">22</span>  <span class="number">12</span>  -<span class="number">5</span>  <span class="number">49</span>  <span class="number">37</span>  <span class="number">32</span>   <span class="number">0</span>]</span><br><span class="line">[ <span class="number">11</span> -<span class="number">12</span>  <span class="number">27</span> -<span class="number">16</span>  <span class="number">30</span> -<span class="number">15</span>  <span class="number">14</span>  <span class="number">60</span> -<span class="number">23</span> -<span class="number">22</span>  <span class="number">32</span>   <span class="number">0</span>]</span><br><span class="line">[ <span class="number">25</span> -<span class="number">15</span>  <span class="number">24</span> -<span class="number">27</span> -<span class="number">15</span> -<span class="number">25</span>  -<span class="number">3</span>  <span class="number">39</span>  -<span class="number">9</span> -<span class="number">42</span> -<span class="number">32</span>   <span class="number">0</span>]</span><br><span class="line">[ -<span class="number">9</span> -<span class="number">50</span> -<span class="number">22</span> -<span class="number">34</span>  -<span class="number">3</span>  <span class="number">29</span> -<span class="number">14</span> -<span class="number">10</span>  -<span class="number">7</span> -<span class="number">50</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">37</span> -<span class="number">35</span>   <span class="number">8</span> -<span class="number">11</span> -<span class="number">62</span> -<span class="number">25</span> -<span class="number">14</span> -<span class="number">15</span> -<span class="number">10</span> -<span class="number">13</span>  <span class="number">32</span>   <span class="number">0</span>]</span><br><span class="line">[  <span class="number">0</span>  <span class="number">58</span> -<span class="number">49</span> -<span class="number">22</span> -<span class="number">10</span>  <span class="number">45</span>  <span class="number">32</span>  <span class="number">12</span>   <span class="number">0</span>  <span class="number">52</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br></pre></td></tr></table></figure><p>有两组解，都是对的</p><p>配平系数为 <span class="math inline">\(2^3\)</span>时规约出来的结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-<span class="number">34</span>  <span class="number">10</span>  <span class="number">41</span>  <span class="number">16</span>  -<span class="number">2</span>  <span class="number">13</span>  <span class="number">18</span>   <span class="number">6</span>  -<span class="number">6</span>  <span class="number">22</span> -<span class="number">24</span>   <span class="number">0</span>]</span><br><span class="line">[ <span class="number">14</span>  -<span class="number">3</span>  -<span class="number">3</span> -<span class="number">11</span> -<span class="number">45</span> -<span class="number">10</span> -<span class="number">17</span> -<span class="number">21</span>  <span class="number">14</span> -<span class="number">20</span> -<span class="number">32</span>   <span class="number">0</span>]</span><br><span class="line">[ -<span class="number">5</span>  <span class="number">41</span> -<span class="number">11</span> -<span class="number">10</span> -<span class="number">34</span>  <span class="number">18</span>   <span class="number">5</span>  -<span class="number">7</span>  <span class="number">15</span> -<span class="number">40</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">14</span>  -<span class="number">9</span> -<span class="number">67</span>  <span class="number">10</span>  <span class="number">36</span> -<span class="number">12</span>   <span class="number">9</span>   <span class="number">1</span>   <span class="number">9</span>  <span class="number">13</span>  -<span class="number">8</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">23</span> -<span class="number">14</span>  -<span class="number">2</span>  -<span class="number">1</span>  <span class="number">19</span> -<span class="number">24</span>  <span class="number">24</span>  <span class="number">46</span>  -<span class="number">6</span>  -<span class="number">7</span> -<span class="number">48</span>   <span class="number">0</span>]</span><br><span class="line">[  <span class="number">7</span> -<span class="number">19</span> -<span class="number">35</span> -<span class="number">20</span>  <span class="number">20</span>  -<span class="number">7</span>  <span class="number">46</span> -<span class="number">41</span>  -<span class="number">1</span>  <span class="number">30</span>   <span class="number">8</span>   <span class="number">0</span>] &lt;-</span><br><span class="line">[ <span class="number">11</span>  <span class="number">10</span>   <span class="number">0</span>  <span class="number">14</span>  -<span class="number">3</span>   <span class="number">6</span>  <span class="number">34</span>   <span class="number">9</span>  <span class="number">50</span>  <span class="number">17</span>  <span class="number">48</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">18</span>  <span class="number">24</span>   <span class="number">3</span> -<span class="number">53</span> -<span class="number">12</span> -<span class="number">17</span> -<span class="number">13</span>  -<span class="number">7</span>  <span class="number">32</span>   <span class="number">9</span>  <span class="number">16</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">43</span> -<span class="number">40</span>  <span class="number">19</span> -<span class="number">18</span>  -<span class="number">5</span>  <span class="number">42</span>   <span class="number">4</span>  -<span class="number">4</span> -<span class="number">13</span> -<span class="number">28</span> -<span class="number">24</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">51</span> -<span class="number">32</span>  <span class="number">11</span>   <span class="number">0</span> -<span class="number">17</span> -<span class="number">15</span>   <span class="number">3</span>   <span class="number">6</span> -<span class="number">24</span>   <span class="number">7</span>  <span class="number">48</span>   <span class="number">0</span>]</span><br><span class="line">[ <span class="number">53</span>  <span class="number">16</span> -<span class="number">12</span> -<span class="number">38</span> -<span class="number">10</span>  <span class="number">26</span>   <span class="number">0</span>  <span class="number">12</span> -<span class="number">18</span>  <span class="number">57</span>  <span class="number">32</span>   <span class="number">0</span>]</span><br></pre></td></tr></table></figure><p>可以看到只剩一组正确的解了，再往下缩小，用 <spanclass="math inline">\(2^2\)</span> 配平已经规不出来了</p><h4 id="增大配平系数同时出现了新解">增大配平系数（同时出现了新解）</h4><p>但是，在从 <span class="math inline">\(2^5\)</span>往上增大的时候出现了另一组解</p><p>配平系数为 <span class="math inline">\(2^6\)</span>时规约出来的结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[ -<span class="number">5</span>  <span class="number">41</span> -<span class="number">11</span> -<span class="number">10</span> -<span class="number">34</span>  <span class="number">18</span>   <span class="number">5</span>  -<span class="number">7</span>  <span class="number">15</span> -<span class="number">40</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">43</span>  <span class="number">17</span>   <span class="number">6</span> -<span class="number">56</span>  <span class="number">36</span> -<span class="number">13</span> -<span class="number">30</span>   <span class="number">5</span> -<span class="number">32</span>  <span class="number">12</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[  <span class="number">9</span> -<span class="number">24</span> -<span class="number">24</span>  <span class="number">43</span>   <span class="number">2</span> -<span class="number">27</span> -<span class="number">25</span>  <span class="number">37</span>  <span class="number">59</span>  <span class="number">20</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">12</span>  -<span class="number">4</span>  -<span class="number">2</span>  <span class="number">13</span>  <span class="number">16</span> -<span class="number">18</span>  <span class="number">58</span>  <span class="number">55</span>  <span class="number">44</span>  <span class="number">10</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[ -<span class="number">9</span> -<span class="number">50</span> -<span class="number">22</span> -<span class="number">34</span>  -<span class="number">3</span>  <span class="number">29</span> -<span class="number">14</span> -<span class="number">10</span>  -<span class="number">7</span> -<span class="number">50</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">19</span> -<span class="number">59</span>   <span class="number">5</span>  <span class="number">42</span> -<span class="number">50</span>  -<span class="number">8</span>  -<span class="number">1</span>  -<span class="number">8</span> -<span class="number">42</span> -<span class="number">22</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[  <span class="number">0</span>  <span class="number">58</span> -<span class="number">49</span> -<span class="number">22</span> -<span class="number">10</span>  <span class="number">45</span>  <span class="number">32</span>  <span class="number">12</span>   <span class="number">0</span>  <span class="number">52</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[ <span class="number">67</span>  <span class="number">13</span> -<span class="number">15</span> -<span class="number">49</span> -<span class="number">55</span>  <span class="number">16</span> -<span class="number">17</span>  -<span class="number">9</span>  -<span class="number">4</span>  <span class="number">37</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">14</span>  -<span class="number">9</span> -<span class="number">67</span>  <span class="number">10</span>  <span class="number">36</span> -<span class="number">12</span>   <span class="number">9</span>   <span class="number">1</span>   <span class="number">9</span>  <span class="number">13</span> -<span class="number">64</span>   <span class="number">0</span>] &lt;-</span><br><span class="line">[  <span class="number">7</span> -<span class="number">19</span> -<span class="number">35</span> -<span class="number">20</span>  <span class="number">20</span>  -<span class="number">7</span>  <span class="number">46</span> -<span class="number">41</span>  -<span class="number">1</span>  <span class="number">30</span>  <span class="number">64</span>   <span class="number">0</span>] &lt;-</span><br><span class="line">[ -<span class="number">9</span>  <span class="number">17</span>  <span class="number">38</span>  <span class="number">19</span> -<span class="number">50</span>   <span class="number">9</span>  <span class="number">35</span>  -<span class="number">6</span>  <span class="number">58</span>  <span class="number">19</span> -<span class="number">64</span>   <span class="number">0</span>] &lt;-</span><br></pre></td></tr></table></figure><p>可以看到倒数第二行出现了新的解</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span></span><br><span class="line"><span class="comment"># [30, -1, -41, 46, -7, 20, -20, -35, -19, 7]</span></span><br><span class="line"><span class="comment"># 22017b720f2c6c253307</span></span><br></pre></td></tr></table></figure><p>配平系数为 <span class="math inline">\(2^7\)</span>时规约出来的结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[ -<span class="number">5</span>  <span class="number">41</span> -<span class="number">11</span> -<span class="number">10</span> -<span class="number">34</span>  <span class="number">18</span>   <span class="number">5</span>  -<span class="number">7</span>  <span class="number">15</span> -<span class="number">40</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">43</span>  <span class="number">17</span>   <span class="number">6</span> -<span class="number">56</span>  <span class="number">36</span> -<span class="number">13</span> -<span class="number">30</span>   <span class="number">5</span> -<span class="number">32</span>  <span class="number">12</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[  <span class="number">9</span> -<span class="number">24</span> -<span class="number">24</span>  <span class="number">43</span>   <span class="number">2</span> -<span class="number">27</span> -<span class="number">25</span>  <span class="number">37</span>  <span class="number">59</span>  <span class="number">20</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">12</span>  -<span class="number">4</span>  -<span class="number">2</span>  <span class="number">13</span>  <span class="number">16</span> -<span class="number">18</span>  <span class="number">58</span>  <span class="number">55</span>  <span class="number">44</span>  <span class="number">10</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[ -<span class="number">9</span> -<span class="number">50</span> -<span class="number">22</span> -<span class="number">34</span>  -<span class="number">3</span>  <span class="number">29</span> -<span class="number">14</span> -<span class="number">10</span>  -<span class="number">7</span> -<span class="number">50</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">19</span> -<span class="number">59</span>   <span class="number">5</span>  <span class="number">42</span> -<span class="number">50</span>  -<span class="number">8</span>  -<span class="number">1</span>  -<span class="number">8</span> -<span class="number">42</span> -<span class="number">22</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[  <span class="number">0</span>  <span class="number">58</span> -<span class="number">49</span> -<span class="number">22</span> -<span class="number">10</span>  <span class="number">45</span>  <span class="number">32</span>  <span class="number">12</span>   <span class="number">0</span>  <span class="number">52</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[ <span class="number">67</span>  <span class="number">13</span> -<span class="number">15</span> -<span class="number">49</span> -<span class="number">55</span>  <span class="number">16</span> -<span class="number">17</span>  -<span class="number">9</span>  -<span class="number">4</span>  <span class="number">37</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[-<span class="number">24</span>  -<span class="number">5</span> -<span class="number">13</span> -<span class="number">27</span>  -<span class="number">8</span> -<span class="number">20</span> -<span class="number">32</span> -<span class="number">60</span>  <span class="number">40</span>  <span class="number">71</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[ <span class="number">45</span>  <span class="number">40</span> -<span class="number">38</span> -<span class="number">42</span>  <span class="number">24</span> -<span class="number">52</span>  <span class="number">27</span>   <span class="number">7</span> -<span class="number">46</span> -<span class="number">21</span>   <span class="number">0</span>   <span class="number">0</span>]</span><br><span class="line">[  <span class="number">7</span> -<span class="number">19</span> -<span class="number">35</span> -<span class="number">20</span>  <span class="number">20</span>  -<span class="number">7</span>  <span class="number">46</span> -<span class="number">41</span>  -<span class="number">1</span>  <span class="number">30</span> <span class="number">128</span>   <span class="number">0</span>] &lt;-</span><br></pre></td></tr></table></figure><p>还剩一个这个新解</p><p>一直到 <span class="math inline">\(2^{63}\)</span>都是可以规约出来这个解的，而这个上界与平衡范数乘的系数有关，增大配平系数，其实增大的是格基的模长，而平衡范数就是为了让如果增大太多导致不满足Hermite定理，也就规约不出来了</p><p>上面尝试的过程中，乘的都是 <span class="math inline">\(MOD\)</span>，所以这个上界就在 <span class="math inline">\(2^{64}\)</span>附近，如果改成乘以 <spanclass="math inline">\(2^{20}\)</span>，配平系数的上界就变成了 <spanclass="math inline">\(2^{19}\)</span></p><h2 id="领悟格的构造">12.22领悟格的构造</h2><p>现在只剩下最后一个问题了</p><blockquote><p>为什么我之前的13x13的格就规约不出来，把 <spanclass="math inline">\(-TARGERT\)</span> 和 <spanclass="math inline">\(h_0x^{10}\)</span>放在一起变成12x12的格就能规约出来？</p></blockquote><p>其实这个我还不是非常清楚，但是有一个点给了我一点启发</p><p><img src="image-20241222125039062.png" /></p><p>这是别的师傅的<ahref="https://blog.csdn.net/XiongSiqi_blog/article/details/144494152">wp</a>，他的构造方法和我一样，也就是exp1，同时他还用了DUCTF原题那个思路做了，也就是exp2</p><p>可以看到，用13维的格能规约出来一个解，但用12维的格就能规约出来两个解，大概可以猜测构造的格的维数与最后规约出来的结果有关</p><blockquote><p>也就是说，在造格时，应当在包含目标解的情况下使得格尽量的小</p></blockquote><p>目前我悟道的程度也就到这了，再多沉淀吧</p><p>还有就是，注意得平衡范数，如果最后一列不乘至少 <spanclass="math inline">\(2^{10}\)</span>大小的数的话，最后能规出来的数量会减少，精度（最后几位）也会出问题</p>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> crypto </tag>
            
            <tag> lattice </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WP-[2024.12CISCN初赛]rsand</title>
      <link href="/2024/12/15/2025CISCN%E5%88%9D%E8%B5%9B-rsand/"/>
      <url>/2024/12/15/2025CISCN%E5%88%9D%E8%B5%9B-rsand/</url>
      
        <content type="html"><![CDATA[<h1 id="rsand">rsand</h1><p>第一段想复杂了...无语...</p><p>由两个hint <span class="math display">\[\begin{cases}x_1p+y_1q=h_1\\x_2p+y_2q=h_2\end{cases}\]</span> 消去 <span class="math inline">\(p\)</span> 得到 <spanclass="math display">\[(x_2y_1-x_1y_2)q=x_2hint_1-x_1hint_2\]</span> 因为 <span class="math inline">\(x_1\)</span> 和 <spanclass="math inline">\(x_2\)</span>的位数很小，所以可以直接爆破等式右边，与 <spanclass="math inline">\(n\)</span> 的最大公因数为 <spanclass="math inline">\(q\)</span></p><p>exp如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">n = <span class="number">15362411588902771813202478635066445941567868219581080563115075898286474259882954338389793970699719911440130093205665853149410649953666749040198875967674392222163203507355594406743187111917695130252508256218749978621308541602497724665219449744861537283780518527254216366922466302326499402578109162330236444246061693469594478198741804520250626169244657971542999522991366630193919018630909161404721555664080170638132633626413255410410137099959334489280964350052541921478423372394540832436892310584104528058862537859512612948202958012151863722620647893665739096431795849153054455097180239006325840211260579467505866213321</span></span><br><span class="line">c = <span class="number">11002534477657652912372810848926482391887092190932469703165894690536229876745380661840257117009642277835336802865534980565178417018115086283494566571591522074247199913911415717085915100575473598649881133900396287499714340304262409043666909170720737038101830037153191272567843715155840570872019827741812315121448500605071700446687466870430406768450579933501297054990457726974127775349625204465934169150186539616296542755004869578536990613527055300928552638596456866596750833563115593781526966755165582546123990308808800667406917385312002041186603020503841256329991750190455878250894582571115111718135613960552099796906</span></span><br><span class="line">hint1 = <span class="number">2039159895585947475068088143527275690469909689185999604715451064124585853630752695470054673165419252527995240269327198412911807393416868235368504436584431412703134163959877202830050029989666528799391256150468576467273354859421767605446501398147668264017311245664408370173372269180865579591613828331745440553844035856076454341552544551052879486</span></span><br><span class="line">hint2 = <span class="number">6170476515613158918019570212115499947887402741180020964652659349816460675494790538630642858309783692527180075685596707268292572208320861367215001657838600707154243013775820727645118716675494532280326540990164077009804842182349494755380713591859893639814050512143156159959577957276848467778079473027018795376680418523444184725355227808205707370866889222282260917819411661336280572584451528321234887370803975647102920033004478195544414068866619365914629166753794432</span></span><br><span class="line">e=<span class="number">0x10001</span></span><br><span class="line">hint1+=<span class="number">0x114</span></span><br><span class="line">hint2+=<span class="number">0x514</span></span><br><span class="line"><span class="keyword">for</span> x1 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">11</span>):</span><br><span class="line">    <span class="keyword">for</span> x2 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">11</span>):</span><br><span class="line">        res=x2*hint1-x1*hint2</span><br><span class="line">        <span class="keyword">if</span> gcd(res,n)&gt;<span class="number">1</span>:</span><br><span class="line">            q=gcd(res,n)</span><br><span class="line">            p=n//q</span><br><span class="line">            <span class="keyword">if</span> p!=<span class="number">1</span>:</span><br><span class="line">                phi=(p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">                d=<span class="built_in">pow</span>(e,-<span class="number">1</span>,phi)</span><br><span class="line">                m=<span class="built_in">pow</span>(c,d,n)</span><br><span class="line">                <span class="built_in">print</span>(long_to_bytes(m))</span><br></pre></td></tr></table></figure><p>第二段提示 <span class="math display">\[hint=(514p-114q)^{n-p-q}\bmod n\]</span> 即 <span class="math display">\[hint\equiv(514p-114q)^{\varphi(n)-1}\bmod n\]</span> 由费马小定理 <span class="math display">\[(514p-114q)^{\varphi(n)}\equiv1 \bmod n\]</span> 则 <span class="math display">\[hint\equiv(514p-114q)^{-1}\bmod n\]</span> 即 <span class="math display">\[514p-114q\equiv hint^{-1}\bmod n\]</span> 解方程即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> Symbol, solve</span><br><span class="line"></span><br><span class="line">n = <span class="number">14613502360939407863364589690812693501576922015366807002210962584460047350845537764142210352130233032135473294184344072762436542434785585224020831394084565036716418109919829033258196217882864669635415609075818243971882912549353576386629515720087100016370772011955973283744723438549870916347709178589685193909321524165748288924202669548997517884387638918344738115457689717826344603929580127755701760308381010681916266274710602238395858963186594803904347234435058557970115334425105855525301386358186797915365594182735744972183207024004366005265160795393027146790753599490397272129760611365574650461896794485251729339917</span></span><br><span class="line">c = <span class="number">1844299912672016932426822018833591085972208214783086872799988395704845279022708684226230192763503364790682896395124939765874012896515678571101394384566426713336825986122985858527735235893804112680673539457392905480276483747257452448710122851740312060422274512680127131210147225237259230461111904664003292861437196651263996367017511863966042537545885725061709851975490202090882311310946885913288853818824443330638704672526383498619649083972724846675126742542408080719532231101926732115530039151296805345109979024130657946665108954753958579773073032661897027538002118347463185013469149637882883237217493993357422403232</span></span><br><span class="line">hint = <span class="number">13881623050018793449740724432472477579431028423415489113042909440292945176076047853295489683282566216707368640412032428065710793944727730364882781802686441001675541059762893646159952263021674742992116858706764042023688870351813641289345431554332438056975389690221360841234949127345504351560719482921978464850482655935841596020088119189343494640190529315960401842837394588319749239763935273823187981223500526826390486325704018528146085661848118036219964549751708955060489798414604842478314300870914329120804301300258551132812139046559458174322633995586180526756105707630647105997143636109998519361514738555163378927000</span></span><br><span class="line"></span><br><span class="line">res=<span class="built_in">pow</span>(hint,-<span class="number">1</span>,n)</span><br><span class="line">p = Symbol(<span class="string">&#x27;p&#x27;</span>)</span><br><span class="line">q = Symbol(<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">p, q = solve([p*q-n, <span class="number">514</span>*p-<span class="number">114</span>*q-res], [p, q])[<span class="number">1</span>]</span><br><span class="line">p = <span class="built_in">int</span>(p)</span><br><span class="line">q = <span class="built_in">int</span>(q)</span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line">phi=(p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">d=<span class="built_in">pow</span>(e,-<span class="number">1</span>,phi)</span><br><span class="line">m=<span class="built_in">pow</span>(c, d, n)</span><br><span class="line">flag2=long_to_bytes(m)</span><br><span class="line"><span class="built_in">print</span>(flag2)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WP-[2024.11强网初赛]apbq</title>
      <link href="/2024/11/27/2024%E5%BC%BA%E7%BD%91%E5%88%9D%E8%B5%9B-apbq/"/>
      <url>/2024/11/27/2024%E5%BC%BA%E7%BD%91%E5%88%9D%E8%B5%9B-apbq/</url>
      
        <content type="html"><![CDATA[<h1 id="apbq">apbq</h1><p>三段 RSA ，第一段简单，第二段原题，第三段纯纯nt</p><h2 id="第一段">第一段</h2><p>第一段是一个已知 <span class="math inline">\(p+q\)</span> 的 RSA，很简单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p_plus_q = ...</span><br><span class="line">n = ...</span><br><span class="line">e = ...</span><br><span class="line">c = ...</span><br><span class="line"></span><br><span class="line">phi = n-p_plus_q+<span class="number">1</span></span><br><span class="line">d = <span class="built_in">pow</span>(e,-<span class="number">1</span>,phi)</span><br><span class="line">m = <span class="built_in">pow</span>(c,d,n)</span><br><span class="line">flag1 = long_to_bytes(m)</span><br><span class="line"><span class="built_in">print</span>(flag1)</span><br><span class="line"><span class="comment"># flag&#123;yOu_can_</span></span><br></pre></td></tr></table></figure><h2 id="第二段">第二段</h2><p>第二段是 <ahref="https://github.com/DownUnderCTF/Challenges_2023_Public">DownUnderCTF2023</a> 原题，这里记录一下学习过程</p><h3 id="apbq-rsa-i">apbq rsa i</h3><p>原题是 apbq rsa ii ，是在 apbq rsa i 的基础上</p><p>apbq rsa i 题目如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> getPrime, bytes_to_long</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"></span><br><span class="line">p = getPrime(<span class="number">1024</span>)</span><br><span class="line">q = getPrime(<span class="number">1024</span>)</span><br><span class="line">n = p * q</span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line"></span><br><span class="line">hints = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    a, b = randint(<span class="number">0</span>, <span class="number">2</span>**<span class="number">12</span>), randint(<span class="number">0</span>, <span class="number">2</span>**<span class="number">312</span>)</span><br><span class="line">    hints.append(a * p + b * q)</span><br><span class="line"></span><br><span class="line">FLAG = <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read().strip()</span><br><span class="line">c = <span class="built_in">pow</span>(bytes_to_long(FLAG), e, n)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;n = &#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;c = &#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;hints = &#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure><p>给了两个等式 <span class="math display">\[\begin{cases}h_1=a_1p+b_1q\\h_2=a_2p+b_2q\end{cases}\]</span> 消去<span class="math inline">\(p\)</span> <spanclass="math display">\[a_2h_1-a_1h_2=(a_2b_1-a_1b_2)q\]</span> 于是 <span class="math inline">\(a_2h_1-a_1h_2\)</span> 是<span class="math inline">\(q\)</span> 的倍数，于是 <spanclass="math inline">\(q\)</span> 是 <spanclass="math inline">\(a_2h_1-a_1h_2\)</span> 和 <spanclass="math inline">\(n\)</span> 的 <spanclass="math inline">\(gcd\)</span>，而a1和a2的位数很小，于是可以爆破</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">n = ...</span><br><span class="line">c = ...</span><br><span class="line">hints = [...]</span><br><span class="line"><span class="comment"># 参数见原题</span></span><br><span class="line">h1 = hints[<span class="number">0</span>]</span><br><span class="line">h2 = hints[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> a1, a2 <span class="keyword">in</span> product(<span class="built_in">range</span>(<span class="number">2</span>**<span class="number">12</span>), repeat=<span class="number">2</span>):<span class="comment"># 相当于product(range(2**12), range(2**12))</span></span><br><span class="line">    q = gcd(a2 * h1 - a1 * h2, n)</span><br><span class="line">    <span class="keyword">if</span> q != <span class="number">1</span> <span class="keyword">and</span> q &lt; n:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;q found:&quot;</span>,q)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">p = n // q</span><br><span class="line">phi = (p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">d = <span class="built_in">pow</span>(e,-<span class="number">1</span>,phi)</span><br><span class="line">m = <span class="built_in">pow</span>(c,d,n)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br><span class="line"><span class="comment"># DUCTF&#123;gcd_1s_a_g00d_alg0r1thm_f0r_th3_t00lbox&#125;</span></span><br></pre></td></tr></table></figure><h3 id="apbq-rsa-ii">apbq rsa ii</h3><p>接下来是 apbq rsa ii ，题目如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> getPrime, bytes_to_long</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"></span><br><span class="line">p = getPrime(<span class="number">1024</span>)</span><br><span class="line">q = getPrime(<span class="number">1024</span>)</span><br><span class="line">n = p * q</span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line"></span><br><span class="line">hints = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    a, b = randint(<span class="number">0</span>, <span class="number">2</span>**<span class="number">312</span>), randint(<span class="number">0</span>, <span class="number">2</span>**<span class="number">312</span>)</span><br><span class="line">    hints.append(a * p + b * q)</span><br><span class="line"></span><br><span class="line">FLAG = <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read().strip()</span><br><span class="line">c = <span class="built_in">pow</span>(bytes_to_long(FLAG), e, n)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;n = &#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;c = &#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;hints = &#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure><p>和上一道差不多，区别在于多了一个提示，同时a的位数变大了，现在和b一样</p><p>2024.11.7 实在看不懂，只能先把大佬文章先留下来</p><p><ahref="https://blog.maple3142.net/2023/09/03/downunderctf-2023-writeups/#apbq-rsa-ii">DownUnderCTF2023 Writeups</a></p><p><ahref="https://tangcuxiaojikuai.xyz/post/df3f7032.html#more">2024-强网杯-wp-crypto</a></p><h3 id="初步推导">初步推导</h3><p>和上一题差不多的推导，由三个等式可以消去 <spanclass="math inline">\(p\)</span> 和 <spanclass="math inline">\(q\)</span> 两个变量 <span class="math display">\[a_1a_3b_2h_1-a_1a_2b_3h_1-a_1a_3b_1h_2+a_1^2b_3h_2+a_1a_2b_1h_3-a_1^2b_2h_3=0\]</span> 提取公因子 <span class="math inline">\(a_1\)</span> <spanclass="math display">\[(a_3b_2-a_2b_3)h_1+(a_1b_3-a_3b_1)h_2+(a_2b_1-a_1b_2)h_3=0\]</span> 于是构造格 <span class="math display">\[\begin{pmatrix}a_3b_2-a_2b_3 &amp; a_1b_3-a_3b_1 &amp; a_2b_1-a_1b_2\end{pmatrix}\begin{pmatrix}    h_1 &amp; 1 &amp; 0 &amp;0 \\\\   h_2 &amp; 0 &amp; 1 &amp; 0 \\\\    h_3 &amp; 0 &amp; 0 &amp; 1\end{pmatrix}=\begin{pmatrix}0 &amp; a_3b_2-a_2b_3 &amp; a_1b_3-a_3b_1 &amp; a_2b_1-a_1b_2\end{pmatrix}\]</span> 做一下范数平衡，验证Hermite定理</p><p><img src="20240515192753-2b356060-12ae-1.png" /></p><p><span class="math display">\[||v||=\sqrt{0^2+(a_3b_2-a_2b_3)^2+(a_1b_3-a_3b_1)^2+(a_2b_1-a_1b_2)^2}\]</span> 约为 <span class="math inline">\(312*2=624\)</span> 位</p><p>非方阵的行列式见笔记另一篇笔记 <ahref="F:\Work\notes\acquisition\Lattice.md">Lattice</a> <spanclass="math display">\[det(L)=\sqrt{1+\sum_{i = 0}^{n}\alpha_i^2}=\sqrt{1+h_1^2+h_2^2+h_3^2}\]</span> 约为 <span class="math inline">\(h_1\)</span> 的位数，<spanclass="math inline">\(1336\)</span> 位，所以 <spanclass="math inline">\(\sqrt {n}det(L)^\frac{1}{n}\)</span> 约为 <spanclass="math inline">\(1336/4\approx334\)</span>位，不满足条件，于是第一列乘 <spanclass="math inline">\(n\)</span>（题目给的 <spanclass="math inline">\(n\)</span>，不是维数）</p><p>乘完之后，<span class="math inline">\(||v||\)</span> 还是 <spanclass="math inline">\(624\)</span> 位，<span class="math inline">\(\sqrt{n}det(L)^\frac{1}{n}\)</span> 增大到 <spanclass="math inline">\((1336+2048)/4=846\)</span> 位，满足要求</p><h3 id="系数调整">系数调整</h3><p>取格出来的第一个行向量，就是我们要的 <span class="math display">\[\begin{pmatrix}0 &amp; a_3b_2-a_2b_3 &amp; a_1b_3-a_3b_1 &amp;a_2b_1-a_1b_2 \end{pmatrix}\]</span> 但看其它师傅的博客，还有正负号需要调整</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">_, t, u, v = L[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># therefore this should hold</span></span><br><span class="line"><span class="comment"># assert abs(a3*b2 - a2*b3) == abs(t)</span></span><br><span class="line"><span class="comment"># assert abs(a3*b1 - a1*b3) == abs(u)</span></span><br><span class="line"><span class="comment"># assert abs(a2*b1 - a1*b2) == abs(v)</span></span><br><span class="line">a1s, a2s, a3s, b1s, b2s, b3s = QQ[<span class="string">&quot;a1,a2,a3,b1,b2,b3&quot;</span>].gens()</span><br><span class="line"><span class="keyword">for</span> sign <span class="keyword">in</span> itertools.product((-<span class="number">1</span>,<span class="number">1</span>), repeat=<span class="number">3</span>):</span><br><span class="line">    I = ideal(</span><br><span class="line">        [</span><br><span class="line">            a3s * b2s - a2s * b3s + sign[<span class="number">0</span>] * t,</span><br><span class="line">            a3s * b1s - a1s * b3s + sign[<span class="number">1</span>] * u,</span><br><span class="line">            a2s * b1s - a1s * b2s + sign[<span class="number">2</span>] * v,</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> I.dimension() != -<span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(sign)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;dim&quot;</span>, I.dimension())</span><br></pre></td></tr></table></figure><h3 id="groebner-basis">groebner basis</h3><p>现在得到了理想 <span class="math display">\[(a3s * b2s - a2s * b3s - t, a3s * b1s - a1s * b3s + u, a2s * b1s - a1s *b2s - v)\]</span> 做 groebner_basis...</p><p>额额，什么是 groebner_basis？</p><p>先参考以下几篇文章，学习了一下groebner basis</p><p>https://www.cnblogs.com/ZimaBlue/articles/16927952.html</p><p>https://zhuanlan.zhihu.com/p/262906557</p><p>groebner basis定义即</p><p><img src="image-20241108000700917.png" /></p><p>其中，<code>S-polynomial</code>函数的定义为</p><p><img src="image-20241108002154475.png" /></p><p>即 groebner basis（本身是一个生成元组）中的生成元均满足：对任意两个生成元，二者首项的最小公倍项除以各自的首项后乘以自己本身，得到的项相减，也就是<code>S-polynomial</code>函数的结果，能够整除groebner basis 自己</p><p>我自己的认识是：</p><p>通过做 groebner basis，可以将复杂的等式按照变量进行剥离，得到更“干净”的关系</p><p>在本题中，对理想 I 做 groebner basis后，可以得到三个更简单的等式，其中第二个等式是一个 <spanclass="math inline">\(k_1a_1+k_2a_2+k_3a_3=0\)</span>的简单等式，第三个等式是一个 <spanclass="math inline">\(k_1b_1+k_2b_2+k_3b_3=0\)</span> 的简单等式</p><p><img src="image-20241108004324576.png" /></p><h3 id="后续">后续</h3><p>接下来，用这两个等式，我们再LLL规一次即可 <spanclass="math display">\[\begin{pmatrix} a_1 &amp; a_2 &amp;a_3 \end{pmatrix}\begin{pmatrix}    k_1 &amp; 1 &amp; 0 &amp;0 \\\\   k_2 &amp; 0 &amp; 1&amp; 0 \\\\    k_3 &amp; 0 &amp; 0 &amp; 1\end{pmatrix} =\begin{pmatrix}0 &amp; a_1 &amp; a_2 &amp; a_3\end{pmatrix}\]</span> 对<span class="math inline">\(b_1、b_2、b_3\)</span>也同理</p><p>这个格满足Hermite定理，能直接规出来结果，用规出来的 <spanclass="math inline">\(a_1、a_2和a_3\)</span> ，接下来用 apbq rsa i的思路解即可</p><p>2024.11.13原wp部分如下，其中的线性组合我没理解是干啥的，组合的系数范围也不知道怎么定的，反正我规出来的结果可以直接用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">xs = []</span><br><span class="line"><span class="keyword">for</span> c1, c2 <span class="keyword">in</span> product((-<span class="number">2</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>), repeat=<span class="number">2</span>):</span><br><span class="line">v = c1 * v1 + c2 * v2</span><br><span class="line">    _, x1, x2, x3 = v</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">all</span>([<span class="number">0</span> &lt;= x &lt;= <span class="number">2</span>**<span class="number">312</span> <span class="keyword">for</span> x <span class="keyword">in</span> (x1, x2, x3)]):</span><br><span class="line">    xs.append((x1, x2, x3))</span><br><span class="line"><span class="comment"># we don&#x27;t know which one is correct pair of (a1, a2, a3) and (b1, b2, b3)</span></span><br><span class="line"><span class="comment"># just try all combinations</span></span><br><span class="line"><span class="keyword">for</span> g1, g2 <span class="keyword">in</span> combinations(xs, <span class="number">2</span>):</span><br><span class="line">a1r, a2r, a3r = g1</span><br><span class="line">b1r, b2r, b3r = g2</span><br></pre></td></tr></table></figure><p>同时，我还做了验证</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> c1, c2 <span class="keyword">in</span> itertools.product((<span class="number">0</span>, <span class="number">1</span>), repeat=<span class="number">2</span>):</span><br><span class="line">    v = c1 * v1 + c2 * v2</span><br><span class="line">    _, x1, x2, x3 = v</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;c1: <span class="subst">&#123;c1&#125;</span>, c2:<span class="subst">&#123;c2&#125;</span>, v:<span class="subst">&#123;v&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">all</span>([<span class="number">0</span> &lt;= x &lt;= <span class="number">2</span>**<span class="number">312</span> <span class="keyword">for</span> x <span class="keyword">in</span> (x1, x2, x3)]):</span><br><span class="line">        xs.append((x1, x2, x3))</span><br><span class="line"><span class="comment"># we don&#x27;t know which one is correct pair of (a1, a2, a3) and (b1, b2, b3)</span></span><br><span class="line"><span class="comment"># just try all combinations</span></span><br><span class="line"><span class="keyword">for</span> g1, g2 <span class="keyword">in</span> itertools.combinations(xs, <span class="number">2</span>):</span><br><span class="line">a1r, a2r, a3r = g1</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;g1:&quot;</span>,g1)</span><br><span class="line">b1r, b2r, b3r = g2</span><br></pre></td></tr></table></figure><p>可以根据下面的打印调试信息知道，遍历出来的结果，系数其实就是1和0，也就是直接用规出来的结果</p><p><img src="image-20241113175839401.png" /></p><p>我自己调整过的exp如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">n = ...</span><br><span class="line">c = ...</span><br><span class="line">hints = [...]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># assert a2 * h1 - a1 * h2 == (a2 * b1 - a1 * b2) * q</span></span><br><span class="line"><span class="comment"># assert a3 * h1 - a1 * h3 == (a3 * b1 - a1 * b3) * q</span></span><br><span class="line"><span class="comment"># assert (a3 * b1 - a1 * b3) * (a2 * h1 - a1 * h2) == (a2 * b1 - a1 * b2) * (a3 * h1 - a1 * h3)</span></span><br><span class="line"><span class="comment"># so: a1*a3*b2*h1 - a1*a2*b3*h1 - a1*a3*b1*h2 + a1^2*b3*h2 + a1*a2*b1*h3 - a1^2*b2*h3 == 0</span></span><br><span class="line"><span class="comment"># we try to use LLL to find them</span></span><br><span class="line"></span><br><span class="line">h1, h2, h3 = hints</span><br><span class="line">L = matrix(hints).T.augment(matrix.identity(<span class="number">3</span>))</span><br><span class="line">L[:, <span class="number">0</span>] *= n</span><br><span class="line">L = L.LLL()</span><br><span class="line"><span class="keyword">for</span> v <span class="keyword">in</span> L:</span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line">    <span class="built_in">print</span>([<span class="built_in">int</span>(x).bit_length() <span class="keyword">for</span> x <span class="keyword">in</span> v])</span><br><span class="line"></span><br><span class="line"><span class="comment"># the expected vector is (a1*a3*b1-a1*a2*b3, -a1*a3*b1+a1**2*b3, a1*a2*b1-a1**2*b2)</span></span><br><span class="line"><span class="comment"># but we can see that a1 divides all of them</span></span><br><span class="line"><span class="comment"># assuming gcd(gcd((a1*a3*b2-a1*a2*b3), (-a1*a3*b1+a1**2*b3)), (a1*a2*b1-a1**2*b2)) == 1 here</span></span><br><span class="line"><span class="comment"># the shortest vector should be (a3*b2-a2*b3, -a3*b1+a1*b3, a2*b1-a1*b2)</span></span><br><span class="line"></span><br><span class="line">_, t, u, v = L[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># therefore this should hold</span></span><br><span class="line"><span class="comment"># assert abs(a3*b2 - a2*b3) == abs(t)</span></span><br><span class="line"><span class="comment"># assert abs(a3*b1 - a1*b3) == abs(u)</span></span><br><span class="line"><span class="comment"># assert abs(a2*b1 - a1*b2) == abs(v)</span></span><br><span class="line">a1s, a2s, a3s, b1s, b2s, b3s = QQ[<span class="string">&quot;a1,a2,a3,b1,b2,b3&quot;</span>].gens()</span><br><span class="line"><span class="keyword">for</span> sign <span class="keyword">in</span> itertools.product((-<span class="number">1</span>,<span class="number">1</span>), repeat=<span class="number">3</span>):</span><br><span class="line">    I = ideal(</span><br><span class="line">        [</span><br><span class="line">            a3s * b2s - a2s * b3s + sign[<span class="number">0</span>] * t,</span><br><span class="line">            a3s * b1s - a1s * b3s + sign[<span class="number">1</span>] * u,</span><br><span class="line">            a2s * b1s - a1s * b2s + sign[<span class="number">2</span>] * v,</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> I.dimension() != -<span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(sign)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;dim&quot;</span>, I.dimension())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;groebner_basis&quot;</span>,I.groebner_basis())</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">step2</span>(<span class="params">f</span>):</span><br><span class="line">            <span class="comment"># this f is in the form of k1*a1+k2*a2+k3*a3==0</span></span><br><span class="line">            <span class="comment"># for some reason, k1*b1+k2*b2+k3*b3==0 also holds</span></span><br><span class="line">            <span class="comment"># use LLL to find it</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">40</span>)</span><br><span class="line">            <span class="built_in">print</span>(f)</span><br><span class="line">            L = matrix(f.coefficients()).T.augment(matrix.identity(<span class="number">3</span>))</span><br><span class="line">            L[:, <span class="number">0</span>] *= n</span><br><span class="line">            L = L.LLL()</span><br><span class="line">            <span class="built_in">print</span>(L[<span class="number">0</span>])</span><br><span class="line">            <span class="built_in">print</span>(L[<span class="number">1</span>])</span><br><span class="line">            _ , a1r, a2r, a3r = L[<span class="number">0</span>]</span><br><span class="line">            q = gcd(a2r * h1 - a1r * h2, n)</span><br><span class="line">            <span class="keyword">if</span> <span class="number">1</span> &lt; q &lt; n:</span><br><span class="line">                p = n // q</span><br><span class="line">                e = <span class="number">0x10001</span></span><br><span class="line">                d = inverse_mod(e, (p - <span class="number">1</span>) * (q - <span class="number">1</span>))</span><br><span class="line">                m = <span class="built_in">pow</span>(c, d, n)</span><br><span class="line">                flag = <span class="built_in">int</span>(m).to_bytes(<span class="number">1024</span>, <span class="string">&quot;big&quot;</span>).strip(<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(flag)</span><br><span class="line">                exit()</span><br><span class="line"></span><br><span class="line">        step2(I.groebner_basis()[<span class="number">1</span>])</span><br><span class="line"><span class="comment"># DUCTF&#123;0rtho_l4tt1c3_1s_a_fun_and_gr34t_t3chn1que_f0r_the_t00lbox!&#125;</span></span><br></pre></td></tr></table></figure><p>原exp有几个地方需要注意，一个是下面这个调试打印的地方</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> v <span class="keyword">in</span> L:</span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line">    <span class="built_in">print</span>([x.bit_length() <span class="keyword">for</span> x <span class="keyword">in</span> v])</span><br></pre></td></tr></table></figure><p>要改成</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> v <span class="keyword">in</span> L:</span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line">    <span class="built_in">print</span>([<span class="built_in">int</span>(x).bit_length() <span class="keyword">for</span> x <span class="keyword">in</span> v])</span><br></pre></td></tr></table></figure><p>然后是用<code>product</code>函数遍历的时候会报错<code>'int' object is not iterable sage</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> sign <span class="keyword">in</span> product((-<span class="number">1</span>,<span class="number">1</span>), repeat=<span class="number">3</span>):</span><br><span class="line">    I = ideal(</span><br><span class="line">        [</span><br><span class="line">            a3s * b2s - a2s * b3s + sign[<span class="number">0</span>] * t,</span><br><span class="line">            a3s * b1s - a1s * b3s + sign[<span class="number">1</span>] * u,</span><br><span class="line">            a2s * b1s - a1s * b2s + sign[<span class="number">2</span>] * v,</span><br><span class="line">        ]</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>这个问题困扰我挺久的，我把数据类型换来换去都不对，后来查看了<code>product</code>的类型，也是<code>function</code>，但万万没想到原来这里的<code>function</code>不是预期的<code>function</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;function symbolic_prod at <span class="number">0x7f2ea9d2f8b0</span>&gt;</span><br></pre></td></tr></table></figure><p>可以看到，<code>product</code>函数已经变成了<code>symbolic_prod</code>，而这是一个sage里的函数</p><p><img src="image-20241107003546061.png" /></p><p>因为这里本意是使用python里的<code>product</code>函数，但这是一个sage脚本，在sage环境里跑的时候，会使用sage里面的同名函数，所以会报参数错误</p><p><img src="image-20241107001855660.png" /></p><p>解决办法很简单，在导入<code>product</code>函数的时候换个名字就行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product <span class="keyword">as</span> it_product</span><br></pre></td></tr></table></figure><p>然后后面在使用<code>product</code>的地方修改为</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> sign <span class="keyword">in</span> it_product((-<span class="number">1</span>,<span class="number">1</span>), repeat=<span class="number">3</span>):</span><br></pre></td></tr></table></figure><p>或者是指定一下使用的是<code>itertools</code>库中的<code>product</code>函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> sign <span class="keyword">in</span> itertools.product((-<span class="number">1</span>,<span class="number">1</span>), repeat=<span class="number">3</span>):</span><br></pre></td></tr></table></figure><p>这样的话导入的时候就要改成</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br></pre></td></tr></table></figure><h3 id="另一版-exp">另一版 exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># n, c, hints</span></span><br><span class="line"><span class="built_in">exec</span>(<span class="built_in">open</span>(<span class="string">&#x27;../src/output.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read())</span><br><span class="line"></span><br><span class="line">V = hints</span><br><span class="line">k = <span class="number">2</span>^<span class="number">800</span></span><br><span class="line">M = Matrix.column([k * v <span class="keyword">for</span> v <span class="keyword">in</span> V]).augment(Matrix.identity(<span class="built_in">len</span>(V)))</span><br><span class="line">B = [b[<span class="number">1</span>:] <span class="keyword">for</span> b <span class="keyword">in</span> M.LLL()]</span><br><span class="line">M = (k * Matrix(B[:<span class="built_in">len</span>(V)-<span class="number">2</span>])).T.augment(Matrix.identity(<span class="built_in">len</span>(V)))</span><br><span class="line">B = [b[-<span class="built_in">len</span>(V):] <span class="keyword">for</span> b <span class="keyword">in</span> M.LLL() <span class="keyword">if</span> <span class="built_in">set</span>(b[:<span class="built_in">len</span>(V)-<span class="number">2</span>]) == &#123;<span class="number">0</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> s, t <span class="keyword">in</span> itertools.product(<span class="built_in">range</span>(<span class="number">4</span>), repeat=<span class="number">2</span>):</span><br><span class="line">    T = s*B[<span class="number">0</span>] + t*B[<span class="number">1</span>]</span><br><span class="line">    a1, a2, a3 = T</span><br><span class="line">    kq = gcd(a1 * hints[<span class="number">1</span>] - a2 * hints[<span class="number">0</span>], n)</span><br><span class="line">    <span class="keyword">if</span> <span class="number">1</span> &lt; kq &lt; n:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;find!&#x27;</span>, kq, s, t)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">16</span>, <span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">if</span> kq % i == <span class="number">0</span>:</span><br><span class="line">        kq //= i</span><br><span class="line">q = <span class="built_in">int</span>(kq)</span><br><span class="line">p = <span class="built_in">int</span>(n // kq)</span><br><span class="line">d = <span class="built_in">pow</span>(<span class="number">0x10001</span>, -<span class="number">1</span>, (p - <span class="number">1</span>) * (q - <span class="number">1</span>))</span><br><span class="line">m = <span class="built_in">pow</span>(c, d, n)</span><br><span class="line">flag = long_to_bytes(m).decode()</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>其实思路差不多，这段里面的线性组合也可以去掉</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line">n = ...</span><br><span class="line">c = ...</span><br><span class="line">hints = [...]</span><br><span class="line"></span><br><span class="line">V = hints</span><br><span class="line">k = <span class="number">2</span>^<span class="number">800</span></span><br><span class="line"></span><br><span class="line">M = Matrix.column([k * v <span class="keyword">for</span> v <span class="keyword">in</span> V]).augment(Matrix.identity(<span class="built_in">len</span>(V)))</span><br><span class="line"><span class="built_in">print</span>(M.LLL())</span><br><span class="line">B = [b[<span class="number">1</span>:] <span class="keyword">for</span> b <span class="keyword">in</span> M.LLL()]</span><br><span class="line">M = (k * Matrix(B[:<span class="built_in">len</span>(V)-<span class="number">2</span>])).T.augment(Matrix.identity(<span class="built_in">len</span>(V)))</span><br><span class="line"><span class="built_in">print</span>(M.LLL())</span><br><span class="line">B = [b[<span class="number">1</span>:] <span class="keyword">for</span> b <span class="keyword">in</span> M.LLL() <span class="keyword">if</span> <span class="built_in">set</span>(b[:<span class="number">1</span>]) == &#123;<span class="number">0</span>&#125;]</span><br><span class="line"><span class="built_in">print</span>(B)</span><br><span class="line"></span><br><span class="line">a1, a2, a3 = B[<span class="number">0</span>]</span><br><span class="line">kq = gcd(a1 * hints[<span class="number">1</span>] - a2 * hints[<span class="number">0</span>], n)</span><br><span class="line"><span class="keyword">if</span> <span class="number">1</span> &lt; kq &lt; n:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;find!&#x27;</span>, kq)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">16</span>, <span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">if</span> kq % i == <span class="number">0</span>:</span><br><span class="line">        kq //= i</span><br><span class="line">q = <span class="built_in">int</span>(kq)</span><br><span class="line">p = <span class="built_in">int</span>(n // kq)</span><br><span class="line">d = <span class="built_in">pow</span>(<span class="number">0x10001</span>, -<span class="number">1</span>, (p - <span class="number">1</span>) * (q - <span class="number">1</span>))</span><br><span class="line">m = <span class="built_in">pow</span>(c, d, n)</span><br><span class="line">flag = long_to_bytes(<span class="built_in">int</span>(m)).decode()</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><h3 id="回到这道题目">回到这道题目</h3><p>这道题唯一的区别就是3组变成了100组</p><p>1、2与任一其它等式联立得到 <span class="math display">\[(a_ib_2-a_2b_i)h_1+(a_1b_i-a_ib_1)h_2+(a_2b_1-a_1b_2)h_i=0\]</span> 构造格如下 <span class="math display">\[\begin{pmatrix}a_2b_1-a_1b_2 &amp; a_3b_2-a_2b_3 &amp; a_1b_3-a_3b_1 &amp;a_4b_2-a_2b_4 &amp; a_1b_4-a_4b_1 &amp; \dots &amp;a_{100}b_2-a_2b_{100} &amp; a_1b_{100}-a_{100}b_1\end{pmatrix}\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; 0&amp; h_3 &amp; h_4 &amp; h_5 &amp; \dots &amp; h_{100}\\\\0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; 0&amp; h_1 &amp; 0 &amp; 0 &amp; \dots &amp; 0\\\\0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; 0&amp; h_2 &amp; 0 &amp; 0 &amp; \dots &amp; 0\\\\0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; 0&amp; 0 &amp; h_1 &amp; 0 &amp; \dots &amp; 0\\\\0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; \dots &amp; 0 &amp; 0&amp; 0 &amp; h_2 &amp; 0 &amp; \dots &amp; 0\\\\\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots&amp; \ddots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp;\vdots &amp; \vdots &amp; \vdots\\\\0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; \dots &amp; 1 &amp; 0&amp; 0 &amp; 0 &amp; 0 &amp; \dots &amp; h_1\\\\0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; 1&amp; 0 &amp; 0 &amp; 0 &amp; \dots &amp; h_2\end{pmatrix}=\begin{pmatrix}a_2b_1-a_1b_2 &amp; a_3b_2-a_2b_3 &amp; a_1b_3-a_3b_1 &amp;a_4b_2-a_2b_4 &amp; a_1b_4-a_4b_1 &amp; \dots &amp;a_{100}b_2-a_2b_{100} &amp; a_1b_{100}-a_{100}b_1 &amp; 0 &amp; \dots&amp; 0\end{pmatrix}\]</span></p><p>平衡范数和之前一样，规出来之后，就和那个题一样了</p><p><ahref="https://tangcuxiaojikuai.xyz/post/df3f7032.html#more">大佬的exp</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#stage2</span></span><br><span class="line"><span class="keyword">from</span> re <span class="keyword">import</span> findall</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_output</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flatter</span>(<span class="params">M</span>):</span><br><span class="line">    <span class="comment"># compile https://github.com/keeganryan/flatter and put it in $PATH</span></span><br><span class="line">    z = <span class="string">&quot;[[&quot;</span> + <span class="string">&quot;]\n[&quot;</span>.join(<span class="string">&quot; &quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, row)) <span class="keyword">for</span> row <span class="keyword">in</span> M) + <span class="string">&quot;]]&quot;</span></span><br><span class="line">    ret = check_output([<span class="string">&quot;flatter&quot;</span>], <span class="built_in">input</span>=z.encode())</span><br><span class="line">    <span class="keyword">return</span> matrix(M.nrows(), M.ncols(), <span class="built_in">map</span>(<span class="built_in">int</span>, findall(<span class="string">b&quot;-?\\d+&quot;</span>, ret)))</span><br><span class="line"></span><br><span class="line">hint2 =</span><br><span class="line">n2, e2 = (<span class="number">73566307488763122580179867626252642940955298748752818919017828624963832700766915409125057515624347299603944790342215380220728964393071261454143348878369192979087090394858108255421841966688982884778999786076287493231499536762158941790933738200959195185310223268630105090119593363464568858268074382723204344819</span>, <span class="number">65537</span>)</span><br><span class="line">enc2 = <span class="number">30332590230153809507216298771130058954523332140754441956121305005101434036857592445870499808003492282406658682811671092885592290410570348283122359319554197485624784590315564056341976355615543224373344781813890901916269854242660708815123152440620383035798542275833361820196294814385622613621016771854846491244</span></span><br><span class="line"></span><br><span class="line">h = hint2</span><br><span class="line">nums = <span class="number">98</span></span><br><span class="line">L = Matrix(ZZ, <span class="number">1</span>+nums*<span class="number">2</span>, <span class="number">1</span>+nums*<span class="number">3</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>+nums*<span class="number">2</span>):</span><br><span class="line">    L[i,i] = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nums):</span><br><span class="line">    L[<span class="number">0</span>,<span class="number">1</span>+nums*<span class="number">2</span>+i] = h[i+<span class="number">2</span>]</span><br><span class="line">    L[<span class="number">2</span>*i+<span class="number">1</span>,<span class="number">1</span>+nums*<span class="number">2</span>+i] = h[<span class="number">0</span>]</span><br><span class="line">    L[<span class="number">2</span>*i+<span class="number">2</span>,<span class="number">1</span>+nums*<span class="number">2</span>+i] = h[<span class="number">1</span>]</span><br><span class="line">L[:,-nums:] *= <span class="number">2</span>^<span class="number">512</span></span><br><span class="line">L = flatter(L)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后面和apbq rsa ii的一样</span></span><br></pre></td></tr></table></figure><p>这里用的是<ahref="https://github.com/keeganryan/flatter">flatter</a>来做格基规约，会更快一点，用普通的LLL也可以的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">L[:,-nums:] *= <span class="number">2</span>^<span class="number">512</span></span><br><span class="line">L = L.LLL()</span><br></pre></td></tr></table></figure><p>同样的，这段exp里step2部分也可以像之前说的一样，线性组合部分也可以去掉</p><h3 id="这道题的另一种解法正交格">这道题的另一种解法——正交格</h3><p>其实如果直接顺着 apbq rsa ii 的思路来，应该可以得到下面这个等式</p>（<span class="math inline">\(h_1\sim h_{100}\)</span>放在第一列和最后一列一样) <span class="math display">\[\begin{pmatrix}a_3b_2-a_2b_3 &amp; a_1b_3-a_3b_1 &amp; a_2b_1-a_1b_2 &amp;0 &amp; 0&amp;\dots &amp; 0 \\\\a_4b_2-a_2b_4 &amp; a_1b_4-a_4b_1 &amp;0 &amp; a_2b_1-a_1b_2 &amp; 0&amp;\dots &amp; 0\\\\\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \ddots&amp;\vdots\\\\a_{100}b_2-a_2b_{100} &amp; a_1b_{100}-a_{100}b_1 &amp;0 &amp;\dots&amp;\dots &amp;\dots &amp; a_2b_1-a_1b_2\end{pmatrix}\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; h_1\\\\0 &amp; 1 &amp; 0 &amp; \dots &amp; 0 &amp; h_2\\\\0 &amp; 0 &amp; 1 &amp; \dots &amp; 0 &amp; h_3\\\\\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp;\vdots\\\\0 &amp; 0 &amp; 0 &amp; \dots &amp; 1 &amp; h_{100}\end{pmatrix}=\begin{pmatrix}a_3b_2-a_2b_3 &amp; a_1b_3-a_3b_1 &amp; a_2b_1-a_1b_2 &amp; 0 &amp; 0&amp; \dots &amp; 0 &amp; 0\\\\a_4b_2-a_2b_4 &amp; a_1b_4-a_4b_1 &amp;0 &amp; a_2b_1-a_1b_2 &amp; 0&amp; \dots &amp; 0 &amp; 0\\\\\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \ddots&amp; \vdots &amp; \vdots\\\\a_{100}b_2-a_2b_{100} &amp; a_1b_{100}-a_{100}b_1 &amp;0 &amp;\dots&amp;\dots &amp;\dots &amp; a_2b_1-a_1b_2 &amp; 0\end{pmatrix}\]</span>由于格的学习不是很系统，我错误地以为这个是上一种构造格的方式，直接认为对$$<span class="math display">\[\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; h_1 \\\\0 &amp; 1 &amp; 0 &amp; \dots &amp; 0 &amp; h_2\\\\\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp;\vdots\\\\0 &amp; 0 &amp; 0 &amp; \dots &amp; 1 &amp; h_{100}\end{pmatrix}\]</span><span class="math display">\[格基规约后的结果，第一个行向量就是\]</span><span class="math display">\[\begin{pmatrix}a_3b_2-a_2b_3 &amp; a_1b_3-a_3b_1 &amp; a_2b_1-a_1b_2 &amp; 0 &amp; 0&amp; \dots &amp; 0 &amp; 0\end{pmatrix}\]</span><p>$$ 实际上不是这样的，这个等式是用来做正交格的</p><h4 id="正交格学习">正交格学习</h4><p>强烈推荐的大佬，一直在持续更新</p><p><ahref="https://tangcuxiaojikuai.xyz/post/187210a7.html">Crypto趣题-曲线</a></p><h4 id="右核学习">右核学习</h4><h5 id="右核的定义">右核的定义</h5><p>对于矩阵 <span class="math inline">\(M\)</span>（形状为 <spanclass="math inline">\(m \times n\)</span>），右核是所有使得 <spanclass="math inline">\(M \cdot \mathbf{v} = 0\)</span> 的向量 <spanclass="math inline">\(\mathbf{v}\)</span> 的集合，即 <spanclass="math display">\[\text{Ker}(M) = \{\mathbf{v} \in \mathbb{R}^n \ | \ M \cdot \mathbf{v} =\mathbf{0} \}\]</span> 右核是一个向量空间，因此它有以下性质：</p><ul><li>它的维度称为右核的维数，由维数定理（Rank-Nullity Theorem） 确定</li><li>右核空间的基是一组线性无关的向量，可以生成整个右核空间</li></ul><p>要知道满足条件 <span class="math inline">\(M \cdot \mathbf{v} =\mathbf{0}\)</span> 的列向量有多少个，我们需要确定右核（nullspace）向量空间的维数，即右核的维度（nullity）</p><h5 id="秩-零化维数定理">秩-零化维数定理</h5><p>线性代数中的 <strong>Rank-Nullity Theorem</strong>提供了直接的答案。对于一个 <span class="math inline">\(m \timesn\)</span> 的矩阵 <span class="math inline">\(M\)</span>，有以下关系<span class="math display">\[\text{rank}(M) + \text{nullity}(M) = n\]</span> 其中</p><ul><li><span class="math inline">\(\text{rank}(M)\)</span>：矩阵 <spanclass="math inline">\(M\)</span> 的秩，表示 <spanclass="math inline">\(M\)</span>的行向量空间的维数（或列向量空间的维数）</li><li><spanclass="math inline">\(\text{nullity}(M)\)</span>：矩阵右核的维数（nullspace 的维数）</li><li><span class="math inline">\(n\)</span>：矩阵列的总数</li></ul><p>结论</p><ul><li>右核的维数（nullity）决定了满足 <span class="math inline">\(M \cdot\mathbf{v} = \mathbf{0}\)</span> 的独立列向量的数量</li><li>若 nullity 是 <span class="math inline">\(k\)</span>，则右核空间有<span class="math inline">\(k\)</span>个线性无关的基向量，满足条件的列向量数量是无穷多的，因为这些基向量可以任意线性组合</li></ul><h5 id="右核矩阵">右核矩阵</h5><p>右核矩阵指的是矩阵的右零空间的一种表示方式，右零空间是指所有使得矩阵与其右边乘积结果为零向量的向量的集合。右核空间的基可以使用sagemath中的<code>right_kernel().basis()</code>函数求出</p><h5 id="例题">例题</h5><p><ahref="https://www.cnblogs.com/L00kback/p/17573063.html">2023巅峰极客Crypto Rosita</a></p><p><ahref="https://blog.csdn.net/qq_41626232/article/details/131861414?spm=1001.2014.3001.5501">巅峰极客2023Crypto Rosita</a></p><h4 id="回到本题">回到本题</h4><p>按照大佬博客中的思路分析这道题，我们现在有 <spanclass="math display">\[a_ip+b_iq=h_i\]</span> 即 <span class="math display">\[\begin{pmatrix}a_i &amp; b_i\end{pmatrix}\begin{pmatrix}p\\\\q\end{pmatrix}=\mathbf{h_i}\]</span> 将100个等式拼接起来 <span class="math display">\[AB_{100\times2}\begin{pmatrix}p\\\\q\end{pmatrix}=H_{100\times1}\]</span> 目标是求短列向量 <span class="math inline">\(A\)</span> 与<span class="math inline">\(B\)</span>，考虑 <spanclass="math inline">\(AB\)</span> 矩阵的正交矩阵，不妨令为 <spanclass="math inline">\(M\)</span>，有 <span class="math display">\[M_{k\times100} \cdot AB_{100\times2}=\mathbf{0}_{k\times2}\]</span> 那么 <span class="math display">\[M_{k\times100} \cdot AB_{100\times2} \cdot\begin{pmatrix}p\\\\q\end{pmatrix}=\mathbf{0}_{k\times1}\]</span> 也就是 <span class="math display">\[M_{k\times100} \cdot H_{100\times1}=\mathbf{0}_{k\times1}\]</span> 因为我们已知的是 <spanclass="math inline">\(H\)</span>，所以要往 <spanclass="math inline">\(H\)</span> 上推导</p><p>得到这个关系之后，我们可以知道</p><ul><li><span class="math inline">\(M\)</span> 与 <spanclass="math inline">\(H\)</span> 正交</li><li><span class="math inline">\(AB\)</span> 的两列均在 <spanclass="math inline">\(M\)</span> 的右核空间中</li><li><span class="math inline">\(AB\)</span> 的两列均是 <spanclass="math inline">\(M\)</span> 的右核空间中的一个短向量</li></ul><p>于是我们要做的就是</p><ul><li>求 <span class="math inline">\(H\)</span> 的 正交矩阵 <spanclass="math inline">\(M\)</span></li><li>对 <span class="math inline">\(M\)</span>的右核空间做格基规约得到最短列</li></ul><p>找到 <span class="math inline">\(M\)</span> 所构造的格是固定的，为<span class="math display">\[\begin{pmatrix}E_{100\times100} &amp; H_{100\times1}\\\\0 &amp; p\end{pmatrix}\]</span> 其中， <span class="math inline">\(E\)</span>是单位矩阵，<span class="math inline">\(H\)</span>是已知条件的列向量，<span class="math inline">\(p\)</span>是曲线的阶</p><p>构造原理如下 <span class="math display">\[\begin{pmatrix}M_{k\times100} &amp; t\end{pmatrix}\begin{pmatrix}E_{100\times100} &amp; H_{100\times1}\\\\0 &amp; p\end{pmatrix}=\begin{pmatrix}M_{k\times100} &amp; 0\end{pmatrix}\]</span> 对构造出来的格做格基规约，就能得到 <spanclass="math display">\[\begin{pmatrix}M_{k\times100} &amp; \mathbf{0}\\\\\mathbf{0} &amp; p\end{pmatrix}\]</span> 为什么构造的格要多一行 <spanclass="math inline">\((\mathbf{0},p)\)</span> ?</p><p>这里规约出的矩阵，只要行向量的最后一个元素为 <spanclass="math inline">\(0\)</span>，就可以作为一行加入到 <spanclass="math inline">\(M\)</span>中，所以我们可以对格的最后一列配上一个大系数，从而保证规约出 <spanclass="math inline">\(0\)</span></p><p>是的，也就是说规出来的矩阵，理想情况下最后一列都会被规约成 <spanclass="math inline">\(0\)</span>，代表了被正交化，但不一定全部会被规约成<span class="math inline">\(0\)</span>，所以需要筛选一下</p><blockquote><p>但是，这里其实可以直接取规出来的前 <spanclass="math inline">\(98\)</span> 行，因为规出来矩阵的秩一定为 <spanclass="math inline">\(98\)</span>，根据上面的秩-零化维数定理可以知道；同时，一定是前<span class="math inline">\(98\)</span>行为正交成功的，这个暂时不知道为什么</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">M = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> L:</span><br><span class="line">    <span class="keyword">if</span>(i[-<span class="number">1</span>] == <span class="number">0</span>):</span><br><span class="line">        M.append(i[:-<span class="number">1</span>])</span><br><span class="line">M = Matrix(ZZ,M)</span><br></pre></td></tr></table></figure><p>接下来对 <span class="math inline">\(M\)</span>的右核空间中再做格基规约即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Ker = M.right_kernel().basis()</span><br><span class="line">Ker = Matrix(ZZ, Ker)</span><br><span class="line">AB = Ker.LLL()</span><br></pre></td></tr></table></figure><p>需要注意的是，规出来的结果是什么？</p><p>实际上找到的是 <span class="math inline">\(B\)</span> 和与 <spanclass="math inline">\(B\)</span> 约减过的 <spanclass="math inline">\(A\)</span>，所以直接用 <spanclass="math inline">\(B\)</span> 可以，但是 <spanclass="math inline">\(A\)</span> 是需要计算的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">B = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">abs</span>, AB[<span class="number">1</span>]))</span><br><span class="line">A = [i+j <span class="keyword">for</span> i,j <span class="keyword">in</span> <span class="built_in">zip</span>(AB[<span class="number">0</span>], B)]</span><br></pre></td></tr></table></figure><p>接下来就和之前一样了，求 <span class="math inline">\(GCD\)</span>即可</p><h4 id="正交格的另一份exp">正交格的另一份exp</h4><p>来自<a href="https://blog.s1um4i.com/2024-QWBCTF/">2024 强网杯部分题解</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">clist = [...]</span><br><span class="line">n, e = (<span class="number">73566307488763122580179867626252642940955298748752818919017828624963832700766915409125057515624347299603944790342215380220728964393071261454143348878369192979087090394858108255421841966688982884778999786076287493231499536762158941790933738200959195185310223268630105090119593363464568858268074382723204344819</span>, <span class="number">65537</span>)</span><br><span class="line">c = <span class="number">30332590230153809507216298771130058954523332140754441956121305005101434036857592445870499808003492282406658682811671092885592290410570348283122359319554197485624784590315564056341976355615543224373344781813890901916269854242660708815123152440620383035798542275833361820196294814385622613621016771854846491244</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gao_ortho</span>(<span class="params">c, N</span>):</span><br><span class="line">    n = <span class="number">100</span></span><br><span class="line">    C = matrix(ZZ, n, <span class="number">1</span>, c)</span><br><span class="line">    C = block_matrix([[identity_matrix(n), C]])</span><br><span class="line">    C = C.LLL()</span><br><span class="line">    C1 = C[:-<span class="number">2</span>, :-<span class="number">1</span>]</span><br><span class="line">    C1 = C1.T.left_kernel().matrix()</span><br><span class="line">    C1 = C1.LLL()</span><br><span class="line">    a0 = C1[<span class="number">0</span>]</span><br><span class="line">    a1 = C1[<span class="number">1</span>]</span><br><span class="line">    c_ = vector(ZZ, c)</span><br><span class="line">    res = C1.solve_left(c_)</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> res:</span><br><span class="line">        <span class="keyword">if</span> N % p == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> p, N // p</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;GG&quot;</span>)</span><br><span class="line"></span><br><span class="line">p, q = gao_ortho(clist, n)</span><br><span class="line">d = inverse(e, (p-<span class="number">1</span>)*(q-<span class="number">1</span>))</span><br><span class="line">m = <span class="built_in">pow</span>(c, d, n)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(m)))</span><br></pre></td></tr></table></figure><p>有空再研究吧</p><h3 id="p.s.">P.S.</h3><p>这道题其实 <span class="math inline">\(4\)</span> 组值就能解</p><p><code>exp2_apbq.sage</code>里改成</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">h = hint2[:<span class="number">4</span>]</span><br><span class="line">nums = <span class="number">2</span></span><br></pre></td></tr></table></figure><p>或<code>exp22_apbq.sage</code>里改成</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">V = hints[:<span class="number">4</span>]</span><br><span class="line">k = <span class="number">2</span>^<span class="number">800</span></span><br></pre></td></tr></table></figure><p>但是<code>exp222_apbq.sage</code>里至少需要 <spanclass="math inline">\(5\)</span> 组</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hint2 = hint2[:<span class="number">5</span>]</span><br></pre></td></tr></table></figure><h2 id="第三段">第三段</h2><h3 id="题解">题解</h3><p>第三段是最nt的...</p><p><img src="1.png" /></p><p>用的是第二段的公私钥</p><h3 id="正解">正解</h3><p>但是这个题也是可以解的</p><p>给的条件是 <span class="math display">\[c_1=ap+q\\c_2=p+bq\]</span> 可以构造模 <span class="math inline">\(n\)</span> 等式 <spanclass="math display">\[(c_1-q)(c_2-p)=0 \bmod n\]</span> 展开有 <span class="math display">\[c_1c_2-c_1p-c_2q=0 \bmod n\]</span> 即 <span class="math display">\[c_1p+c_2q-c_1c_2+kn=0\]</span> 构造格如下 <span class="math display">\[\begin{pmatrix}p &amp; q &amp; 1 &amp; k\end{pmatrix}\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; c_1\\\\0 &amp; 1 &amp; 0 &amp; c_2\\\\0 &amp; 0 &amp; 1 &amp; -c_1c_2\\\\0 &amp; 0 &amp; 0 &amp; n\end{pmatrix}=\begin{pmatrix}p &amp; q &amp; 1 &amp; 0\end{pmatrix}\]</span> 但这个格是做不出来的，正确的格构造如下</p><p><span class="math display">\[\begin{pmatrix}p_h &amp; q_h &amp; 1 &amp; k\end{pmatrix}\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; 2^{brute}\cdot c_1\\\\0 &amp; 1 &amp; 0 &amp; 2^{brute}\cdot c_2\\\\0 &amp; 0 &amp; 2^{512-brute} &amp; c_1i+c_2j-c_1c_2\\\\0 &amp; 0 &amp; 0 &amp; n\end{pmatrix}=\begin{pmatrix}p_h &amp; q_h &amp; 2^{512-brute} &amp; 0\end{pmatrix}\]</span></p><h4 id="为什么要用-p_h-q_h-而不是-p-q">为什么要用 <spanclass="math inline">\(p_h\ q_h\)</span> 而不是 <spanclass="math inline">\(p\ q\)</span> ?</h4><p><span class="math inline">\(p\)</span> 和 <spanclass="math inline">\(q\)</span>均约为512位，比较接近LLL可以规约出来的范围，但稍微长了一点，需要缩短一点</p><p><span class="math display">\[c_1c_2-c_1(2^{brute}p_h+i)-c_2(2^{brute}q_h+j)=0 \bmod n\]</span></p><p><span class="math display">\[2^{brute}c_1p_h+2^{brute}c_2q_h+c_1i+c_2j-c_1c_2+kn=0\]</span></p><h4 id="为什么要用-2512-brute-而不是-1">为什么要用 <spanclass="math inline">\(2^{512-brute}\)</span> 而不是 <spanclass="math inline">\(1\)</span> ？</h4><p>因为规约出来的向量会趋于等长正交，所以如果用一开始的向量 <spanclass="math display">\[\begin{pmatrix}p &amp; q &amp; 1 &amp; 0\end{pmatrix}\]</span> p和q的位数会被“拖累”，变成大概 <spanclass="math inline">\(512*2/3=341\)</span> 位</p><p>所以配一个位数一样的做平衡，经过测试，指数取 <spanclass="math inline">\(508-511\)</span> 都能规出来</p>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> crypto </tag>
            
            <tag> lattice </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WP-[2024.7春秋杯]ezzzecc</title>
      <link href="/2024/07/28/2024%E6%98%A5%E7%A7%8B%E6%9D%AF-ezzzecc/"/>
      <url>/2024/07/28/2024%E6%98%A5%E7%A7%8B%E6%9D%AF-ezzzecc/</url>
      
        <content type="html"><![CDATA[<h1 id="ezzzecc">ezzzecc</h1><p>和[HGAME 2022week4]ECC差不多的一道题，多了两个点，一个是p的解密，一个是k的获取</p><p>先是p的解密，是一个base62+多次base64+多次ROT47，真是逆天...</p><p>原来</p><p><code>koZP3YQAklARRNrmYfjxoKIAXegOcG4jMOmKb08uESOkCCn72d6UM2NWgefYPEMq4EJ1M0jKaqt02Guo5Ubccjqg4QZaaHbScREx38UMLQKwG0LcDd8VFX1zkobc1ZQn4L3DhKQrgJZI55todgOdJuHN532bxScAvOF26gJyQclPtRHn3M6SHrRCEXzzmszd68PJlLB6HaabrRrCW9ZoAYSZetM5jDBtNCJLpR0CBZUUk3Oeh2MZQu2vk8DZ1QqNG49hlxGfawp1FXvAZPdMwixzkhEQnbCDcOKzYyT6BZF2Dfd940tazl7HNOswuIpLsqXQ2h56guGngMeYfMXEZV09fsB3TE0N934CLF8TbZnzFzEkOe8TPTK2mWPVSrgmbsGHnxgYWhaRQWg3yosgDfrEa5qfVl9De41PVtTw024gltovypMXK5XMhuhogs0EMN7hkLapLn6lMj</code></p><p>base62之后</p><p><code>VmpKNFUxTXlVWGRsU0VKcFRXcFdUVmxXVWtOa01VMTZZVE5rYWsxSVVURlpha2t4VXpKR1ZWVnVVbFJOVlRWaFdUSjBkMDVYVFhsTlZYaHNWa1ZLTmxVeU5YTk5NbEpXWlVoQ2EwMHhXazFWVkVrMVpXeE5lbUpJY0d0U1dFSlZWMnBPUTFSV1ZYaGlTRlpWVWxVMGVsa3hWalJXUlRGSVRWVjBWazB3TlRaV1JXUnlUVWRKZDJSSVFrOVRSVXBNVmxST2EyUXhVa2RVYm5CcVZsaG9SVlpzWkRSVVJsVjZWRzVhVkUxdGMzZFpla0l3VGxacmVsUnJkRlpOYldjeA==</code></p><p>多次base64之后</p><p><code>e2p.*'*-)+-,+*'&amp;.&amp;)&amp;+'+&amp;+-,',..,.(*,++-%()-&amp;',,*--&amp;%+,..(*.)%,)-+*,%%)+(*.,+',%(r</code></p><p>ROT47之后得到p</p><p><code>p=&#123;95258468765219141626168727997935766803481277588106799359407486570046359762703&#125;</code></p><p>然后是私钥k的获取，由于这题给了私钥k是18位的，所以可以爆破得到k（所以其实那个k小于1000000的条件没什么用...</p><p>爆破k的sage代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">p = 95258468765219141626168727997935766803481277588106799359407486570046359762703</span><br><span class="line">a = 87425770561190618633288232353256495656281438408946725202136726983601884085917</span><br><span class="line">b = 107879772066707091306779801409109036008421651378615140327877558014536331974777</span><br><span class="line">E = EllipticCurve(GF(p),[a,b])</span><br><span class="line">K = (49293150360761418309411209621405185437426003792008480206387047056777011104939, 43598371886286324285673726736628847559547403221353820773139325027318579443479)</span><br><span class="line">G = (34031022567935512558184471533035716554557378321289293120392294258731566673565, 74331715224220154299708533566163247663094029276428146274456519014761122295496)</span><br><span class="line">for k in range(2^17, 2^19):</span><br><span class="line">    if K == k*G:</span><br><span class="line">        print(k)</span><br><span class="line">        break</span><br></pre></td></tr></table></figure><p>得到k为166909</p><p>得到私钥k，由题有</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c1 = m + r * K</span><br><span class="line">c2 = r * G</span><br></pre></td></tr></table></figure><p>那么有</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m = c1 - k * c2</span><br></pre></td></tr></table></figure><p>求解的sage代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import libnum</span><br><span class="line"></span><br><span class="line">p = 95258468765219141626168727997935766803481277588106799359407486570046359762703</span><br><span class="line">a = 87425770561190618633288232353256495656281438408946725202136726983601884085917</span><br><span class="line">b = 107879772066707091306779801409109036008421651378615140327877558014536331974777</span><br><span class="line">k = 166909</span><br><span class="line">E = EllipticCurve(GF(p),[a,b])</span><br><span class="line">c1 = E(3315847183153421424358678117707706758962521458183324187760613108746362414091, 61422809633368910312843316855658127170184420570309973276760547643460231548014)</span><br><span class="line">c2 = E(12838481482175070256758359669437500951915904121998959094172291545942862161864, 60841550842604234546787351747017749679783606696419878692095419214989669624971)</span><br><span class="line">m = c1 - k * c2</span><br><span class="line">cipher_left = 75142205156781095042041227504637709079517729950375899059488581605798510465939</span><br><span class="line">cipher_right = 61560856815190247060747741878070276409743228362585436028144398174723191051815</span><br><span class="line">print(libnum.n2s(int(cipher_left//m[0])))</span><br><span class="line">print(libnum.n2s(int(cipher_right//m[1])))</span><br></pre></td></tr></table></figure><h2 id="另一种求p的方法">另一种求p的方法</h2><p>已知4个椭圆曲线上的点：<code>K</code>、<code>G</code>、<code>c1</code>、<code>c2</code>，每个点都满足<code>x**3+a*x+b-y**2=kp</code>，故可以通过求gcd来得到p，而且实际上只用两个点就可以得到</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line">a = <span class="number">87425770561190618633288232353256495656281438408946725202136726983601884085917</span></span><br><span class="line">b = <span class="number">107879772066707091306779801409109036008421651378615140327877558014536331974777</span></span><br><span class="line">K = (<span class="number">49293150360761418309411209621405185437426003792008480206387047056777011104939</span>, <span class="number">43598371886286324285673726736628847559547403221353820773139325027318579443479</span>)</span><br><span class="line">G = (<span class="number">34031022567935512558184471533035716554557378321289293120392294258731566673565</span>, <span class="number">74331715224220154299708533566163247663094029276428146274456519014761122295496</span>)</span><br><span class="line">l = K[<span class="number">0</span>] ** <span class="number">3</span> + a * K[<span class="number">0</span>] + b - K[<span class="number">1</span>] ** <span class="number">2</span></span><br><span class="line">w = G[<span class="number">0</span>] ** <span class="number">3</span> + a * G[<span class="number">0</span>] + b - G[<span class="number">1</span>] ** <span class="number">2</span></span><br><span class="line">p = gmpy2.gcd(l, w)</span><br><span class="line"><span class="built_in">print</span>(p)</span><br></pre></td></tr></table></figure><h2 id="另外一种爆破k的方法">另外一种爆破k的方法</h2><p>上面爆破k的方法是用K和G算出k的具体值，其实可以直接爆破，不用关心它的具体值，我们关心的是解出的明文字符串中是否有<code>flag</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line">from Crypto.Util.number import *</span><br><span class="line">from tqdm import tqdm</span><br><span class="line"></span><br><span class="line">a = 87425770561190618633288232353256495656281438408946725202136726983601884085917</span><br><span class="line">b = 107879772066707091306779801409109036008421651378615140327877558014536331974777</span><br><span class="line">K = (49293150360761418309411209621405185437426003792008480206387047056777011104939, 43598371886286324285673726736628847559547403221353820773139325027318579443479)</span><br><span class="line">G = (34031022567935512558184471533035716554557378321289293120392294258731566673565, 74331715224220154299708533566163247663094029276428146274456519014761122295496)</span><br><span class="line"></span><br><span class="line">KK = K[0]^3 + K[0]*a + b - K[1]^2 </span><br><span class="line">GG = G[0]^3 + G[0]*a + b - G[1]^2</span><br><span class="line">p = gmpy2.gcd(KK, GG)</span><br><span class="line">print(p)</span><br><span class="line"></span><br><span class="line">E = EllipticCurve(GF(p),[a,b])</span><br><span class="line">c1 = (3315847183153421424358678117707706758962521458183324187760613108746362414091, 61422809633368910312843316855658127170184420570309973276760547643460231548014)</span><br><span class="line">c2 = (12838481482175070256758359669437500951915904121998959094172291545942862161864, 60841550842604234546787351747017749679783606696419878692095419214989669624971)</span><br><span class="line">cipher_left = 75142205156781095042041227504637709079517729950375899059488581605798510465939</span><br><span class="line">cipher_right = 61560856815190247060747741878070276409743228362585436028144398174723191051815</span><br><span class="line"></span><br><span class="line">c1 = E(c1)</span><br><span class="line">c2 = E(c2)</span><br><span class="line"></span><br><span class="line">for k in tqdm(range(2^17, 2^18)):</span><br><span class="line">    m = c1 - c2*k</span><br><span class="line">    flag1 = long_to_bytes(int(cipher_left // m[0]))</span><br><span class="line">    flag2 = long_to_bytes(int(cipher_right // m[1]))</span><br><span class="line">    flag = flag1 + flag2</span><br><span class="line">    if b&#x27;flag&#x27; in flag:</span><br><span class="line">        print(flag)</span><br><span class="line">        break</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> crypto </tag>
            
            <tag> ecc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Frida-Hook</title>
      <link href="/2024/07/04/Frida-Hook/"/>
      <url>/2024/07/04/Frida-Hook/</url>
      
        <content type="html"><![CDATA[<h1 id="frida-hook">Frida-Hook</h1><h2 id="frida概念">Frida概念</h2><p>Frida是一款开源的动态插桩工具，可以插入一些代码到原生App的内存空间去动态地监视和修改其行为，支持Windows、Mac、Linux、Android或者iOS，从安卓层面来讲，可以实现<code>Java</code>层和<code>Native</code>层<code>Hook</code>操作</p><p>此外，还有一个比较知名的逆向框架，Xposed</p><blockquote><p>Xposed直接编写Java代码，Java层hook方便，可打包模块持久化hook，缺点是环境配置繁琐，兼容性较差，难以Hook底层代码</p><p>Frida配置简单，免重启hook。支持Java层和Native层的hook操作，缺点是持久化hook相对麻烦</p></blockquote><h2 id="frida框架搭建">Frida框架搭建</h2><p>frida框架搭建分为两部分：客户端环境和服务端环境</p><h3 id="客户端">客户端</h3><p>在客户端我们可以编写Python代码，用于连接远程设备，提交要注入的代码到远程，接受服务端的发来的消息等，一般为PC端</p><h4 id="客户端环境配置">客户端环境配置：</h4><p><code>pip install frida</code></p><p><code>pip install frida-tools</code></p><blockquote><p>几点说明：</p><p>（1）通过pip安装的frida是可以跟python绑定的；另外frida现在也已经有了跟nodeJs绑定的版本， 因此也可以直接通过 npm进行安装</p><p>（2）frida-tools模块提供cli命令，和frida-server做交互</p></blockquote><h3 id="服务端">服务端</h3><p>在服务端，我们需要用Javascript代码注入到目标进程，操作内存数据，给客户端发送消息等操作。我们也可以把客户端理解成控制端，服务端理解成被控端，一般为Android设备端</p><h4 id="服务端环境配置">服务端环境配置：</h4><p><a href="https://github.com/frida/frida/releases">下载fridaserver</a>，但是需要注意frida服务端，也就是Android设备CPU的型号，可以用adb查看</p><blockquote><p>adb（Android Debug Bridge）是androidsdk里的一个工具，用这个工具可以直接操作管理android模拟器或者真实的andriod设备，其实就是一个命令行窗口，用于通过电脑端与模拟器或者真实Android设备交互。hook需要提前配好adb的环境</p></blockquote><p>adb查看手机CPU型号</p><p><code>adb shell getprop ro.product.cpu.abi</code></p><p>下载对应的服务端，解压</p><p><img src="image-20240620191053433.png" /></p><p>将解压后的服务端推到手机的/data/local/tmp目录</p><p><code>adb push frida-server-16.3.3-android-x86_64 /data/local/tmp</code></p><blockquote><p>可能出现的问题：</p><p><strong>remote secure_mkdirs failed: Permissiondenied</strong>：即权限不足，先<code>adb root</code>以root身份启动adb，再推即可</p></blockquote><p>将Android设备上的frida-server添加执行权，并运行该程序(需要root权限)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line"><span class="built_in">cd</span> /data/local/tmp</span><br><span class="line">su</span><br><span class="line"><span class="built_in">chmod</span> 777 frida-server-16.3.3-android-x86_64</span><br></pre></td></tr></table></figure><blockquote><p>可能出现的问题：</p><p><strong>su时Permissiondenied</strong>：无root权限，需要服务端，也就是Android设备，一般为模拟器或真机，打开root权限</p><p><img src="image-20240620195637134.png" /></p><p>另外，例如面具Magisk等软件可能也会影响</p></blockquote><p>此外，也可以直接通过模拟器直接往服务端传入server并赋予权限</p><h3 id="hook具体步骤">Hook具体步骤</h3><p>服务端启动server服务，还是通过adb进入服务端启动frida-server</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line"><span class="built_in">cd</span> /data/local/tmp</span><br><span class="line">su</span><br><span class="line">./frida-server-16.3.3-android-x86_64</span><br></pre></td></tr></table></figure><p>同时可以打开frida日志捕获</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logcat | grep <span class="string">&quot;D.zj2595&quot;</span></span><br></pre></td></tr></table></figure><p>然后在客户端即可启动frida进行hook，frida的具体用法可以参考<code>frida --help</code></p><h2 id="frida基础知识">Frida基础知识</h2><h3 id="frida的6个工具">frida的6个工具</h3><blockquote><p>fridaCLI：一个交互式解释器（REPL），交互形式与IPython类似，可以通过命令行交互</p><p>frida-ps: 用于列出进程的一个命令行工具，frida-ps -U查看当前手机运行的进程</p><p>frida-trace, frida-discover, frida-ls-devices,frida-kill：不常用，见<ahref="https://frida.re/docs/home/">官方文档</a></p></blockquote><h3 id="操作模式">操作模式</h3><table><colgroup><col style="width: 8%" /><col style="width: 31%" /><col style="width: 31%" /><col style="width: 27%" /></colgroup><thead><tr><th style="text-align: left;">操作模式</th><th style="text-align: left;">描述</th><th style="text-align: left;">优点</th><th style="text-align: left;">主要用途</th></tr></thead><tbody><tr><td style="text-align: left;">CLI（命令行）模式</td><tdstyle="text-align: left;">通过命令行直接将JavaScript脚本注入进程中，对进程进行操作</td><td style="text-align: left;">便于直接注入和操作</td><tdstyle="text-align: left;">在较小规模的操作或者需求比较简单的场景中使用</td></tr><tr><td style="text-align: left;">RPC模式</td><tdstyle="text-align: left;">使用Python进行JavaScript脚本的注入工作，实际对进程进行操作的还是JavaScript脚本，可以通过RPC传输给Python脚本来进行复杂数据的处理</td><tdstyle="text-align: left;">在对复杂数据的处理上可以通过RPC传输给Python脚本来进行，有利于减少被注入进程的性能损耗</td><tdstyle="text-align: left;">在大规模调用中更加普遍，特别是对于复杂数据处理的需求</td></tr></tbody></table><h3 id="注入模式与启动命令">注入模式与启动命令:</h3><table><colgroup><col style="width: 4%" /><col style="width: 24%" /><col style="width: 24%" /><col style="width: 24%" /><col style="width: 23%" /></colgroup><thead><tr><th style="text-align: left;">注入模式</th><th style="text-align: left;">描述</th><th style="text-align: left;">命令或参数</th><th style="text-align: left;">优点</th><th style="text-align: left;">主要用途</th></tr></thead><tbody><tr><td style="text-align: left;">Spawn模式</td><tdstyle="text-align: left;">将启动App的权利交由Frida来控制，即使目标App已经启动，在使用Frida注入程序时还是会重新启动App</td><td style="text-align: left;">在CLI模式中，Frida通过加上 -f参数指定包名以spawn模式操作App</td><tdstyle="text-align: left;">适合于需要在App启动时即进行注入的场景，可以在App启动时即捕获其行为</td><tdstyle="text-align: left;">当需要监控App从启动开始的所有行为时使用</td></tr><tr><td style="text-align: left;">Attach模式</td><tdstyle="text-align: left;">在目标App已经启动的情况下，Frida通过ptrace注入程序从而执行Hook的操作</td><td style="text-align: left;">在CLI模式中，如果不添加 -f参数，则默认会通过attach模式注入App</td><tdstyle="text-align: left;">适合于已经运行的App，不会重新启动App，对用户体验影响较小</td><tdstyle="text-align: left;">在App已经启动，或者我们只关心特定时刻或特定功能的行为时使用</td></tr></tbody></table><p>Spawn模式</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f 进程名 -l hook.js</span><br></pre></td></tr></table></figure><p>Attach模式</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U 进程名 -l hook.js</span><br></pre></td></tr></table></figure><p>frida-server自定义端口</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./frida-server-16.3.3-android-x86_64 -l 0.0.0.0:6666</span><br></pre></td></tr></table></figure><p>frida日志捕获</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logcat | grep <span class="string">&quot;D.zj2595&quot;</span>//D表示调试级别，后面是过滤标签</span><br></pre></td></tr></table></figure><p>模拟器端口转发</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb connect <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:端口号</span><br></pre></td></tr></table></figure><h3 id="基础语法">基础语法</h3><table><colgroup><col style="width: 47%" /><col style="width: 52%" /></colgroup><thead><tr><th style="text-align: left;">API名称</th><th style="text-align: left;">描述</th></tr></thead><tbody><tr><td style="text-align: left;"><code>Java.use(className)</code></td><tdstyle="text-align: left;">获取指定的Java类并使其在JavaScript代码中可用。</td></tr><tr><td style="text-align: left;"><code>Java.perform(callback)</code></td><td style="text-align: left;">确保回调函数在Java的主线程上执行。</td></tr><tr><tdstyle="text-align: left;"><code>Java.choose(className, callbacks)</code></td><td style="text-align: left;">枚举指定类的所有实例。</td></tr><tr><td style="text-align: left;"><code>Java.cast(obj, cls)</code></td><tdstyle="text-align: left;">将一个Java对象转换成另一个Java类的实例。</td></tr><tr><tdstyle="text-align: left;"><code>Java.enumerateLoadedClasses(callbacks)</code></td><td style="text-align: left;">枚举进程中已经加载的所有Java类。</td></tr><tr><tdstyle="text-align: left;"><code>Java.enumerateClassLoaders(callbacks)</code></td><td style="text-align: left;">枚举进程中存在的所有Java类加载器。</td></tr><tr><tdstyle="text-align: left;"><code>Java.enumerateMethods(targetClassMethod)</code></td><td style="text-align: left;">枚举指定类的所有方法。</td></tr></tbody></table><h3 id="日志输出语法区别">日志输出语法区别</h3><table><colgroup><col style="width: 11%" /><col style="width: 40%" /><col style="width: 47%" /></colgroup><thead><tr><th style="text-align: left;">日志方法</th><th style="text-align: left;">描述</th><th style="text-align: left;">区别</th></tr></thead><tbody><tr><td style="text-align: left;"><code>console.log()</code></td><td style="text-align: left;">使用JavaScript直接进行日志打印</td><tdstyle="text-align: left;">多用于在CLI模式中，<code>console.log()</code>直接输出到命令行界面，使用户可以实时查看。在RPC模式中，<code>console.log()</code>同样输出在命令行，但可能被Python脚本的输出内容掩盖。</td></tr><tr><td style="text-align: left;"><code>send()</code></td><tdstyle="text-align: left;">Frida的专有方法，用于发送数据或日志到外部Python脚本</td><tdstyle="text-align: left;">多用于RPC模式中，它允许JavaScript脚本发送数据到Python脚本，Python脚本可以进一步处理或记录这些数据。</td></tr></tbody></table><h3 id="hook框架模板">Hook框架模板</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//自定义的hook函数</span></span><br><span class="line">        <span class="title function_">hookTest1</span>();</span><br><span class="line">    &#125;); </span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure><h2 id="frida常用api">Frida常用API</h2><h3id="hook普通方法打印参数和修改返回值">1.Hook普通方法、打印参数和修改返回值</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个名为hookTest1的函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//获取一个名为&quot;类名&quot;的Java类，并将其实例赋值给JavaScript变量utils</span></span><br><span class="line">    <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;类名&quot;</span>);</span><br><span class="line">    <span class="comment">//修改&quot;类名&quot;的&quot;method&quot;方法的实现。这个新的实现会接收两个参数（a和b）</span></span><br><span class="line">    utils.<span class="property">method</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a, b</span>)&#123;</span><br><span class="line">        <span class="comment">//将参数a和b的值改为123和456。</span></span><br><span class="line">        a = <span class="number">123</span>;</span><br><span class="line">        b = <span class="number">456</span>;</span><br><span class="line">        <span class="comment">//调用修改过的&quot;method&quot;方法，并将返回值存储在`retval`变量中</span></span><br><span class="line">        <span class="keyword">var</span> retval = <span class="variable language_">this</span>.<span class="title function_">method</span>(a, b);</span><br><span class="line">        <span class="comment">//在控制台上打印参数a，b的值以及&quot;method&quot;方法的返回值</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, retval);</span><br><span class="line">        <span class="comment">//返回&quot;method&quot;方法的返回值</span></span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="hook重载参数">Hook重载参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .overload()</span></span><br><span class="line"><span class="comment">// .overload(&#x27;自定义参数&#x27;)</span></span><br><span class="line"><span class="comment">// .overload(&#x27;int&#x27;)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">    <span class="comment">//overload定义重载函数，根据函数的参数类型填</span></span><br><span class="line">    <span class="comment">//这里的Animal是自定义参数类型，需要去smali代码里找定义 </span></span><br><span class="line">    utils.<span class="property">Inner</span>.<span class="title function_">overload</span>(<span class="string">&#x27;com.zj.wuaipojie.Demo$Animal&#x27;</span>,<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a，b</span>)&#123;</span><br><span class="line">        b = <span class="string">&quot;aaaaaaaaaa&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title class_">Inner</span>(a,b);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="hook构造函数">Hook构造函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest3</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">    <span class="comment">//修改类的构造函数的实现，$init表示构造函数</span></span><br><span class="line">    utils.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">str</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(str);</span><br><span class="line">        str = <span class="string">&quot;52&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.$init(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="hook字段">Hook字段</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest5</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//静态字段的修改</span></span><br><span class="line">        <span class="keyword">var</span> utils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">        <span class="comment">//修改类的静态字段&quot;flag&quot;的值</span></span><br><span class="line">        utils.<span class="property">staticField</span>.<span class="property">value</span> = <span class="string">&quot;我是被修改的静态变量&quot;</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(utils.<span class="property">staticField</span>.<span class="property">value</span>);</span><br><span class="line">        <span class="comment">//非静态字段的修改</span></span><br><span class="line">        <span class="comment">//使用`Java.choose()`枚举类的所有实例</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">                <span class="comment">//修改实例的非静态字段&quot;_privateInt&quot;的值为&quot;123456&quot;，并修改非静态字段&quot;privateInt&quot;的值为9999。</span></span><br><span class="line">                obj.<span class="property">_privateInt</span>.<span class="property">value</span> = <span class="string">&quot;123456&quot;</span>; <span class="comment">//字段名与函数名相同 前面加个下划线</span></span><br><span class="line">                obj.<span class="property">privateInt</span>.<span class="property">value</span> = <span class="number">9999</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="hook内部类">Hook内部类</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest6</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//内部类</span></span><br><span class="line">        <span class="keyword">var</span> innerClass = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.zj.wuaipojie.Demo$innerClass&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(innerClass);</span><br><span class="line">        innerClass.<span class="property">$init</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;eeeeeeee&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="枚举所有的类与类的所有方法">枚举所有的类与类的所有方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest7</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//枚举所有的类与类的所有方法,异步枚举</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateLoadedClasses</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">name,handle</span>)&#123;</span><br><span class="line">                <span class="comment">//过滤类名</span></span><br><span class="line">                <span class="keyword">if</span>(name.<span class="title function_">indexOf</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">                    <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(name);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(clazz);</span><br><span class="line">                    <span class="keyword">var</span> methods = clazz.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(methods);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="枚举所有方法">枚举所有方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookTest8</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Demo</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>);</span><br><span class="line">        <span class="comment">//getDeclaredMethods枚举所有方法</span></span><br><span class="line">        <span class="keyword">var</span> methods = <span class="title class_">Demo</span>.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>; j &lt; methods.<span class="property">length</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">var</span> methodName = methods[j].<span class="title function_">getName</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(methodName);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> k=<span class="number">0</span>; k&lt;<span class="title class_">Demo</span>[methodName].<span class="property">overloads</span>.<span class="property">length</span>; k++)&#123;</span><br><span class="line">                <span class="title class_">Demo</span>[methodName].<span class="property">overloads</span>[k].<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="variable language_">arguments</span>.<span class="property">length</span>;i++)&#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">this</span>[methodName].<span class="title function_">apply</span>(<span class="variable language_">this</span>,<span class="variable language_">arguments</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="主动调用">主动调用</h3><p>静态方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">ClassName</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>); </span><br><span class="line"><span class="title class_">ClassName</span>.<span class="title function_">privateFunc</span>(<span class="string">&quot;传参&quot;</span>);</span><br></pre></td></tr></table></figure><p>非静态方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ret = <span class="literal">null</span>;</span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.zj.wuaipojie.Demo&quot;</span>,&#123;    <span class="comment">//要hook的类</span></span><br><span class="line">        <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            ret=instance.<span class="title function_">privateFunc</span>(<span class="string">&quot;aaaaaaa&quot;</span>); <span class="comment">//要hook的方法</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//console.log(&quot;result: &quot; + ret);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//return ret;</span></span><br></pre></td></tr></table></figure><p><img src="1854922-20210928094645988-515545896.png" /></p><p><img src="1854922-20210928095039500-1584613007.png" /></p><h2 id="参考文章">参考文章</h2><p><ahref="https://www.cnblogs.com/andy0816/p/15178704.html">安卓逆向6，frida逆向框架介绍，基础开发hookjava层，进阶开发hook native层，hook 加密类</a></p><p><ahref="https://www.52pojie.cn/thread-1823118-1-1.html">安卓逆向这档事》十三、是时候学习一下Frida一把梭了(上)</a></p><p><ahref="详解Hook框架frida，让你在逆向工作中效率成倍提升">详解Hook框架frida，让你在逆向工作中效率成倍提升</a></p>]]></content>
      
      
      <categories>
          
          <category> reverse笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hook </tag>
            
            <tag> Frida </tag>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>符号执行与angr</title>
      <link href="/2024/03/28/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E4%B8%8Eangr/"/>
      <url>/2024/03/28/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E4%B8%8Eangr/</url>
      
        <content type="html"><![CDATA[<h1 id="符号执行与angr">符号执行与<code>angr</code></h1><h2 id="符号执行">符号执行</h2><p>符号执行（SymbolicExecution）是一种程序分析技术，可以通过静态分析程序来得到让特定代码区域执行的输入。同时，它是一种白盒的静态分析技术，即分析程序可能的输入需要能够获取到目标源代码的支持。</p><p>使用符号执行分析一个程序时，会使用符号值作为输入，而非一般执行程序时使用的具体值。笔者在学习的时候，感觉可以类比成概率论中的离散随机变量或者离散数学中的事件。在达到目标代码时，分析器可以得到相应的路径约束，然后通过约束求解器来得到可以触发目标代码的具体值。</p><h2 id="angr"><code>angr</code></h2><h3 id="简介">简介</h3><p><code>angr</code>是一个多架构二进制分析工具包，具有执行动态符号执行（如Mayhem、KLEE等）和对二进制文件进行各种静态分析的能力，是目前最好用的符号执行引擎之一，是逆向辅助分析的神器。</p><p>符号执行有两个基础：执行路径和符号，以下通过这两方面来学习。</p><p>执行路径：当程序读取文件的时候，我们需要将文件进行符号向量化当作我们的输入。我们需要创建一个<code>SimFile</code>对象，该对象是个模拟文件，然后将符号变量存放在模拟文件中并将模拟文件插入到<code>state</code>中，这样在模拟运行时，程序就会从我们模拟的文件中读取符号变量作为输入的参数进行后续的运行。</p><p>符号：当用户输入是从标准输入（<code>stdin</code>）中获得，比如简单调用<code>scanf</code>函数的时候，<code>angr</code>会自动注入符号进行符号化；然而，当用户输入更复杂，比如<code>scanf</code>函数的格式化字符串很复杂，或者从文件、网络或者UI中获取输入的时候，<code>angr</code>则不会自动注入符号，这时我们需要手动在需要的地方进行注入符号。<code>angr</code>中的符号是由<code>bitvector</code>（位向量）表示的，这一点与<code>z3</code>约束求解器类似，其实<code>angr</code>与<code>z3</code>在笔者看来有很多类似之处，都可以进行约束条件下的问题求解。</p><p>Angr其实并不是真正被运行起来的，它就向一个虚拟机，会读取每一条命令并在虚拟机中模拟该命令的行为。我们类比到更加常用的z3 库中，每个寄存器都可以相当与 z3中的一个变量，在模拟执行的过程中，这个变量会被延伸为一个表达式，而当我们成功找到了目标地址之后，通过表达式就可以求解对应的初值应该是什么了。</p><h3 id="安装">安装</h3><p>这里提供的是<code>docoker</code>安装方式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#拉取docker镜像（注意名字是angr/angr）</span></span><br><span class="line">docker pull angr/angr</span><br><span class="line"><span class="comment">#两种方式与本地进行交互，一种是把本地的一个文件夹映射到容器的/angr，如下</span></span><br><span class="line">docker run -it -v 本地文件夹路径:/angr angr/angr</span><br><span class="line"><span class="comment">#另一种是把本地文件cp到容器中的/angr，如下</span></span><br><span class="line">docker <span class="built_in">cp</span> 本地文件路径 容器<span class="built_in">id</span>或名字:/angr</span><br><span class="line"><span class="comment">#同理，也可以把容器/angr下的文件cp到本地</span></span><br><span class="line">docker <span class="built_in">cp</span> 容器<span class="built_in">id</span>或名字:/angr 本地文件路径</span><br><span class="line"><span class="comment">#进入容器环境</span></span><br><span class="line">docker <span class="built_in">exec</span> -it 容器<span class="built_in">id</span> bash</span><br></pre></td></tr></table></figure><h3 id="在ctf中的应用">在ctf中的应用</h3><h4 id="简单re题">简单re题</h4><p>笔者学习<code>angr</code>主要是在ctf逆向题中应用，所以也没有深学，简单学习了一下流程，看了几位大佬的博客，主要掌握流程脚本</p><p><code>angr</code>的一般流程，一把梭</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">project = angr.Project(path_to_binary, auto_load_libs=<span class="literal">False</span>)    <span class="comment"># 加载程序，注意第一个参数是文件路径，不是文件名</span></span><br><span class="line">state = project.factory.entry_state()       <span class="comment"># 创建一个状态,默认为程序的入口地址</span></span><br><span class="line">simgr = project.factory.simgr(state)      <span class="comment"># 创建一个模拟器用来模拟程序执行,遍历所有路径</span></span><br><span class="line">simgr.explore(find=addr_1,avoid=addr_2)   <span class="comment"># 约束执行的流程，addr1为预期执行地址，addr2为避免地址（avoid不一定有）</span></span><br><span class="line"><span class="built_in">print</span>(simgr.found[<span class="number">0</span>].posix.dumps(<span class="number">0</span>))      <span class="comment">#打印结果</span></span><br></pre></td></tr></table></figure><h4 id="反ollvm">反<code>OLLVM</code></h4><p>笔者也是学到一半才想到，之前在学习<code>OLLVM</code>的时候用的反混淆工具<code>deflat</code>就是基于<code>angr</code>框架的，拍脑袋一想，还真是~</p><p>符号执行不是就是去除控制流平坦化的绝佳办法之一吗！</p><p>利用<code>angr</code>符号执行去除控制流平坦化的步骤可以归结为三个步骤：</p><ol type="1"><li>静态分析CFG得到序言/入口块（Prologue）、主分发器（Maindispatcher）、子分发器/无用块（Sub dispatchers）、真实块（Relevantblocks）、预分发器（Predispatcher）和返回块（Return）</li><li>利用符号执行恢复真实块的前后关系，重建控制流</li><li>根据第二步重建的控制流Patch程序，输出恢复后的可执行文件</li></ol><h4 id="vm"><code>VM</code></h4><p>如果<code>VM</code>题目的算法逻辑比较简单，可以考虑直接用<code>angr</code>一把梭，但也不是全能的，如果出题人有意设置陷阱例如构造陷阱循环递归、有意复杂化控制流可能导致路径爆炸等问题，超出了符号执行可以解决的能力范围，这个时候还是老老实实手搓吧~</p><h3 id="流程原理介绍搬的佬-的博客原文">*流程原理介绍(搬的佬的博客原文)</h3><h4 id="创建project">创建Project</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path_to_binary = <span class="string">&quot;./00_angr_find&quot;</span> </span><br><span class="line">project = angr.Project(path_to_binary, auto_load_libs=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>使用angr的首要步骤就是创建Project加载二进制文件。angr的二进制装载组件是CLE，它负责装载二进制对象（以及它依赖的任何库）和把这个对象以易于操作的方式交给angr的其他组件。angr将这些包含在Project类中。一个Project类是代表了你的二进制文件的实体。你与angr的大部分操作都会经过它</p><p>auto_load_libs设置是否自动载入依赖的库，在基础题目中我们一般不需要分析引入的库文件，这里设置为否</p><blockquote><ul><li>如果<code>auto_load_libs</code>是<code>True</code>（默认值），真正的库函数会被执行。这可能正是也可能不是你想要的，取决于具体的函数。比如说一些libc的函数分析起来过于复杂并且很有可能引起path对其的尝试执行过程中的state数量的爆炸增长</li><li>如果<code>auto_load_libs</code>是<code>False</code>，且外部函数是无法找到的，并且Project会将它们引用到一个通用的叫做<code>ReturnUnconstrained</code>的<code>SimProcedure</code>上去，它就像它的名字所说的那样：它返回一个不受约束的值</li></ul></blockquote><h4 id="设置-state">设置 state</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initial_state = project.factory.entry_state()</span><br></pre></td></tr></table></figure><p>state代表程序的一个实例镜像，模拟执行某个时刻的状态，就类似于<strong>快照</strong>。保存运行状态的上下文信息，如内存/寄存器等,我们这里使用<code>project.factory.entry_state()</code>告诉符号执行引擎从程序的入口点开始符号执行，除了使用<code>.entry_state()</code>创建 state 对象, 我们还可以根据需要使用其他构造函数创建 state</p><h4 id="设置-simulation-managers">设置 Simulation Managers</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation = project.factory.simgr(initial_state)</span><br></pre></td></tr></table></figure><p>Project对象仅表示程序一开始的样子，而在执行时，我们实际上是对SimState对象进行操作，它代表程序的一个实例镜像，模拟执行某个时刻的状态</p><p><code>SimState</code>对象包含程序运行时信息，如内存/寄存器/文件系统数据等。SM（SimulationManagers）是angr中最重要的控制接口，它使你能够同时控制一组状态(state)的符号执行，应用搜索策略来探索程序的状态空间。</p><h4 id="运行探索满足路径需要的值">运行，探索满足路径需要的值</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print_good_address = <span class="number">0x8048678</span>  </span><br><span class="line">simulation.explore(find=print_good_address)</span><br></pre></td></tr></table></figure><p>符号执行最普遍的操作是找到能够到达某个地址的状态，同时丢弃其他不能到达这个地址的状态。SM为使用这种执行模式提供了<code>.explore()</code>方法</p><p>当使用<code>find</code>参数启动<code>.explore()</code>方法时，程序将会一直执行，直到发现了一个和<code>find</code>参数指定的条件相匹配的状态。<code>find</code>参数的内容可以是想要执行到的某个地址、或者想要执行到的地址列表、或者一个获取state作为参数并判断这个state是否满足某些条件的函数。当<code>active</code>stash中的任意状态和<code>find</code>中的条件匹配的时候，它们就会被放到<code>found stash</code>中，执行随即停止。之后你可以探索找到的状态，或者决定丢弃它，转而探索其它状态。</p><h4 id="获取执行结果">获取执行结果</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]  <span class="comment"># 获取通过 explore 找到符合条件的状态</span></span><br><span class="line">        solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Success! Solution is: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution.decode(<span class="string">&quot;utf-8&quot;</span>)))</span><br></pre></td></tr></table></figure><p>此时相关的状态已经保存在了<code>simgr</code>当中，我们可以通过<code>simgr.found</code>来访问所有符合条件的分支，这里我们为了解题，就选择第一个符合条件的分支即可</p><p>这里解释一下<code>sys.stdin.fileno()</code>,在UNIX中，按照惯例，三个文件描述符分别表示标准输入、标准输出和标准错误</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.stdin.fileno()</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.stdout.fileno()</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.stderr.fileno()</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure><p>所以一般也可以写成：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">solution = solution_state.posix.dumps(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><h4 id="例题">例题</h4><h5 id="网鼎杯-2020-青龙组singal">[网鼎杯 2020 青龙组]singal</h5><p><img src="image-20240322224806843.png" /></p><p><code>main</code>函数逻辑简单，就是一个虚拟机逆向函数</p><p>找一下<code>find</code>和<code>avoid</code></p><p><img src="image-20240322225301783.png" /></p><p>整个<code>vm_operad</code>函数只有这一处<code>return</code>，猜测是正确输出</p><p><img src="image-20240322225356421.png" /></p><p><code>find</code>的地址是<code>0x40175E</code>，或者选择<code>main</code>函数中<code>puts</code>的地址也可</p><p><img src="image-20240322225711232.png" /></p><p><img src="image-20240322225759329.png" /></p><p><code>avoid</code>的地址是<code>0x4016E6</code></p><p><code>angr</code>一把梭</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">project = angr.Project(<span class="string">&#x27;./signal.exe&#x27;</span>, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line">state = project.factory.entry_state()</span><br><span class="line">simgr = project.factory.simgr(state)</span><br><span class="line">simgr.explore(find=<span class="number">0x40175E</span>,avoid=<span class="number">0x4016E6</span>)</span><br><span class="line"><span class="built_in">print</span>(simgr.found[<span class="number">0</span>].posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure><p><img src="image-20240322225927809.png" /></p><h5 id="nkctf2024reez">[nkctf2024]REEZ</h5><p><img src="image-20240328124939161.png" /></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">project = angr.Project(<span class="string">&#x27;./outputfile&#x27;</span>, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line">state = project.factory.entry_state()</span><br><span class="line">simgr = project.factory.simgr(state)</span><br><span class="line">simgr.explore(find=<span class="keyword">lambda</span> s: <span class="string">b&quot;What can I say? You are so great!&quot;</span> <span class="keyword">in</span> s.posix.dumps(<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(simgr.found[<span class="number">0</span>].posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure><p>注意<code>explore</code>的条件不是地址，这个题没法用地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simgr.explore(find=<span class="keyword">lambda</span> s: <span class="string">b&quot;What can I say? You are so great!&quot;</span> <span class="keyword">in</span> s.posix.dumps(<span class="number">1</span>))</span><br></pre></td></tr></table></figure><p>以下是chat给的各个参数的解释</p><p>让我们逐个解释这段代码中的各个参数的含义：</p><ol type="1"><li><code>simgr</code>: 这很可能是一个符号执行管理器（Symbolic ExecutionManager）的实例，用于管理符号执行过程中的状态和路径。</li><li><code>explore()</code>:这是符号执行管理器中的一个方法，用于探索程序的不同路径。</li><li><code>find=lambda s: b"What can I say? You are so great!" in s.posix.dumps(1)</code>:这是 <code>explore()</code>方法的参数，是一个函数，用于指定符号执行时的条件。在这里，<code>lambda s: ...</code>是一个匿名函数，<code>s</code> 是符号执行状态的一个变量。条件<code>b"What can I say? You are so great!" in s.posix.dumps(1)</code>指定了当符号执行状态 <code>s</code>的标准输出中包含特定字符串时停止探索。<ul><li><code>s</code>: 符号执行状态，代表程序执行过程中的一个状态。</li><li><code>s.posix.dumps(1)</code>: 这部分是获取符号执行状态<code>s</code> 的标准输出的内容。在这里，<code>1</code>表示标准输出文件描述符（stdout），<code>s.posix.dumps(1)</code>返回标准输出的内容作为一个字节串。</li><li><code>b"What can I say? You are so great!" in s.posix.dumps(1)</code>:这部分是条件，表示当特定字符串存在于标准输出中时，停止探索。</li></ul></li></ol><h5 id="有参数脚本">有参数脚本</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line">proj = angr.Project(<span class="string">&#x27;./angr2&#x27;</span>, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line">argv1 = claripy.BVS(<span class="string">&quot;argv1&quot;</span>, <span class="number">9</span> * <span class="number">8</span>) // 这里用的单位是bit, 因此需要乘以<span class="number">8</span></span><br><span class="line">state = proj.factory.entry_state(args=[<span class="string">&#x27;./angr2&#x27;</span>, argv1]) // 导入参数</span><br><span class="line">simgr = proj.factory.simgr(state)</span><br><span class="line"><span class="built_in">print</span>(simgr.explore(find=<span class="number">0x4007DC</span>, avoid=<span class="number">0x4007EA</span>))</span><br><span class="line"><span class="built_in">print</span>(simgr.found[<span class="number">0</span>].solver.<span class="built_in">eval</span>(argv1, cast_to=<span class="built_in">bytes</span>)) // 直接输出是<span class="built_in">ascii</span>码, 用cast_to=<span class="built_in">bytes</span>转为<span class="built_in">bytes</span>类型</span><br></pre></td></tr></table></figure><h2 id="约束求解">约束求解</h2><h3 id="smt"><code>SMT</code></h3><p>前面说了这么多，其实没有提到，如何求解约束条件下的问题呢？<code>SMT</code>就是重要的原理方法之一，<code>z3</code>、<code>ida</code>的<code>Ponce</code>插件就是用的<code>SMT</code>。</p><p><code>SAT</code>（satisfiability）问题指的是命题逻辑公式的可满足性问题。但是<code>SAT</code> 在表达能力上有很大的局限性，需要比<code>SAT</code>更强的表达方式。在这种形势下，将<code>SAT</code>问题扩展为<code>SMT</code>，经过扩展，<code>SMT</code>能比<code>SAT</code>更好地表达一些人工智能和形式化方法领域内的问题，比如在资源规划、时序推理、编译器优化等很多方面用到了<code>SMT</code>。</p><p><code>SMT</code> 的全称是 Satisfiability ModuloTheories，可被翻译为“可满足性模理论”、“多理论下的可满足性问题”或者“特定（背景）理论下的可满足性问题”，其判定算法被称为<code>SMT</code> 求解器。简单地说，一个<code>SMT</code>公式是结合了理论背景的逻辑公式，其中的命题变量可以代表理论公式。</p><h2 id="结语">结语</h2><p>本文非原创，前面也提到，笔者是学习re的过程中来了解一下的，主要是摘录了几位大佬的博客，详细内容没有学习完全，在这里附上链接:</p><p><ahref="https://bbs.kanxue.com/thread-264878.htm">[原创]angr学习（二）-符号执行与angr_ctf_00/01/02</a></p><p><a href="https://www.wangan.com/p/11v74d3c17b0eae9">Angr使用技巧速通笔记</a></p><p><ahref="https://ylcao.top/2022/05/10/%E5%85%A5%E9%97%A8angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E6%A1%86%E6%9E%B6/">入门angr符号执行框架</a></p><p><a href="https://zhuanlan.zhihu.com/p/623524832">Angr使用技巧速通笔记</a></p><p><ahref="https://bluesadi.me/0x401RevTrain-Tools/angr/10_%E5%88%A9%E7%94%A8angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%8E%BB%E9%99%A4%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/">利用angr符号执行去除控制流平坦化</a></p><p><ahref="https://www.anquanke.com/post/id/212816">Angr_CTF从入门到精通</a></p>]]></content>
      
      
      <categories>
          
          <category> reverse笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> angr </tag>
            
            <tag> 符号执行 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>花指令</title>
      <link href="/2024/01/27/%E8%8A%B1%E6%8C%87%E4%BB%A4/"/>
      <url>/2024/01/27/%E8%8A%B1%E6%8C%87%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h1 id="花指令">花指令</h1><h2 id="概念">概念</h2><p>花指令，<code>junk code</code>，也就是垃圾代码。实际上花指令的确是一些不影响程序逻辑的垃圾机器码，它存在的唯一意义就是干扰反汇编引擎和人为分析</p><p>花指令在真实代码中插入一些垃圾代码的同时还保证原有程序的正确执行，而程序无法很好地反编译，难以理解程序内容，达到混淆视听的效果，因此在程序的静态分析对抗中可以起到效果（也包括使re题变复杂</p><h2 id="分类">分类</h2><p>花指令大致可以分为可执行花指令和不可执行花指令两类</p><h3 id="可执行花指令">可执行花指令</h3><p>可执行的花指令本质是将指令的组成部分重新解释执行，这种花指令可以破坏反编译的分析,使得栈指针在反编译引擎中出现异常</p><h3 id="不可执行花指令">不可执行花指令</h3><p>这种花指令本质上是在跳转指令之后插入一个多字节指令的字节，欺骗反汇编器将这个字节之后的几个字节当成一个多字节指令解释，进而造成后续指令反汇编出错，而这部分花指令代码在程序的正常执行过程中不会被执行</p><h2 id="构造与patch">构造与patch</h2><h3 id="反汇编算法">反汇编算法</h3><p>常见的反汇编算法有两类，一类是线性扫描反汇编，对输入的数据逐字节翻译成汇编代码，因此简单地在<code>jmp</code>后插入<code>0xe8</code>（<code>0xe8</code>是<code>call</code>指令的机器码）就能骗到</p><p>另一类是递归下降反汇编，是一种基于控制流分析的算法，这类算法优先反汇编可达的代码，例如IDA。针对这类算法，可以通过设置永真或者永假条件，导致程序一定会执行，因为ida反汇编会优先反汇编接下去的部分（false分支）</p><p>其它更加详尽的花指令构造方法，这里引路<ahref="https://nnnewb.github.io/blog/p/learning-packer-07/">大佬的文章</a></p><h3 id="构造案例">构造案例</h3><p>我在学习花指令知识时看到的一个<ahref="https://www.anquanke.com/post/id/208682#h3-5">很好的例子</a></p><h3 id="patch的方法-nop">patch的方法-NOP</h3><p><img src="image-20240125203811902.png" /></p><p>上图是一个典型的不可执行花指令（<code>call</code>指令的地址不存在），而且这里就是我们上面提到的经典的在<code>jmp</code>后插入<code>0xe8</code>构造花指令的方法，我们将两条指令化为机器码看得更清楚（右键Undifine或快捷键U）</p><p><img src="image-20240125204212095.png" /></p><p><code>0x75</code>是<code>jnz</code>的机器码，<code>0xe8</code>是<code>call</code>的机器码</p><p>对付这种花指令，可以将<code>jnz</code>这个无效跳转直接nop掉（右键nop），至于<code>call</code>指令的部分不要这样，下面详述</p><h2 id="例题-hdctf2019maze">例题-[HDCTF2019]Maze</h2><p>其实上面的图来源于一道re题</p><p>前面upx脱壳的过程略，ida打开</p><p><img src="image-20240125172244493.png" /></p><p>看到标红地方是一个典型的不可执行花命令，这个数据明显不是地址，而且很有可能是指令，所以先不要直接nop</p><p>上面是一个没有用的跳转，那就把2C处的<code>jnz</code>给nop掉</p><p><img src="image-20240125172724844.png" /></p><p>2E处转为code（方法上文有），发现果然2F处是一个pop，并且下面一堆被IDA未识别的数据也一起转为指令了</p><p><img src="image-20240125173334448.png" /></p><p>此时数据地址是红色的，选中<code>_mian</code>函数头，快捷键P将其声明为函数，F5查看伪代码并分析</p><p>是个走迷宫的题啦~</p>]]></content>
      
      
      <categories>
          
          <category> reverse笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> 花指令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-[2019红帽杯]easyRE</title>
      <link href="/2024/01/23/buuctf-2019%E7%BA%A2%E5%B8%BD%E6%9D%AF-easyRE/"/>
      <url>/2024/01/23/buuctf-2019%E7%BA%A2%E5%B8%BD%E6%9D%AF-easyRE/</url>
      
        <content type="html"><![CDATA[<h1 id="buuctf-2019红帽杯easyre">buuctf [2019红帽杯]easyRE</h1><p>查壳</p><p><img src="image-20240123114625741.png" /></p><p>64位无壳，拖入IDA</p><p><img src="image-20240123114714915.png" /></p><p>全是这种函数，无main函数，有一个start函数但没什么用，打开字符串子视图看看有没有什么信息</p><p><img src="image-20240123114826506.png" /></p><p>前五个比较重要，跟进到唯一一个引用函数</p><p><img src="image-20240123115135954.png" /></p><p>分析一下第一阶段，就是输入一个长度为36的字符串，这里IDA的识别有点问题，v12、v13和v14应该是连在一起的一个数组，不然下面的if判断条件中v12数组会越界</p><p>写个脚本看一下v15里的是什么内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v12=<span class="string">&quot;Iodl&gt;Qnb(ocy\x7Fy.i\x7Fd`3w&#125;wek9&#123;iy=~yL@EC&quot;</span></span><br><span class="line">v15=<span class="string">&#x27;&#x27;</span></span><br><span class="line">j=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> v12:</span><br><span class="line">    v15+=<span class="built_in">chr</span>(<span class="built_in">ord</span>(i)^j)</span><br><span class="line">    j+=<span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(v15)</span><br></pre></td></tr></table></figure><p>输出结果是 Info:The first four chars are `flag`，没什么用...</p><p>往下分析</p><p><img src="image-20240123120254716.png" /></p><p>输入的字符串进行10次函数运算后得到的结果与<code>off_6CC090</code>处字符进行比较</p><p>查看<code>sub_400E44</code>函数与<code>off_6CC090</code>内容</p><p><img src="image-20240123120621481.png" /></p><p><img src="image-20240123120720992.png" /></p><p>正常的base64表，其实刚才看字符串视图就已经看到了</p><p><img src="image-20240123120819735.png" /></p><p>这里就是加密后的字符串，解密十次得到</p><p><code>https://bbs.kanxue.com/thread-254172-3.htm</code></p><p>又被骗了...</p><p><img src="image-20240123121157163.png" /></p><p>其实真正的有效信息在<code>off_6CC090</code>下方，跟进引用函数</p><p><img src="image-20240123121356850.png" /></p><p>这里可以看到flag初具雏形，不用管上面的1234次循环，直接根据<code>byte_6CC0A0</code>处的内容可以得到v1和v4，这里<code>unsigned_int8</code>和<code>HIBYTE</code>是把低八位和高八位取出来，分别是f和g，可以合理猜测整个就是flag</p><p>脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a=[<span class="number">0x40</span>, <span class="number">0x35</span>, <span class="number">0x20</span>, <span class="number">0x56</span>, <span class="number">0x5D</span>, <span class="number">0x18</span>, <span class="number">0x22</span>, <span class="number">0x45</span>, <span class="number">0x17</span>, <span class="number">0x2F</span>, <span class="number">0x24</span>, <span class="number">0x6E</span>, <span class="number">0x62</span>, <span class="number">0x3C</span>, <span class="number">0x27</span>, <span class="number">0x54</span>, <span class="number">0x48</span>, <span class="number">0x6C</span>, <span class="number">0x24</span>, <span class="number">0x6E</span>, <span class="number">0x72</span>, <span class="number">0x3C</span>, <span class="number">0x32</span>, <span class="number">0x45</span>, <span class="number">0x5B</span>]</span><br><span class="line">b=[<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;g&#x27;</span>]</span><br><span class="line">c=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    b[i]=<span class="built_in">chr</span>(<span class="built_in">ord</span>(b[i])^a[i])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>):</span><br><span class="line">    c+=<span class="built_in">chr</span>(a[i]^<span class="built_in">ord</span>(b[i%<span class="number">4</span>]))</span><br><span class="line"><span class="built_in">print</span>(c)</span><br></pre></td></tr></table></figure><p>得到flag</p><p><img src="image-20240123123340185.png" /></p><p>虽然这题当时好像只是一道签到，但很搞的是被骗了两次...</p>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Z3-Solver</title>
      <link href="/2024/01/21/Z3-Solver%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/01/21/Z3-Solver%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="z3-solver">Z3-Solver</h1><h2 id="简介">简介</h2><p>Z3Solver是一个微软出品的开源约束求解器，能够解决很多种情况下的给定部分约束条件寻求一组满足条件的解的问题</p><p>Z3Solver支持多种不同的问题领域，包括布尔逻辑、整数和实数的线性和非线性算术、位向量、数组、集合、函数等，主要应用领域包括软件验证、形式化验证、程序分析、人工智能和自动定理证明等</p><h2 id="语法">语法</h2><p>z3中有3种类型的变量，分别是<strong>整型(Int)</strong>，<strong>实型(Real)</strong>和<strong>向量(BitVec)</strong></p><p>对于整数类型数据，基本API：</p><ol type="1"><li>Int(name, ctx=None)，创建一个整数变量，name是名字</li><li>Ints (names, ctx=None)，创建多个整数变量，names是空格分隔名字</li><li>IntVal (val, ctx=None)，创建一个整数常量，有初始值，没名字</li></ol><p>对于实数类型的API与整数类型一致，向量(BitVec)则稍有区别：</p><ol type="1"><li>Bitvec(name,bv,ctx=None)，创建一个位向量，name是他的名字，bv表示大小</li><li>BitVecs(name,bv,ctx=None)，创建一个有多变量的位向量，name是名字，bv表示大小</li><li>BitVecVal(val,bv,ctx=None)，创建一个位向量，有初始值，没名字</li></ol><p>simplify(表达式)，对可以简化的表达式进行简化</p><h2 id="应用">应用</h2><h3 id="直接调用solve-函数">直接调用<code>solve()</code> 函数</h3><p><code>solve()</code> 函数会创造一个solver，然后对括号中的约束条件进行求解，<strong>需要注意默认情况下只会找到满足条件的一组解</strong>，因此提供约束条件时尽可能详尽，一个例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">x = Int(<span class="string">&#x27;x&#x27;</span>)                                         <span class="comment">#声明变量</span></span><br><span class="line">y = Int(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">solve(x &gt; <span class="number">2</span>, y &lt; <span class="number">10</span>, x + <span class="number">2</span>*y == <span class="number">7</span>)                   <span class="comment">#添加约束条件</span></span><br><span class="line">&gt;&gt;&gt;[y = <span class="number">0</span>, x = <span class="number">7</span>]</span><br></pre></td></tr></table></figure><p><code>solve()</code>函数会自动打印解，不需要再套一层<code>print()</code></p><h3 id="创建solver求解器">创建Solver求解器</h3><p>基本按照 <strong>创建约束求解器、声明变量 -&gt; 添加约束条件 -&gt;验证是否有解 -&gt; 求解</strong> 的步骤进行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">s = Solver()                <span class="comment">#创建约束求解器</span></span><br><span class="line">x = Int(<span class="string">&#x27;x&#x27;</span>)                <span class="comment">#声明变量</span></span><br><span class="line">y = Int(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">s.add(x &gt; <span class="number">2</span>)                <span class="comment">#添加约束条件</span></span><br><span class="line">s.add(y &lt; <span class="number">10</span>)</span><br><span class="line">s.add(x + <span class="number">2</span>*y == <span class="number">7</span>)</span><br><span class="line"><span class="keyword">if</span> s.check() == sat:        <span class="comment">#验证是否有解</span></span><br><span class="line"><span class="built_in">print</span>(s.model())        <span class="comment">#求解并打印</span></span><br><span class="line">&gt;&gt;&gt;[y = <span class="number">0</span>, x = <span class="number">7</span>]</span><br></pre></td></tr></table></figure><h2 id="例题">例题</h2><h3 id="解数独">解数独</h3><p>文章链接：<ahref="https://blog.csdn.net/P01yH3dr0n/article/details/106784526">PythonZ3约束求解器解决数独问题</a></p><h3 id="guet-ctf2019re">[GUET-CTF2019]re</h3><p>前面脱壳逆向的过程略，找到关键函数</p><p><img src="image-20240121132512763.png" /></p><p>出现这么多线性判断语句，考虑用z3求解，脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">s = Solver()</span><br><span class="line">a1 = [Int(<span class="string">&quot;[a1[%d]&quot;</span> % i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)]</span><br><span class="line"></span><br><span class="line">s.add( <span class="number">1629056</span> * a1[<span class="number">0</span>] == <span class="number">166163712</span> )</span><br><span class="line">s.add( <span class="number">6771600</span> * a1[<span class="number">1</span>] == <span class="number">731332800</span> )</span><br><span class="line">s.add( <span class="number">3682944</span> * a1[<span class="number">2</span>] == <span class="number">357245568</span> )</span><br><span class="line">s.add( <span class="number">10431000</span> * a1[<span class="number">3</span>] == <span class="number">1074393000</span> )</span><br><span class="line">s.add( <span class="number">3977328</span> * a1[<span class="number">4</span>] == <span class="number">489211344</span> )</span><br><span class="line">s.add( <span class="number">5138336</span> * a1[<span class="number">5</span>] == <span class="number">518971936</span> )</span><br><span class="line">s.add( a1[<span class="number">6</span>] == <span class="number">49</span> )</span><br><span class="line">s.add( <span class="number">7532250</span> * a1[<span class="number">7</span>] == <span class="number">406741500</span> )</span><br><span class="line">s.add( <span class="number">5551632</span> * a1[<span class="number">8</span>] == <span class="number">294236496</span> )</span><br><span class="line">s.add( <span class="number">3409728</span> * a1[<span class="number">9</span>] == <span class="number">177305856</span> )</span><br><span class="line">s.add( <span class="number">13013670</span> * a1[<span class="number">10</span>] == <span class="number">650683500</span> )</span><br><span class="line">s.add( <span class="number">6088797</span> * a1[<span class="number">11</span>] == <span class="number">298351053</span> )</span><br><span class="line">s.add( <span class="number">7884663</span> * a1[<span class="number">12</span>] == <span class="number">386348487</span> )</span><br><span class="line">s.add( <span class="number">8944053</span> * a1[<span class="number">13</span>] == <span class="number">438258597</span> )</span><br><span class="line">s.add( <span class="number">5198490</span> * a1[<span class="number">14</span>] == <span class="number">249527520</span> )</span><br><span class="line">s.add( <span class="number">4544518</span> * a1[<span class="number">15</span>] == <span class="number">445362764</span> )</span><br><span class="line">s.add( <span class="number">3645600</span> * a1[<span class="number">17</span>] == <span class="number">174988800</span> )</span><br><span class="line">s.add( <span class="number">10115280</span> * a1[<span class="number">16</span>] == <span class="number">981182160</span> )</span><br><span class="line">s.add( <span class="number">9667504</span> * a1[<span class="number">18</span>] == <span class="number">493042704</span> )</span><br><span class="line">s.add( <span class="number">5364450</span> * a1[<span class="number">19</span>] == <span class="number">257493600</span> )</span><br><span class="line">s.add( <span class="number">13464540</span> * a1[<span class="number">20</span>] == <span class="number">767478780</span> )</span><br><span class="line">s.add( <span class="number">5488432</span> * a1[<span class="number">21</span>] == <span class="number">312840624</span> )</span><br><span class="line">s.add( <span class="number">14479500</span> * a1[<span class="number">22</span>] == <span class="number">1404511500</span> )</span><br><span class="line">s.add( <span class="number">6451830</span> * a1[<span class="number">23</span>] == <span class="number">316139670</span> )</span><br><span class="line">s.add( <span class="number">6252576</span> * a1[<span class="number">24</span>] == <span class="number">619005024</span> )</span><br><span class="line">s.add( <span class="number">7763364</span> * a1[<span class="number">25</span>] == <span class="number">372641472</span> )</span><br><span class="line">s.add( <span class="number">7327320</span> * a1[<span class="number">26</span>] == <span class="number">373693320</span> )</span><br><span class="line">s.add( <span class="number">8741520</span> * a1[<span class="number">27</span>] == <span class="number">498266640</span> )</span><br><span class="line">s.add( <span class="number">8871876</span> * a1[<span class="number">28</span>] == <span class="number">452465676</span> )</span><br><span class="line">s.add( <span class="number">4086720</span> * a1[<span class="number">29</span>] == <span class="number">208422720</span> )</span><br><span class="line">s.add( <span class="number">9374400</span> * a1[<span class="number">30</span>] == <span class="number">515592000</span> )</span><br><span class="line">s.add( <span class="number">5759124</span> * a1[<span class="number">31</span>] == <span class="number">719890500</span> )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s.check() == sat:</span><br><span class="line">    m = s.model()</span><br><span class="line">    <span class="comment">#直接print(m)输出的是解，用eval和as_long处理一下</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(m.<span class="built_in">eval</span>(a1[i]).as_long()),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>这题有两个坑，一个是a1[6]不在这个判断条件中，一个是a1[16]和a1[17]位置调换了</p><h3 id="关于调整解的格式的补充">*关于调整解的格式的补充</h3><p>a1[6]要添加在约束条件中，不然最后输出会报错，有大佬指出用burp爆破可以得到本题的a1[6]</p><p>而且不能写成</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot; &quot;</span>.join([m.<span class="built_in">eval</span>(a1[i]).as_long() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)]))</span><br></pre></td></tr></table></figure><p>(我不知道为什么</p><p>有时候在使用.as_long() / .as_fraction()时会报错</p><p><code>AttributeError: 'NoneType' object has no attribute 'as_long'</code></p><p>解决方法详见链接：<ahref="https://blog.csdn.net/weixin_39251985/article/details/113865326">Z3求解器结果输出（python</a></p>]]></content>
      
      
      <categories>
          
          <category> reverse笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> reverse </tag>
            
            <tag> Z3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shell</title>
      <link href="/2024/01/07/Shell%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/01/07/Shell%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h1 id="shell">Shell</h1><h2 id="概念">概念</h2><h4 id="shell-1">Shell</h4><p>解释执行用户输入的命令或程序等，交互式</p><p>Shell是一块包裹着系统核心的壳，处于操作系统的最外层，与用户直接对话，把用户的输入解释给操作系统，然后处理操作系统的输出结果，输出到屏幕给与用户看到结果</p><h4 id="shell脚本">Shell脚本</h4><p>命令或程序写在文件中，执行文件读取代码，这样的程序文件称为Shell脚本，非交互式</p><p>Windows中存在<code>*.bat</code>批处理脚本，Linux中常用<code>*.sh</code>脚本文件</p><h2 id="shebang">Shebang</h2><p>指的是文件开头的两个字符<code>#!</code> ，后跟解释器名称</p><p>①以<code>#!/bin/sh</code>开头的文件调用的是bash解释器</p><p>②以<code>#!/usr/bin/python</code>开头的文件调用的是python解释器</p><p>③以<code>#!/usr/bin/env 解释器名</code>开头的文件调用的是指定解释器</p><p>④若文件未指明Shebang，脚本执行的时候默认是当前Shell作为解释器，可以通过<code>echo $SHELL</code>指令查看</p><h3 id="执行shell脚本的方式">执行Shell脚本的方式</h3><p>①文件无x权限或脚本未指定Shebang时，使用<code>解释器名 script.sh</code>，提权<code>chmod +x script.sh</code></p><p>②文件有x权限可以使用<code>绝对/相对路径</code></p><p>③<code>source script.sh</code>或<code>. script.sh</code></p><p>④利用重定向写入符号<code>解释器名 &lt; script.sh</code>，这个命令会运行script.sh脚本，并将其内容作为输入传递给Shell解释器</p><p><img src="image-20240106134537311.png" /></p><h2 id="bash特性">Bash特性</h2><p>①文件路径tab键补全</p><p>②命令补全</p><p>③快捷键 ctrl + a，e，u，k，l</p><p>④通配符</p><p>⑤history</p><p><code>echo $HISTFILE</code>查看历史命令</p><p><code>! 历史id</code>快速执行历史命令</p><p><code>!!</code>调用上一条命令</p><h2 id="shell语言">Shell语言</h2><h3 id="变量">变量</h3><h4 id="定义">定义</h4><p>Shell脚本语言是一种弱类型语言，无需声明变量类型，默认字符串；标识符规则与C类似</p><h4 id="赋值">赋值</h4><p>Shell变量赋值不得有空格，会被识别为命令+参数等；单引号强引用，不识别特殊符号，双引号识别，反引号括起来的返回的是命令执行结果，相当于<code>$()</code></p><h4 id="查值">查值</h4><p><code>echo $变量名</code>或<code>echo $&#123;变量名&#125;</code></p><h4 id="作用域">作用域</h4><p>普通变量作用域是当前Shell（<code>pstree</code>查看进程树），切换Shell变量会丢失</p><p>每次调用解释器执行脚本都会开启一个子Shell，完毕后回到父Shell中，因此脚本中变量的定义赋值不会被保留；若采用<code>source</code>或<code>.</code>的方式执行脚本会在当前Shell执行</p><h4 id="环境变量">环境变量</h4><h5 id="配置文件">配置文件</h5><p>用户个人：<code>~/.bash_profile</code>、<code>~/.bashrc</code>，是远程登陆用户特有文件</p><p>全局配置文件：<code>/etc/profile</code>、<code>/etc/bashrc</code></p><p>以个人配置文件优先加载变量</p><h5 id="检查系统环境变量的命令">检查系统环境变量的命令</h5><p><code>set</code>输出当前Shell所有变量，包括全局变量与局部变量（sh脚本中定义的变量），<code>declare</code>相同</p><p><code>env</code>显示全局变量，<code>export</code>显示环境变量</p><h5 id="撤销环境变量">撤销环境变量</h5><p><code>unset</code>删除变量或函数</p><h5 id="设置只读变量">设置只读变量</h5><p><code>readonly</code>当前Shell结束只读变量失效</p><h5 id="环境变量文件加载顺序">环境变量文件加载顺序</h5><p><code>/etc/profile</code> -&gt;<code>/etc/profile.d</code>目录下的脚本 -&gt;<code>~/.bash_profile</code> -&gt; <code>~/.bashrc</code> -&gt;<code>/etc/bashrc</code></p><h4 id="特殊变量">特殊变量</h4><p><img src="image-20240106004329246.png" /></p><h5 id="补充">补充</h5><p>$$ 当前Shell脚本的进程号</p><p>$_ 取得上次执行命令的最后一个参数</p><h3 id="基础内置命令bash">基础内置命令（Bash）</h3><h4 id="echo">echo</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-n 不换行输出</span><br><span class="line">-e 解析字符串中的特殊符号</span><br><span class="line">printf 打印命令</span><br></pre></td></tr></table></figure><h4 id="eval">eval</h4><p>执行多个命令，分号隔开</p><h4 id="exec">exec</h4><p>不创建子进程执行后续命令，执行完毕后exit</p><h3 id="父子shell">父子Shell</h3><p>父Shell的PID是子Shell的PPID</p><p><code>ps</code>进程管理命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ps -ef</span><br><span class="line">-f 显示UID，PID，PPID</span><br><span class="line">-e 列出所有进程信息，与 -a 相同</span><br><span class="line">--forest 以树形结构展示进程之间的父子关系</span><br></pre></td></tr></table></figure><p>每次调用解释器都会开启一个子Shell，exit可以退出回到父Shell中</p><h4 id="进程列表">进程列表</h4><p>用<code>()</code>括起来的命令会作为一个进程列表，创建子Shell，<code>()</code>可以嵌套</p><p>用子Shell进行多进程处理，可以提高并发执行效率</p><h4 id="内置外置命令">内置/外置命令</h4><p>外置命令运行更慢，并且会开启子进程执行；<code>type</code>命令判断命令为内置/外置，<code>compgen -b</code>列出内置命令</p>]]></content>
      
      
      <categories>
          
          <category> 其它笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机网络笔记（六）</title>
      <link href="/2023/12/21/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%EF%BC%89/"/>
      <url>/2023/12/21/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="dhcp">6.1 DHCP</h2><p>自动分配的内容包括：IP地址、子网掩码、默认（缺省）网关、DNS服务器</p><p>服务器不能用DHCP</p><p>DHCP服务器的两大工作：租约请求（UDP）、租约续订</p><h3 id="工作流程">工作流程</h3><p>租用请求：源IP是0.0.0.0，目的IP是255.255.255.255，以MAC地址为主机标识</p><p>租用提供：目的IP是255.255.255.255</p><p>租用选择：与请求时相同</p><p>租用确认：与提供时相同</p><h3 id="租用续约">租用续约</h3><p><img src="image-20231222000709029.png" /></p><p>APIPA</p><p><img src="image-20231222000811798.png" /></p><p>流程</p><p>租用请求：源IP是上次给的IP，目的IP是DHCP服务器的IP，以MAC地址为主机标识</p><p>租用提供：目的IP是上次给的IP</p><p>租用选择：与请求时相同</p><p>租用确认：与提供时相同</p><p><strong>路由器隔离广播域，交换机隔离冲突域但不隔离广播域</strong></p><p><img src="image-20231222001115306.png" /></p><h2 id="dns">6.2 DNS</h2><p>DNS使用TCP和UDP（主要）的53端口</p><p>每一级域名长度限制63字符，总长度253字符，最后其实有一个点（.）</p><p><img src="image-20231222001348558.png" /></p><p>查询过程</p><p><img src="image-20231222002122742.png" /></p><p>递归查询不问过程只要结果</p><p><strong>域名与IP地址不是一一映射的</strong></p><h2 id="万维网">6.3 万维网</h2><h3 id="www工作流程">www工作流程</h3><p><img src="image-20231222002721556.png" /></p><h3 id="url">URL</h3><p><img src="image-20231222002823289.png" /></p><h3 id="http">HTTP</h3><p><img src="image-20231222002942391.png" /></p><p>HTTP 1.1相较于1.0持续连接、流水线方式</p><h3 id="http代理">HTTP代理</h3><p><img src="image-20231222003557889.png" /></p><h4 id="cookie">cookie</h4><p><img src="image-20231222003650652.png" /></p><h2 id="电子邮件">6.4 电子邮件</h2><h3 id="mua">MUA</h3><p><img src="image-20231222003811006.png" /></p><h3 id="mta和mda">MTA和MDA</h3><p><img src="image-20231222003848811.png" /></p><p>以下是随便写的...</p><p><img src="image-20231222004137734.png" /></p><h2 id="ftptftptelnet">6.5 FTP/TFTP/TELNET</h2><p>FTP是TCP，两个TCP连接，两种模式port、passive</p><p>TFTP是UDP，局域网，停等协议</p><p>TELNET是TCP，击键和命令转为NVT</p>]]></content>
      
      
      <categories>
          
          <category> 课程笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机网络笔记（五）</title>
      <link href="/2023/12/21/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/"/>
      <url>/2023/12/21/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="传输层基本功能与udp协议">5.1 传输层基本功能与UDP协议</h2><h3 id="传输层功能">传输层功能</h3><p>传输层提供应用进程间的逻辑通信，且提供复用与分用功能</p><h3 id="udp协议">UDP协议</h3><p>无连接、不可靠</p><p>提供的数据单位协议是UDP报文或用户数据报（<strong>不做数据的划分</strong>）</p><p><img src="image-20231221225105915.png" /></p><p>报文格式</p><p><img src="image-20231221225240560.png" /></p><p>此处可以看出为什么上一章中ICMP报头需要包括IP数据报报头和数据前8个字节，因为前8个字节就是UDP数据报的报头，包含了进程（端口）</p><p>计算校验和：二进制反码求和</p><h3 id="tcp协议">TCP协议</h3><p>面向连接、可靠、开销更大</p><p><strong>不提供广播、多播</strong></p><p>提供的数据单位协议是TCP报文段</p><h3 id="基于端口标识进程">基于端口标识进程</h3><p><img src="image-20231221224846688.png" /></p><p>熟知端口号</p><p><img src="image-20231221224918165.png" /></p><p>记住TCP+UDP</p><h2 id="tcp协议-1">5.2 TCP协议</h2><p>面向连接、可靠、字节流、点到点、单位为段</p><p>报文结构</p><p><img src="image-20231221225723648.png" /></p><p>重要的字段</p><p><img src="image-20231221225955722.png" /></p><p><img src="image-20231221230037783.png" /></p><p><img src="image-20231221230238111.png" /></p><p><img src="image-20231221230323094.png" /></p><h2 id="tcp协议连接管理">5.3 TCP协议连接管理</h2><h3 id="tcp连接">TCP连接</h3><p>TCP连接的端点叫做套接字（socket)=（IP地址：端口号），每一条TCP连接被通信两端两个套接字所确定</p><h3 id="三次握手">三次握手</h3><p><img src="image-20231221231123421.png" /></p><p>第三次握手确保发送的不是旧的请求</p><h3 id="释放连接四次握手">释放连接四次握手</h3><p><img src="image-20231221231704901.png" /></p><h2 id="tcp协议可靠传输">5.4 TCP协议可靠传输</h2><h3 id="可靠传输原理">可靠传输原理</h3><p>超时重传机制</p><h3 id="停等协议">停等协议</h3><p>分组错误、分组丢失、确认丢失、确认收到</p><p>简单但信道利用率低</p><h3 id="流水线协议">流水线协议</h3><h3 id="滑动窗口协议">滑动窗口协议</h3><h3 id="tcp滑动窗口">TCP滑动窗口</h3><h3 id="tcp重传定时器">TCP重传定时器</h3><p><img src="image-20231221233946109.png" /></p><p><img src="image-20231221234103046.png" /></p><h3 id="其他定时器">其他定时器</h3><p>持续定时器、保活定时器、等待控制定时器</p><h3 id="tcp协议拥塞控制">5.5 TCP协议拥塞控制</h3><p>UDP没有拥塞控制能力</p><p><img src="image-20231221234652149.png" /></p><h3 id="慢开始和拥塞避免">慢开始和拥塞避免</h3><p><img src="image-20231221234806355.png" /></p><p><img src="image-20231221234946979.png" /></p><p>注意第二轮的阈值时上一轮拥塞时的一半</p><h3 id="快重传和快恢复">快重传和快恢复</h3><p><img src="image-20231221235100133.png" /></p><p><img src="image-20231221235255378.png" /></p><h3 id="随机早期检测网络层">随机早期检测（网络层）</h3><p>应用于路由器队列管理</p><p><img src="image-20231221235417607.png" /></p>]]></content>
      
      
      <categories>
          
          <category> 课程笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机网络笔记（四）</title>
      <link href="/2023/12/21/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89/"/>
      <url>/2023/12/21/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="网络层功能和ip协议">4.1 网络层功能和IP协议</h2><h3 id="网络层功能">网络层功能</h3><p>路由、寻址、网络互联、为上层提供服务</p><h3 id="网络层服务">网络层服务</h3><p>虚电路：提供高质量服务，典例ATM网络，通信需要提前建立虚电路</p><p>数据报（主要）：网络有高容错性（鲁棒性）、可靠性</p><p><img src="image-20231221191444338.png" /></p><h3 id="网络层协议">网络层协议</h3><p><img src="image-20231221191659413.png" /></p><h3 id="ip协议">IP协议</h3><p>无连接、不可靠</p><p><strong>帧格式</strong></p><p><img src="image-20231221191849865.png" /></p><p>版本：占4位，目前为4（在不断发展中）</p><p>首部长度：占4位，单位是双字（即32位，一般16位为一个字），但IP首部的固定部分是20字节，因此首部长度字段最小值为5，且首部长度最大为60字节（15*32/8）</p><p>总长度： 不超过最大传送单元MTU</p><p>标识：表明同一用户信息的不同数据段</p><p>标识（Flags）与片偏移</p><p><img src="image-20231221193825984.png" /></p><p>后续</p><p><img src="image-20231221194137892.png" /></p><p><img src="image-20231221194244235.png" /></p><p>填充字段保证报文32位对齐</p><h2 id="arp协议icmp协议">4.2 ARP协议/ICMP协议</h2><h3 id="arp协议">ARP协议</h3><p>MAC地址是固定的，ARP负责从网络层使用的IP地址解析出数据链路层的MAC地址，解析结果存储在主机缓存中，命令arp-a；一般在局域网内使用，与其他局域网需要路由网关</p><p><strong>帧格式</strong></p><p><img src="image-20231221195238244.png" /></p><h3 id="icmp协议">ICMP协议</h3><p>差错控制</p><p><strong>帧格式</strong></p><p><img src="image-20231221195717780.png" /></p><p>ICMP协议封装在IP协议中，IP协议封装在以太网协议中</p><p><img src="image-20231221195809376.png" /></p><p><strong>ICMP报文有效数据包括IP数据报报头与有效数据前8个字节</strong>，前8个字节包括了传输层中的端口号</p><h3 id="icmp命令">ICMP命令</h3><p>ping tracert（linux中是Trace route）</p><h2 id="ip地址">4.3 IP地址</h2><p>IP地址比MAC地址更有层次结构</p><p>局域网内主机的默认网关是连接的路由器的端口</p><p>子网掩码区分网络号与主机号进而区分远程和本地主机</p><h3 id="ip地址分类折半划分">IP地址分类（折半划分）</h3><p>A类子网掩码255.0.0.0，范围1.0.0.0-126.0.0.0，第一位0</p><p>B类255.255.0.0，范围128.0.0.0-191.255.0.0，前两位10</p><p>C类255.255.255.0，范围192.0.0.0-223.255.255.0，前三位110</p><p>D类前四位1110</p><p>E类前五位11110</p><h3 id="私网ip">私网IP</h3><p><img src="image-20231221202556872.png" /></p><h3 id="特殊ip">特殊IP</h3><p><img src="image-20231221202632653.png" /></p><p><strong>所有网段中全0（网络地址）和全1（广播地址）的地址是不可使用的（划分出的子网中的也是）</strong></p><h2 id="子网超网和cidr">4.4 子网、超网和CIDR</h2><p>子网：掩码借用网络号</p><p><img src="image-20231221204204431.png" /></p><p>超网：掩码借用主机号，也称路由聚合</p><h2 id="路由">4.5 路由</h2><h3 id="转发">转发</h3><p><img src="image-20231221205111710.png" /></p><p>路由表中都是网络地址，将目的地址与子网掩码相与，查看是否与路由表中的某项网络地址匹配，出现多个匹配项时，选择最长前缀匹配地址</p><p>转发过程中源、目的MAC变化，IP不变化</p><h2 id="路由算法">4.6 路由算法</h2><h3 id="分类">分类</h3><p><img src="image-20231221211901868.png" /></p><p>自治系统（AS）：内部采用一致路由策略</p><h3 id="路由协议">路由协议</h3><p>内部网关路由协议：RIP、OSPF</p><p>外部网关路由协议：BGP</p><h3 id="路由算法-1">路由算法</h3><p>距离矢量路由</p><p>链路状态路由：迪杰斯特拉算法，分组中包括序号和年龄（路由器重启问题）</p><p><img src="image-20231221212818612.png" /></p><h2 id="内部网关路由协议">4.7 内部网关路由协议</h2><h3 id="rip协议基于距离矢量路由">RIP协议（基于距离矢量路由）</h3><p><img src="image-20231221213118495.png" /></p><p>注意最大跳数是15跳</p><p><strong>避免环路机制</strong></p><p><img src="image-20231221213439818.png" /></p><p><strong>RIP定时器</strong></p><p><img src="image-20231221213551379.png" /></p><p>RIPv2格式</p><p><img src="image-20231221213722112.png" /></p><p>命令字段1为请求，2为响应</p><h3 id="ospf协议">OSPF协议</h3><p><img src="image-20231221213954217.png" /></p><p>报文格式</p><p><img src="image-20231221214101245.png" /></p><p>五种类型的OSPF分组</p><p><img src="image-20231221214321241.png" /></p><p>工作流程</p><p><img src="image-20231221214409844.png" /></p><h2 id="外部网关路由协议和多播路由协议">4.8外部网关路由协议和多播路由协议</h2><h3 id="bgp协议">BGP协议</h3><p><img src="image-20231221214800483.png" /></p><p>BGP的五种报文</p><p><img src="image-20231221215037059.png" /></p><p>报文格式</p><p><img src="image-20231221215111420.png" /></p><h3 id="多播">多播</h3><p>应用：会员点播</p><p>多播需要硬件多播地址支持，解决方法如下</p><p><img src="image-20231221215512357.png" /></p><p>多播需要成员管理协议</p><p>IGMP协议</p><p><img src="image-20231221215910851.png" /></p><p>工作流程略</p><p>多播需要多播路由协议</p><p>RPB、隧道技术，具体略</p><h2 id="路由器">4.9 路由器</h2><p>结构略</p><p>路由和转发</p><p>转发表硬件、路由表软件</p><p><strong>不分片</strong></p><p>略</p><p>略</p><p>略</p><h2 id="vpnnatmpls">4.10 VPN/NAT/MPLS</h2><h3 id="vpn">VPN</h3><p>分类：内联网、外联网、远程接入</p><h3 id="nat">NAT</h3><p>多内网主机共用外网IP</p><h3 id="mpls">MPLS</h3><p>略</p><h2 id="ipv6">4.11 IPv6</h2><h3 id="主要目标">主要目标</h3><p><img src="image-20231221222128138.png" /></p><h3 id="主要特点">主要特点</h3><p><img src="image-20231221222205002.png" /></p><h3 id="报文格式">报文格式</h3><p>略</p><h3 id="ipv6地址">IPv6地址</h3><p>单播、多播、任意播（通常是最近的一个）</p><p>连续的0允许压缩，但只允许一次</p><p>IPv4可记为：：128.10.2.1</p><p>CIDR斜线记法仍适用</p><p><img src="image-20231221223207704.png" /></p><p><img src="image-20231221223219562.png" /></p><p>本地链路单播地址即IPv4中的私有IP地址</p><p><img src="image-20231221223252267.png" /></p><p>够长，可以直接把MAC写进来，因此不需要ARP</p><h3 id="两类地址的过渡">两类地址的过渡</h3><p><img src="image-20231221223354246.png" /></p>]]></content>
      
      
      <categories>
          
          <category> 课程笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>命令行收发邮件</title>
      <link href="/2023/11/24/%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%94%B6%E5%8F%91%E9%82%AE%E4%BB%B6/"/>
      <url>/2023/11/24/%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%94%B6%E5%8F%91%E9%82%AE%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<p>win11下telnet客户端默认是关闭的，首先打开telnet</p><p>控制面板-程序-程序与功能-启用或关闭Windows功能</p><p><img src="1.png" /></p><h3 id="发送邮件">发送邮件</h3><p>cmd中telnet远程登录163邮箱smtp服务器，端口号25</p><p><ahref="https://blog.csdn.net/gongqinglin/article/details/115975619">各种邮箱收发服务器地址及端口</a></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet smtp.<span class="number">163</span>.com <span class="number">25</span></span><br></pre></td></tr></table></figure><p><strong>注意：以下过程，telnet中输入任何字符如果有错，该条命令就需要回车重新写，就算回退重写只是表面改变了，实际还是接着输入，运行一定会报错或输出不符预期</strong></p><p>向服务器打招呼,看是否得到正确回应（有的服务器是ehlo）</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helo hi</span><br></pre></td></tr></table></figure><p>选择 auth login登录方式</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth login</span><br></pre></td></tr></table></figure><p>输入base64编码后的用户名密码（用户名不带@163.com），Authenticationsuccessful验证成功</p><p>接着输入发件人邮箱、收件人邮箱，输入data开始写信</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mail from:&lt;发件人邮箱地址&gt;</span><br><span class="line">rcpt to:&lt;收件人邮箱地址&gt;</span><br><span class="line">data //开始写信的内容</span><br></pre></td></tr></table></figure><p>输入邮件主题</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">subject:<span class="title">hi</span></span></span><br></pre></td></tr></table></figure><p>空一行之后输入内容</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello world!</span><br></pre></td></tr></table></figure><p>写完后输入</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.</span><br></pre></td></tr></table></figure><p>进入收件人邮箱查看，有该邮件</p><p>以下是完整过程与结果截图</p><p><img src="2.png" /></p><h3 id="接收邮件">接收邮件</h3><p>pop3接收邮件，qq的端口号110，<strong>注意此处是110</strong>，QQ官网上给的995是SSL加密的端口</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet pop.qq.com <span class="number">110</span></span><br></pre></td></tr></table></figure><p>先得在qq邮箱中启用pop3</p><p><img src="3.png" /></p><p><img src="4.png" /></p><p>授权码复制一下，等下password可以输授权码</p><p>登录pop3后，输入用户名、授权码</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user 用户名</span><br><span class="line">pass 授权码</span><br></pre></td></tr></table></figure><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list //查看所有邮件</span><br></pre></td></tr></table></figure><p><img src="6.png" /></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retr <span class="number">63</span> //retr命令查看邮件内容</span><br></pre></td></tr></table></figure><p><img src="7.png" /></p><p>此外还有命令</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dele //删除邮件（非真正删除，而是标记删除）</span><br><span class="line">rset //恢复删除</span><br><span class="line">quit //退出时会把所有标记删除的邮件删除</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 课程笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cmd </tag>
            
            <tag> 邮件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机网络笔记（三）</title>
      <link href="/2023/11/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/"/>
      <url>/2023/11/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="数据链路层基本功能">3.1 数据链路层基本功能</h2><h3 id="封装成帧最重要">封装成帧（最重要）</h3><p>字符计数法、特殊字符界定法、特殊位串界定法（以01111110为帧的边界，正文中每5个1强制后面添0）、物理层编码违例法（以特殊波形作为帧的边界）</p><h3 id="透明传输">透明传输</h3><p>帧定界符：SOH（Start Of Header，ASCII码01）、EOT（End OfTransmission，ASCII码04），都是不可打印字符。当传送的帧是用文本文件组成的帧（文本文件中的字符都是从键盘上输入的），那么不管输入什么样的字符都可以放在帧中传输过去，称为透明传输。当数据中有SOH、EOT时会被数据链路层误判为帧的边界，因此在这样的数据前添加转义字符ESC</p><h3 id="差错控制">差错控制</h3><p><strong>检错码</strong></p><p>循环冗余校验CRC：n位冗余码（FCS帧检验序列）是由数据M添加n个0后除以n+1位除数P得到的余数，接收端将M与FCS拼接后除以相同的除数，余数为0正常，余数不为0丢弃</p><p><strong>纠错码</strong></p><p><strong>海明码</strong></p><h3 id="流量控制">流量控制</h3><p>滑动窗口协议、停等协议</p><h3 id="链路管理">链路管理</h3><p>建立、维持、释放连接</p><h2 id="ppp协议">3.2 PPP协议</h2><h3 id="链路类型">链路类型</h3><p>广播链路-&gt;MAC协议，点到点链路-&gt;PPP协议</p><h3 id="ppp协议功能">PPP协议功能</h3><p>成帧方法、链路控制协议LCP、网络层选项协商方法NCP</p><h3 id="ppp协议帧的格式">PPP协议帧的格式</h3><p><img src="3.2-1.png" /></p><p>Flag字段表示帧的边界</p><p>Add地址字段</p><p>Ctrl控制字段，实际内容为03，为了以后升级可以添加其他控制信息</p><p>协议字段可以通过协商为1个字节</p><p>FCS检验字段，通过协商可以是4个字节</p><h3 id="ppp协议透明传输">PPP协议透明传输</h3><p>异步传输（按字节顺序）：字符填充法，0x7E定界，信息字段中的0x7E变为0x7D和0x5E，若再出现0x7D，0x7D变为0x7D和0x5D；若出现ASCII码的控制字符（即数值小于Ox20的字符），则在该字符前面要加入一个Ox7D字节，同时将该字符的编码加以改变</p><p>同步传输（按时间顺序）：以01111110为帧的边界，正文中每5个1强制后面添0</p><h3 id="ppp协议工作流程">PPP协议工作流程</h3><p><img src="屏幕截图%202023-12-21%20101540.png" /></p><h3 id="ppp协议无差错控制">PPP协议无差错控制</h3><p>①数据链路层出现差错概率不大，使用简单的PPP协议</p><p>②PPP协议主要承载的是IP数据报，IP协议本身是不可靠、无连接的</p><p>③PPP协议中的FCS字段可以保证无差错接受</p><h2 id="局域网mac协议">3.3 局域网MAC协议</h2><p>局域网数据链路层采用广播式通信，节点可以访问网内其他节点，是单位、家庭接入网络主要形式</p><h3 id="网卡">网卡</h3><p>实现CSMA/CD和CSMA/CA协议的设备、进行数据的串/并行转换和缓存、需要在计算机操作系统安装设备驱动程序</p><p><img src="image-20231221103755831.png" /></p><p>此处的硬件地址即MAC地址</p><h3 id="mac地址">MAC地址</h3><p>可采用6字节或2字节，用 - 分割或 : 分割或不分割都可</p><p>6字节MAC地址的前3字节为组织唯一标识符，即厂商标识，后3字节为拓展唯一标识符，厂商自行指派，保证不重复</p><p>适配器接收到MAC帧时首先检查地址字段是否为本站，不是则丢弃，混杂模式的网卡可收下所有的帧</p><p>IEEE规定地址字段第一字节的最低位为I/G位，发往本地的地址包括以下三种</p><p>单播（一对一）帧：I/G位=0</p><p>广播（一对所有）帧：I/G位=1</p><p>多播（一对多）帧：48位地址全为1</p><h3 id="多址接入协议">多址接入协议</h3><p><img src="image-20231221121751529.png" /></p><p>固定多址接入协议对应物理层的TDM、FDM、CDM，SDMA是空（空间）分复用</p><h3 id="随机多址接入协议">随机多址接入协议</h3><p>完全随机：</p><p>纯ALOHA：产生数据立即发送，不考虑信道占用情况，冲突的报文被丢弃，发生冲突后随机延迟</p><p>时隙的ALOHA：在上面基础上改为报文长度固定、必须在一个时隙内传输（即时间被分为时隙，报文必须在时隙开始处发送）</p><p>（载波侦听多址协议）CSMA：</p><p>非坚持：当节点监听到信道忙时，随机后延一段时间再来监听</p><p>1-坚持：节点发送数据前，先监听信道，若信道忙则一直监听直到空闲，一空闲立刻发送（其实要等9.6μs的最小帧间间隔）</p><p>P-坚持：同上，但空闲时以P的概率发送数据，1-P的概率推迟</p><h2 id="csmacd协议">3.4 CSMA/CD协议</h2><p>有线局域网以太网采用的MAC协议</p><p>两个基本特点：不可靠、无连接，采用曼彻斯特编码方式</p><p><img src="image-20231221154425445.png" /></p><p>电磁波在1km电缆的传播时延约5μs</p><h3 id="争用期">争用期</h3><p>CSMA/CD采用1-坚持，端到端往返时延2τ称为争用期，大小为51.2μs，以太网规定最短帧长64字节，即512bit，从而对于10Mbit/s的以太网，发送512bit的时间就是51.2μs，即争用期大小</p><p>经过争用期这段时间还没有检测到碰撞，就肯定此次发送不会发生碰撞</p><h3 id="beb二进制指数退避算法">BEB（二进制指数退避）算法</h3><p><img src="image-20231221162109560.png" /></p><p>发送数据的站检测到冲突后，还会发送32bit或48bit的人为干扰信号，<strong>且这个信号发送在BEB算法之前</strong></p><h3 id="csmacd协议帧格式">CSMA/CD协议帧格式</h3><p><img src="image-20231221164319609.png" /></p><p>注意头部的8bit前同步码与帧开始定界符</p><p>以太网规定帧间最小间隔为9.6μs</p><h2 id="无线网mac协议">3.5 无线网MAC协议</h2><h3 id="无线网络">无线网络</h3><p>WPAN（无线个域网）-&gt; WLAN（无线局域网）-&gt; WMAN（无线城域网）-&gt; WWAN（无线广域网）</p><p>支持WPAN主流技术：ZigBee（自组织网络形式建立网络拓扑）、蓝牙（标准为IEEE802.15.1）</p><p>WMAN的典型无线宽带接入城域网技术标准WiMAX</p><p>WWAN是蜂窝通信系统的主要解决方案</p><p>WLAN协议主要是802.11协议</p><h3 id="bss基本业务集">802.11 BSS（基本业务集）</h3><p>BSS：存在接入点（AP），负责集内工作站之间的通信</p><p>IBSS：独立的基本业务集，无接入点，又称移动自组网模式（Adhoc），所有节点都是无线通信</p><p>业务集由SSID标识，BSS中的BSSID可以理解为AP的MAC地址</p><p>ESS：通过骨干网将多个BSS串联起来形成，同一个ESS内的SSID相同</p><p>DS（分布式系统）：通过AP将无线局域网与有线局域网相连</p><h2 id="csmaca协议">3.6 CSMA/CA协议</h2><h3 id="面临的问题">802.11面临的问题</h3><p>隐藏终端问题、暴露终端问题</p><h3 id="帧间间隔">帧间间隔</h3><p>SIFS：一次交互过程中，两帧之间的间隔</p><p>PIFS：点协调方式下（AP控制下）访问信道的时间间隔</p><p>DIFS：两次业务之间的时间间隔</p><p>EIFS：前一帧出错时，需要延迟的时间间隔</p><h3 id="信道预约流程">信道预约流程</h3><p><img src="image-20231221175006078.png" /></p><p>CSMA/CD是冲突检测，CA是冲突避免（设备限制无法边发送边监听）</p><h3 id="beb算法">BEB算法</h3><p>退避窗口默认开始为[0,31]个slot，发生一次重传后，竞争窗口在[0,63]个slot中随机选取一个，每发生一次重传，竞争窗口就移至下一个2的指数，六次封顶</p><h3 id="帧结构">802.11帧结构</h3><p><img src="image-20231221184305524.png" /></p><p>字段内容略（太多了不想学...</p><h2 id="物理层和数据链路层网络互联设备">3.7物理层和数据链路层网络互联设备</h2><h3 id="物理层">物理层</h3><p>集线器（中继器的集中）、中继器</p><h3 id="数据链路层">数据链路层</h3><p><strong>网桥</strong>：生成树算法</p><p><strong>交换机</strong>：</p><p>通过地址学习过程将端口与MAC地址对应，泛洪</p><p>转发有存储转发（检查差错）与直通转发两种工作方式</p><p>划分VLAN（虚拟局域网）：基于端口划分、基于MAC地址、根据网络层、基于组播（后两种不适合局域网）</p><p>链路类型：访问（Access）与干路（Trunk）（多个VLAN之间的通信）</p><p>干道链路两端，输出端口会剥离VLAN标签，基于802.1Q帧</p><p><img src="image-20231221190440290.png" /></p><p>如上图，802.1Q是基于802.11帧的，添加了Tag字段，PRI字段表示优先级</p>]]></content>
      
      
      <categories>
          
          <category> 课程笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机网络笔记（二）</title>
      <link href="/2023/11/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
      <url>/2023/11/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="物理层">2.1 物理层</h2><p>物理层的协议常被称为规程（procedure）</p><p>数字信号离散，模拟信号连续</p><p>每秒钟传播码元的数目称为波特率</p><p>没有经过调制称为基带信号，仅对波形进行变换称为基带调制，也称编码；使用载波进行调制，把基带信号的频率范围搬移到较高的频段，并转换为模拟信号称为带通调制</p><h3 id="编码方式">编码方式</h3><p>不归零制、归零制、曼彻斯特编码（自同步）、差分曼彻斯特编码（线路可以反接但成本高）</p><h3 id="带通调制调幅调频调相">带通调制：调幅、调频、调相</h3><h3 id="信道最大数据速率">信道最大数据速率</h3><p>奈氏（无噪声条件）：$ C = 2Hlog_2L b/s $</p><p>香农（有噪声条件）：$ C = Hlog_2(1+S/N) b/s $</p><p>H 为信道带宽，L 为码元种类数（相位、调制方式等不同而不同），S为信道内所传信号的平均功率，N 为信道内部的高斯噪声功率</p><p>在理想低通（无噪声，带宽受限）条件下，为了避免码间串扰，极限码元传输速率为2H</p><h3 id="信噪比db-10-log_10sn">信噪比（dB）= 10 $ log_{10}(S/N) $</h3><h2 id="传输介质与多路复用">2.2 传输介质与多路复用</h2><h3 id="有线介质">有线介质</h3><p>双绞线：非屏蔽UTP、屏蔽STP，RJ45接口分为T-568A和T-568B（最常见接线线序）</p><p>光纤：单模原理绕射、多模原理反射</p><p><img src="2.2-1.png" /></p><h3 id="无线介质">无线介质</h3><p><img src="2.2-2.png" /></p><h3 id="多路复用">多路复用</h3><p>时分复用TDM（同步异步）、频分复用FDM（收音机；波分复用即光的频分复用）、码分复用CDM（自己和自己内积1，自己和反码内积-1，站点码元与码片内积1表示发送1，内积-1表示发送0，内积0表示未发送）</p>]]></content>
      
      
      <categories>
          
          <category> 课程笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机网络笔记（一）</title>
      <link href="/2023/11/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/"/>
      <url>/2023/11/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是计算机网络">1.1 什么是计算机网络</h2><p>计算机网络是<strong>通信技术</strong>与<strong>计算机技术</strong>相结合，实现<strong>信息传输</strong>和<strong>资源共享</strong>的一种信息系统</p><h2 id="计算机网络体系结构">1.2 计算机网络体系结构</h2><p>有无确认即可不可靠</p><h3 id="面向连接的服务电话">面向连接的服务（电话）：</h3><p>可靠的消息流：报文系列、网上下载完整页面</p><p>可靠的字节流：远程登录、ftp下载通过缓冲区分批下载</p><p>不可靠的连接：数字化声音（视频、直播）</p><h3 id="无连接的服务邮政">无连接的服务（邮政）：</h3><p>不可靠的数据报：电子函件</p><p>有确认的数据报：挂号邮件、快递</p><p>问答：数据查询</p><h3 id="协议三要素语法语义同步">协议三要素：语法、语义、同步</h3><h2 id="osi参考模型">1.3 OSI参考模型</h2><p>根据计算机网络的定义，将其分为通信子网（通信技术）与资源子网（计算机技术）</p><h3 id="通信子网">通信子网</h3><p>物理层：比特流传输</p><p>数据链路层：规范相邻节点的转发</p><p>网络层：寻址和路由</p><h3 id="资源子网">资源子网</h3><p>传输层：屏蔽通信子网统一接口</p><p>会话层：不同业务之间的同步、恢复会话中断前状态</p><p>表示层：数据格式转换、压缩、加密</p><p>应用层：与用户交互（分配IP地址、域名解析）</p><p><img src="1.3-1.png" /></p><p>数据链路层分为逻辑链路控制子层与媒体访问控制子层（已弱化）</p><p>网络层+：网络互联、为上层提供虚连接或数据报服务</p><p>路由：</p><p><img src="1.3-2.png" /></p><h3 id="路由算法">路由算法</h3><p>静态：扩散法、固定路由选择、随机路由选择、基于流量的路由选择</p><p>动态：独立路由选择、集中路由选择、分布式路由选择</p><h3 id="传输质量控制">传输质量控制</h3><p>分ABC类网络分别提供不同级别的服务</p><p>简单法、基本错误恢复类、多路复用类、错误恢复和多路复用类、错误检测和恢复类</p><h3 id="会话层">会话层</h3><p>+活动管理，是一个概念上的层，功能很弱，往往合并于传输层或应用层</p><h3 id="表示层">表示层</h3><p>也是一个概念上的层，通常在应用层实现，实际上的数据加密在应用层（加密对象具体信息块、文件）、传输层（通信进程、会话）、网络层（两个节点间所有通信）、数据链路层实现</p><h3 id="应用层">应用层</h3><p>+路由协议（部分，意味着路由协议不全在网络层），分为与通信相关和与通信无关两种</p><h2 id="tcpip参考模型">1.4 TCP/IP参考模型</h2><p><img src="1.4-1.png" /></p><p><img src="1.4-2.png" /></p><h3 id="应用层-1">应用层</h3><p>所谓套接字(Socket)，就是对网络中不同主机上的应用进程之间进行双向通信的端点的抽象。一个套接字就是网络上进程通信的一端，提供了应用层进程利用网络协议交换数据的机制。<span class="math display">\[Socket\ =\ IP\ address\ +\ TCP\ or\ UDP\ port\]</span>端口号分为服务器端口号与客户端端口号，服务器端口号往往是知名端口号，如80端口是TCP端口，为http开放；53端口是UDP端口，为DNS服务器开放。客户端端口号不固定，从1024以上随机产生，小于1024的端口被知名端口占用了，如上上面两个</p><h3 id="传输层">传输层</h3><p>多播或广播通信只能选择UDP协议，因为它是无连接的，单播通信TCP/UDP都可</p><p>TCP大文件，因为它是可靠的，保证数据正确完整性，UDP小文件，信道利用率高，快速发送数据</p><h3 id="网络层">网络层</h3><p>核心IP协议，ARP协议在逻辑地址（IP地址）与物理地址（网卡地址）建立映射关系，ICMP协议进行故障定位与网络中简单的管理功能，IGMP协议支持在网络中的多播通信</p><h3 id="网络接口层">网络接口层</h3><p>没有明确的约束，ATM、X.25、帧中继、以太网、FDDI等支持IP协议的都可以接入进来</p><p><img src="1.4-3.png" /></p><p>常用讨论的模型：物理层、数据链路层、网络层、传输层、应用层</p><h2 id="网络性能参数">1.5 网络性能参数</h2><p>带宽也和速率单位相同 bit/s，吞吐量指的是有效数据的速率</p><p>时延分为发送（取决于分组长度与额定速率）、传播（取决于物理距离、介质）、处理（主机或路由器处理的过程）、排队、接入（取决于信道使用权）时延，</p><p>时延带宽积=传播时延×带宽，又称以bit为单位的链路长度</p><p>时延抖动：由于数据分组交换，所走路径不同时延不同，克服的方法是利用缓存，但会增加时延（看视频开在缓存加载就是这个道理）</p><p>往返时间（RTT）：也称ping时间，对实现可靠通信非常重要，用于计算重传时间，算短了可能造成网络拥塞，算长了可能导致可靠性下降</p><p>信道利用率：发送方在一个发送周期的时间内，有效的发送数据所需要的时间占整个发送周期的比率，网络利用率是全网络的信道利用率的加权平均值<span class="math display">\[D=\frac{D_0}{1-U}\]</span> $ D_0 $为网络空闲时的时延，U是网络利用率</p>]]></content>
      
      
      <categories>
          
          <category> 课程笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023.10校赛WP</title>
      <link href="/2023/11/08/%E6%A0%A1%E8%B5%9BWP/"/>
      <url>/2023/11/08/%E6%A0%A1%E8%B5%9BWP/</url>
      
        <content type="html"><![CDATA[<h1 id="misc">Misc</h1><h2 id="你好来签到的旅行者">你好，来签到的旅行者</h2><p>微信公众号发送flag获得</p><p><img src="EF5AD68201DA7EED949F8D3462390D18.jpg" /></p><h2 id="纯黑的噩梦">纯黑的噩梦</h2><p>docx文件本质是压缩包，改后缀为.zip打开</p><p>在word-media中可以查看word中的图片文件</p><p><del>第一张图片是出题人小黑子证明</del>，第二张是所有的黑图，第三张是flag</p><p><img src="image3.png" /></p><h2 id="踩踩我的图">踩踩我的图</h2><p>首先是图片隐写题常见思路，binwalk一下，发现里面果然有秘密</p><p><img src="7.png" /></p><p>根据题目文件夹名与提示，搜索Picsel关键词，发现符合“合二为一”“军用级加密”的软件为</p><p><strong>SSuite Picsel Security</strong>（不得不说misc的涉猎确实广</p><p>下载软件并合并两图片得到flag</p><p><img src="8.png" /></p><h2 id="ezpcapng">ezpcapng</h2><p>pcapng文件，用wireshark打开，发现显目的GET /tmp/sql/sql4.php HTTP/1.1条目</p><p><img src="QQ图片20231025000650.png" /></p><p>意识到本题考查的是sql注入，先过滤http数据包，发现很多条注入记录，考虑是sql盲注</p><figure><img src="QQ截图20231025001515.png" alt="QQ截图20231025001515" /><figcaption aria-hidden="true">QQ截图20231025001515</figcaption></figure><p>前面是一些猜解库名、表名等的注入，找到猜解flag的注入起点</p><p><img src="123.png" /></p><p>ASCII码值为102的字符为f，向下检查，四个字符为flag，就是这里没错，接着向下查找，列写出最终flag</p><p>（当然有能力可以写个脚本依次提取所有字符，本人是一个个列出来的</p><h1 id="crypto">Crypto</h1><h2 id="matryoshka-doll">Matryoshka-doll</h2><p>访问实例得到字符串</p><p>LJCGG6SMLBXXQZLHOBYVSVDLPJGFQ2ZQJRLVCMCZPJJGUZSYNQ3U26S2NJMTG4DILFUTAMSNPJETEWSYNMYFSV2FGVGVCPJ5</p><p>分析source.py代码逻辑</p><p><img src="1.png" /></p><p>凯撒移位位数为1至25的随机数，栅栏宽度为2至10的随机数，然后是base64加密与base32加密</p><p>需要注意的是，根据函数名rail_fence也可以注意到，这里的栅栏密码是W型变种</p><p>了解以上之后，通过在线解密网站可以解出base64加密前字符串</p><p>d73-z1zja93-y4-d4c4c}y{36cczab-6326ey4aa91</p><p>枚举解密栅栏</p><p><img src="2.png" /></p><p>找到符合XXXX{XXXXXXX···}格式的密文，再Caeser枚举得到flag</p><p><img src="3.png" /></p><p>（吐槽一下出题人写的脚本</p><p><img src="XYGLRPHNK3@TJ4%7D6ZV%60%7BYSC.png" /></p><h1 id="pwn">Pwn</h1><h2 id="签到">签到</h2><p>根据要求，在linux环境下nc ctf.qwq.cc 端口号即可获得flag</p><h2 id="红包题1024">红包题！1024！</h2><p>本人<del>不怎么会</del>根本不会pwn，把1024完成了获得shell</p><p>ls下发现flag</p><p>cat flag查看flag内容</p><h1 id="web">Web</h1><h2 id="checkin">checkin</h2><p>访问实例，<del>果然又是原神</del>，虽然不是web手，但也知道web手的核心要义是网页源代码</p><p>F12发现开发者工具快捷键被ban了，右键发现也被ban了</p><p>还好还有一招，在网址前添加view-source:查看源代码，发现flag</p><figure><img src="QQ图片20231025010640.png" alt="QQ图片20231025010640" /><figcaption aria-hidden="true">QQ图片20231025010640</figcaption></figure><h2 id="ezphp">ezphp</h2><p>代码审计</p><p><img src="QQ图片20231025011102.png" /></p><p>发现可以数组绕过md5验证，通过Filter伪协议读取源码</p><p>需要注意读取形式选择base64编码，否则根据if(strstr($res,"flag"))die("DaMie!")会无法正常回显flag</p><p>网址后补充：</p><p>&amp;username[]=0&amp;password[]=1&amp;url=php://filter/read=convert.base64-encode/resource=&amp;target=/../../../../flag</p><p>得到源码（base64编码后）</p><p><img src="QQ图片20231025012331.png" /></p><p>base64解码得到flag</p><h1 id="reverse">Reverse</h1><h2 id="check_in">321check_in</h2><p>下载附件打开，发现.exe文件甚至没有办法运行，出现闪退的情况</p><p>结合题目提示，查壳发现，.exe文件应该是用exe4j打包的</p><p><img src="11.png" /></p><p>下载exe4j正常运行程序，那么为什么一定要正常运行程序呢？</p><p>因为java反编译的工具不能直接反编译exe文件，需要得到class文件或者jar包</p><p>而通过exe4j打包的exe程序在exe运行时会在...jar的缓存文件</p><p>（虽然但是，我并没有找到attachment.jar</p><p>但是根据文件生成时间，在e4jD82C.tmp_dir1698213950文件夹下找到了readme.jar</p><p><img src="12.png" /></p><p>用jd-gui反编译readme.jar，在主函数中发现flag</p><p><img src="13.png" /></p><h2 id="babyida">babyida</h2><p>查壳，无壳32位程序，ida32打开，结合题目提示，在字符串窗口中查找flag，发现一个假的flag</p><p><img src="14.png" /></p><p>题目提示学下动调秒了，于是动态调试看看，用x32dbg打开，找到Can youfind the flag?关键字符串处</p><p><img src="15.png" /></p><p>其实这个地方下面已经看到flag了，但别直接列写当flag了，还是得动调一下（别问我怎么知道的</p><p>接着往下分析，在00A21467处发现关键判断语句 jne babyida.A2147B</p><p><img src="16.png" /></p><p>说明若上一句cmp的结果为不相等，会跳转至00A2147B，输出“wrong!”</p><p>根据上面一大堆的汇编指令大致可以看到，进行比较的字符串（即目标flag）存储在几个寄存器中</p><p>直接在00A2147B处添加断点，让程序运行到这先别跳转，然后查看寄存器的值</p><p>运行程序，F9程序停在00A2147B处，在eax中发现flag值</p><p><img src="17.png" /></p><p>（一点也不baby</p><h2 id="ez_z3">ez_z3</h2><p>查壳，64位UPX壳，upx -d脱壳，发现居然报错了</p><p><img src="QQ图片20231025152958.png" /></p><p>面向搜索引擎，发现是文件加壳之后又进行了混淆，发现确实如此，区段名进行了更改</p><p><img src="18.png" /></p><p>于是010editor打开文件，把文件里的XYU全部改成UPX，再upx-d，脱壳成功</p><p><img src="QQ图片20231025161939.png" /></p><p>拖入ida查看，分析各函数的大致作用，然后可以先用z3约束求解器解出数据，脚本如下</p><p>脚本原文链接：<ahref="https://ctttttttt.github.io/2023/03/26/57/#分析">NSSCTF-RoundXeasy_z3 | 逆向上分之路 (ctttttttt.github.io)</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">a1 = [BitVec(<span class="string">&quot;num[%d]&quot;</span> % i, <span class="number">32</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)]</span><br><span class="line">s = Solver()</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">    + <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">    + <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">    + <span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">    + <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">    + <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">    + a1[<span class="number">0</span>]</span><br><span class="line">+ <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">- <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">- <span class="number">4</span> * a1[<span class="number">3</span>]</span><br><span class="line">- <span class="number">7</span> * a1[<span class="number">6</span>]</span><br><span class="line">+ <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">- <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">- <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">- <span class="number">16</span> * a1[<span class="number">15</span>] * <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">- <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">- <span class="number">18</span> * a1[<span class="number">17</span>] == <span class="number">2582239</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">    + <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">    + <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">    + <span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">    + <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">    - <span class="number">7</span> * a1[<span class="number">6</span>]</span><br><span class="line">    + <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">    - <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">    + <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">    + <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">    + <span class="number">2</span> * a1[<span class="number">1</span>] * a1[<span class="number">0</span>]</span><br><span class="line">    - <span class="number">4</span> * a1[<span class="number">3</span>]</span><br><span class="line">    - <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">    - <span class="number">16</span> * a1[<span class="number">15</span>] * <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">    - (<span class="number">18</span> * a1[<span class="number">17</span>]</span><br><span class="line">       + <span class="number">17</span> * a1[<span class="number">16</span>]) == <span class="number">2602741</span>)</span><br><span class="line">s.add(<span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">     + <span class="number">18</span> * a1[<span class="number">17</span>]</span><br><span class="line">     + <span class="number">14</span> * a1[<span class="number">13</span>] * <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">     + <span class="number">12</span> * a1[<span class="number">11</span>] * <span class="number">11</span> * a1[<span class="number">10</span>]</span><br><span class="line">     + <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">     + <span class="number">7</span> * a1[<span class="number">6</span>] * <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">     + a1[<span class="number">0</span>]</span><br><span class="line">     - <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">     - <span class="number">4</span> * a1[<span class="number">3</span>] * <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">     - <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">     + <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">     - <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">     - <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">     - <span class="number">17</span> * a1[<span class="number">16</span>] * <span class="number">16</span> * a1[<span class="number">15</span>]</span><br><span class="line">     - <span class="number">20</span> * a1[<span class="number">19</span>] == <span class="number">2668123</span>)</span><br><span class="line">s.add(<span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">     + <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     + (<span class="number">13</span> * a1[<span class="number">12</span>] + <span class="number">11</span> * a1[<span class="number">10</span>] - <span class="number">12</span> * a1[<span class="number">11</span>]) * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">     + <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">     + <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">     + a1[<span class="number">0</span>]</span><br><span class="line">     + <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">     - <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">     - <span class="number">4</span> * a1[<span class="number">3</span>]</span><br><span class="line">     - <span class="number">7</span> * a1[<span class="number">6</span>]</span><br><span class="line">     + <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">     - <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">     - <span class="number">16</span> * a1[<span class="number">15</span>] * <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">     - <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">     - <span class="number">18</span> * a1[<span class="number">17</span>] == <span class="number">2520193</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">18</span> * a1[<span class="number">17</span>]</span><br><span class="line">    + <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">    + <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">    + <span class="number">13</span> * a1[<span class="number">12</span>] * <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">    + <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">    + <span class="number">9</span> * a1[<span class="number">8</span>] * <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">    + <span class="number">3</span> * a1[<span class="number">2</span>] * <span class="number">2</span> * a1[<span class="number">1</span>] * a1[<span class="number">0</span>]</span><br><span class="line">    - <span class="number">4</span> * a1[<span class="number">3</span>]</span><br><span class="line">    - <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">    - <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">    - <span class="number">7</span> * a1[<span class="number">6</span>]</span><br><span class="line">    - <span class="number">11</span> * a1[<span class="number">10</span>]</span><br><span class="line">    - <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">    - <span class="number">16</span> * a1[<span class="number">15</span>]</span><br><span class="line">    - <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">    - <span class="number">20</span> * a1[<span class="number">19</span>] == <span class="number">8904587</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">18</span> * a1[<span class="number">17</span>]</span><br><span class="line">    + <span class="number">7</span> * a1[<span class="number">6</span>] * <span class="number">30</span> * a1[<span class="number">5</span>] * <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">    + <span class="number">4</span> * a1[<span class="number">3</span>]</span><br><span class="line">    + <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">    + a1[<span class="number">0</span>]</span><br><span class="line">- <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">- <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">- <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">- <span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">- <span class="number">16</span> * a1[<span class="number">15</span>] * (<span class="number">13</span> * a1[<span class="number">12</span>] + <span class="number">12</span> * a1[<span class="number">11</span>] - <span class="number">14</span> * a1[<span class="number">13</span>] - <span class="number">15</span> * a1[<span class="number">14</span>])</span><br><span class="line">- <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">- <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">- <span class="number">20</span> * a1[<span class="number">19</span>] == <span class="number">1227620874</span>)</span><br><span class="line">s.add(<span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">     + <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">     + <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     + <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">     + <span class="number">12</span> * a1[<span class="number">11</span>] * <span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">     + <span class="number">7</span> * a1[<span class="number">6</span>] * <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">     + <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">     + <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">     + a1[<span class="number">0</span>]</span><br><span class="line">     + <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">     + <span class="number">4</span> * a1[<span class="number">3</span>]</span><br><span class="line">     + <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">     - <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">     - <span class="number">16</span> * a1[<span class="number">15</span>] * <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">     - <span class="number">18</span> * a1[<span class="number">17</span>] == <span class="number">1836606059</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">    + <span class="number">16</span> * a1[<span class="number">15</span>] * <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">    + <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">    + <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">    + <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">    + <span class="number">7</span> * a1[<span class="number">6</span>] * <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">    + <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">    + <span class="number">2</span> * a1[<span class="number">1</span>] * a1[<span class="number">0</span>]</span><br><span class="line">    - <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">    + <span class="number">4</span> * a1[<span class="number">3</span>]</span><br><span class="line">    + <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">    - <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">    - <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">    - <span class="number">11</span> * a1[<span class="number">10</span>]</span><br><span class="line">    - <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">    - <span class="number">18</span> * a1[<span class="number">17</span>] == <span class="number">8720560</span>)</span><br><span class="line">s.add(<span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">     + <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     + <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">     + <span class="number">11</span> * a1[<span class="number">10</span>] * (<span class="number">10</span> * a1[<span class="number">9</span>] + <span class="number">30</span> * a1[<span class="number">5</span>] + <span class="number">5</span> * a1[<span class="number">4</span>] + <span class="number">4</span> * a1[<span class="number">3</span>] - <span class="number">7</span> * a1[<span class="number">6</span>] + <span class="number">8</span> * a1[<span class="number">7</span>] - <span class="number">9</span> * a1[<span class="number">8</span>])</span><br><span class="line">     + a1[<span class="number">0</span>]</span><br><span class="line">     + <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">     - <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">     - <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">     - (<span class="number">16</span> * a1[<span class="number">15</span>] - <span class="number">17</span> * a1[<span class="number">16</span>] - <span class="number">18</span> * a1[<span class="number">17</span>]) * <span class="number">15</span> * a1[<span class="number">14</span>] == <span class="number">11387045</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">    + <span class="number">16</span> * a1[<span class="number">15</span>] * <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">    + <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">    + <span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">    + <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">    + <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">    + a1[<span class="number">0</span>]</span><br><span class="line">- <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">+ <span class="number">4</span> * a1[<span class="number">3</span>]</span><br><span class="line">- <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">- <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">- <span class="number">7</span> * a1[<span class="number">6</span>]</span><br><span class="line">+ <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">- <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">- <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">- <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">- <span class="number">18</span> * a1[<span class="number">17</span>] == <span class="number">7660269</span>)</span><br><span class="line">s.add(<span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">     + <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     + <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">     + <span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">     - <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">     + a1[<span class="number">0</span>]</span><br><span class="line">     + <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">     - (<span class="number">4</span> * a1[<span class="number">3</span>] * <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">      - <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">      - <span class="number">30</span> * a1[<span class="number">5</span>])</span><br><span class="line">     - <span class="number">7</span> * a1[<span class="number">6</span>]</span><br><span class="line">     + <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">     - <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">     - <span class="number">16</span> * a1[<span class="number">15</span>] * <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">     - <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">     - <span class="number">18</span> * a1[<span class="number">17</span>] == <span class="number">2461883</span>)</span><br><span class="line">s.add(</span><br><span class="line">    <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">    + <span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">    + <span class="number">9</span> * a1[<span class="number">8</span>] * <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">    + <span class="number">7</span> * a1[<span class="number">6</span>]</span><br><span class="line">    + <span class="number">2</span> * a1[<span class="number">1</span>] * a1[<span class="number">0</span>]</span><br><span class="line">    - <span class="number">4</span> * a1[<span class="number">3</span>] * <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">    - <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">    - <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">    - <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">    - <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">    - <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">    - <span class="number">17</span> * a1[<span class="number">16</span>] * <span class="number">16</span> * a1[<span class="number">15</span>]</span><br><span class="line">    - <span class="number">18</span> * a1[<span class="number">17</span>]</span><br><span class="line">    - <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">    - <span class="number">20</span> * a1[<span class="number">19</span>] == -<span class="number">966296</span>)</span><br><span class="line"></span><br><span class="line">s.add(</span><br><span class="line"><span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     + <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">     + (<span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>] + <span class="number">30</span> * a1[<span class="number">5</span>] + <span class="number">5</span> * a1[<span class="number">4</span>] + <span class="number">3</span> * a1[<span class="number">2</span>] + <span class="number">4</span> * a1[<span class="number">3</span>] - <span class="number">7</span> * a1[<span class="number">6</span>] + <span class="number">8</span> * a1[<span class="number">7</span>] - <span class="number">9</span> * a1[<span class="number">8</span>])</span><br><span class="line">     * <span class="number">2</span></span><br><span class="line">     * a1[<span class="number">1</span>]</span><br><span class="line">     + a1[<span class="number">0</span>]</span><br><span class="line">     - <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">     - <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">     - <span class="number">16</span> * a1[<span class="number">15</span>]</span><br><span class="line">     - <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">     - <span class="number">18</span> * a1[<span class="number">17</span>]</span><br><span class="line">     - <span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>] == <span class="number">254500223</span></span><br><span class="line">    )</span><br><span class="line">s.add(</span><br><span class="line"><span class="number">16</span> * a1[<span class="number">15</span>] * <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">     + <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     + <span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">     + <span class="number">7</span> * a1[<span class="number">6</span>] * <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">     + a1[<span class="number">0</span>]</span><br><span class="line">     - <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">     - <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">     - <span class="number">5</span> * a1[<span class="number">4</span>] * <span class="number">4</span> * a1[<span class="number">3</span>]</span><br><span class="line">     + <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">     - <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">     - <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">     - <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">     - <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">     - <span class="number">18</span> * a1[<span class="number">17</span>]</span><br><span class="line">     - <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">     - <span class="number">20</span> * a1[<span class="number">19</span>] == <span class="number">6022286</span></span><br><span class="line">    )</span><br><span class="line">s.add(</span><br><span class="line"><span class="number">18</span> * a1[<span class="number">17</span>]</span><br><span class="line">     + <span class="number">16</span> * a1[<span class="number">15</span>]</span><br><span class="line">     - <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">     + <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     + <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">     + <span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">     + <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">     + <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">     + <span class="number">4</span> * a1[<span class="number">3</span>] * <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">     + <span class="number">2</span> * a1[<span class="number">1</span>] * a1[<span class="number">0</span>]</span><br><span class="line">     - <span class="number">9</span> * a1[<span class="number">8</span>] * <span class="number">8</span> * a1[<span class="number">7</span>] * <span class="number">7</span> * a1[<span class="number">6</span>]</span><br><span class="line">     - <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">     - <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">     - <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">     - <span class="number">20</span> * a1[<span class="number">19</span>] == -<span class="number">636956022</span></span><br><span class="line">    )</span><br><span class="line">s.add(</span><br><span class="line"><span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">     + <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">     + <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">     + <span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">     + <span class="number">7</span> * a1[<span class="number">6</span>]</span><br><span class="line">     + <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">     + <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">     + <span class="number">3</span> * a1[<span class="number">2</span>] * <span class="number">2</span> * a1[<span class="number">1</span>] * a1[<span class="number">0</span>]</span><br><span class="line">     - <span class="number">4</span> * a1[<span class="number">3</span>]</span><br><span class="line">     - <span class="number">9</span> * a1[<span class="number">8</span>] * <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">     - <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     - <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">     - <span class="number">16</span> * a1[<span class="number">15</span>]</span><br><span class="line">     - <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">     - <span class="number">18</span> * a1[<span class="number">17</span>] == <span class="number">10631829</span></span><br><span class="line">)</span><br><span class="line">s.add(</span><br><span class="line"><span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">     + <span class="number">16</span> * a1[<span class="number">15</span>]</span><br><span class="line">     - <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">     - <span class="number">18</span> * a1[<span class="number">17</span>]</span><br><span class="line">     + <span class="number">15</span> * a1[<span class="number">14</span>] * <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     + <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">     + <span class="number">11</span> * a1[<span class="number">10</span>] * <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">     - <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">     + <span class="number">7</span> * a1[<span class="number">6</span>]</span><br><span class="line">     + (<span class="number">4</span> * a1[<span class="number">3</span>] - <span class="number">5</span> * a1[<span class="number">4</span>] - <span class="number">30</span> * a1[<span class="number">5</span>]) * <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">     + a1[<span class="number">0</span>]</span><br><span class="line">     + <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">     + <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">     - <span class="number">9</span> * a1[<span class="number">8</span>] == <span class="number">6191333</span></span><br><span class="line">)</span><br><span class="line">s.add(</span><br><span class="line"><span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     + <span class="number">10</span> * a1[<span class="number">9</span>] * <span class="number">9</span> * a1[<span class="number">8</span>] * <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">     + <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">     + <span class="number">4</span> * a1[<span class="number">3</span>] * <span class="number">3</span> * a1[<span class="number">2</span>]</span><br><span class="line">     + <span class="number">2</span> * a1[<span class="number">1</span>] * a1[<span class="number">0</span>]</span><br><span class="line">     - <span class="number">7</span> * a1[<span class="number">6</span>] * <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">     - <span class="number">11</span> * a1[<span class="number">10</span>]</span><br><span class="line">     - <span class="number">13</span> * a1[<span class="number">12</span>] * <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">     - <span class="number">16</span> * a1[<span class="number">15</span>] * <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">     - <span class="number">18</span> * a1[<span class="number">17</span>] * <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">     - <span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>] == <span class="number">890415359</span></span><br><span class="line">)</span><br><span class="line">s.add(</span><br><span class="line"><span class="number">20</span> * a1[<span class="number">19</span>]</span><br><span class="line">     + <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">     + <span class="number">18</span> * a1[<span class="number">17</span>]</span><br><span class="line">     + <span class="number">16</span> * a1[<span class="number">15</span>]</span><br><span class="line">     - <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">     + <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">     + <span class="number">11</span> * a1[<span class="number">10</span>]</span><br><span class="line">     + <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">     + <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">     + <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">     + a1[<span class="number">0</span>]</span><br><span class="line">     + <span class="number">4</span> * a1[<span class="number">3</span>] * <span class="number">3</span> * a1[<span class="number">2</span>] * <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">     - <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">     - <span class="number">7</span> * a1[<span class="number">6</span>]</span><br><span class="line">     + <span class="number">8</span> * a1[<span class="number">7</span>]</span><br><span class="line">     - <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">     - <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     - <span class="number">15</span> * a1[<span class="number">14</span>] == <span class="number">23493664</span></span><br><span class="line">)</span><br><span class="line">s.add(</span><br><span class="line"><span class="number">20</span> * a1[<span class="number">19</span>] * <span class="number">19</span> * a1[<span class="number">18</span>]</span><br><span class="line">     + <span class="number">13</span> * a1[<span class="number">12</span>]</span><br><span class="line">     + <span class="number">12</span> * a1[<span class="number">11</span>]</span><br><span class="line">     + <span class="number">10</span> * a1[<span class="number">9</span>]</span><br><span class="line">     + <span class="number">3</span> * a1[<span class="number">2</span>] * <span class="number">2</span> * a1[<span class="number">1</span>]</span><br><span class="line">     + a1[<span class="number">0</span>]</span><br><span class="line">     - <span class="number">4</span> * a1[<span class="number">3</span>]</span><br><span class="line">     - <span class="number">5</span> * a1[<span class="number">4</span>]</span><br><span class="line">     + <span class="number">8</span> * a1[<span class="number">7</span>] * <span class="number">7</span> * a1[<span class="number">6</span>] * <span class="number">30</span> * a1[<span class="number">5</span>]</span><br><span class="line">     - <span class="number">9</span> * a1[<span class="number">8</span>]</span><br><span class="line">     - <span class="number">11</span> * a1[<span class="number">10</span>]</span><br><span class="line">     - <span class="number">14</span> * a1[<span class="number">13</span>]</span><br><span class="line">     - <span class="number">16</span> * a1[<span class="number">15</span>] * <span class="number">15</span> * a1[<span class="number">14</span>]</span><br><span class="line">     - <span class="number">17</span> * a1[<span class="number">16</span>]</span><br><span class="line">     - <span class="number">18</span> * a1[<span class="number">17</span>] == <span class="number">1967260144</span></span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(s.check())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a1:</span><br><span class="line">    <span class="built_in">print</span>(s.model()[i].as_long(), end=<span class="string">&quot;,&quot;</span>)</span><br><span class="line"><span class="comment">#跑出来的结果是[104,97,104,97,104,97,116,104,105,115,105,115,102,97,99,107,102,108,97,103]</span></span><br></pre></td></tr></table></figure><p>得到参数，写脚本得到flag</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">DWORD <span class="title function_">Get_254D0</span><span class="params">(DWORD d254D0[<span class="number">20</span>])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">DWORD d25050[<span class="number">20</span>] = &#123;<span class="number">0X1207</span>,<span class="number">0X4CA0</span>,<span class="number">0X4F21</span>,<span class="number">0X39</span>,<span class="number">0X1A523</span>,<span class="number">0X23A</span>,<span class="number">0X926</span>,<span class="number">0X4CA7</span>,</span><br><span class="line"><span class="number">0X6560</span>,<span class="number">0X36</span>,<span class="number">0X1A99B</span>,<span class="number">0X4CA8</span>,<span class="number">0X1BBE0</span>,<span class="number">0X3705</span>,<span class="number">0X926</span>,<span class="number">0X77D3</span>,</span><br><span class="line"><span class="number">0X9A98</span>,<span class="number">0X657B</span>,<span class="number">0X18</span>,<span class="number">0X0B11</span>&#125;;</span><br><span class="line"><span class="keyword">for</span>( i ; i &lt; <span class="number">20</span> ; i++)</span><br><span class="line">&#123;</span><br><span class="line">d254D0[i] = d25050[i];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DWORD <span class="title function_">Get_25520</span><span class="params">(DWORD d25520[<span class="number">20</span>], DWORD d254D0[<span class="number">20</span>],DWORD a[<span class="number">20</span>])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> ( <span class="type">int</span> i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="type">int</span> v2 = i;</span><br><span class="line">    <span class="keyword">if</span> ( v2 &gt;= <span class="number">20</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">   <span class="type">int</span> v3 = i;</span><br><span class="line">    d25520[v3] = *(a + <span class="number">20</span> - i - <span class="number">1</span>) ^ d254D0[i]; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DWORD <span class="title function_">sub_1124E</span><span class="params">(DWORD a1, DWORD a2)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> v3; </span><br><span class="line">  v3 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (a2 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      v3 *= a1;</span><br><span class="line">    a1 = a1 * a1 % <span class="number">1000</span>;</span><br><span class="line">    a2 &gt;&gt;= <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">DWORD a[<span class="number">20</span>] = &#123;<span class="number">104</span>,<span class="number">97</span>,<span class="number">104</span>,<span class="number">97</span>,<span class="number">104</span>,<span class="number">97</span>,<span class="number">116</span>,<span class="number">104</span>,<span class="number">105</span>,<span class="number">115</span>,<span class="number">105</span>,<span class="number">115</span>,<span class="number">102</span>,<span class="number">97</span>,<span class="number">99</span>,<span class="number">107</span>,<span class="number">102</span>,<span class="number">108</span>,<span class="number">97</span>,<span class="number">103</span>&#125;;</span><br><span class="line">DWORD d254D0[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">DWORD d25520[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">DWORD d25000[<span class="number">20</span>] = &#123; <span class="number">0x07</span>, <span class="number">0x07</span>, <span class="number">0x07</span>, <span class="number">0x09</span>, <span class="number">0x05</span>, <span class="number">0x06</span>, <span class="number">0x07</span>, <span class="number">0x07</span>, <span class="number">0x07</span>, </span><br><span class="line"> <span class="number">0x09</span>, <span class="number">0x07</span>, <span class="number">0x07</span>, <span class="number">0x05</span>, <span class="number">0x07</span>, <span class="number">0x07</span>, <span class="number">0x07</span>, <span class="number">0x05</span>, <span class="number">0x07</span>,</span><br><span class="line"> <span class="number">0x09</span>, <span class="number">0x07</span>&#125;;</span><br><span class="line">DWORD Str[<span class="number">20</span>];</span><br><span class="line">DWORD v3;</span><br><span class="line"></span><br><span class="line">Get_254D0(d254D0);</span><br><span class="line">Get_25520(d25520,d254D0,a);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里用的是爆破的方法</span></span><br><span class="line"><span class="keyword">for</span>(DWORD p = <span class="number">0</span> ; p &lt; <span class="number">20</span> ; p++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span>( DWORD k = <span class="number">0</span> ; k &lt; <span class="number">127</span> ; k++)</span><br><span class="line">&#123;</span><br><span class="line">Str[p] = k;</span><br><span class="line"><span class="keyword">if</span>( d25520[p] == sub_1124E(Str[p], d25000[p]) )</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,k);</span><br><span class="line"><span class="keyword">break</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//T1e_z3_1s_v1r9_3asy!</span></span><br></pre></td></tr></table></figure><h2 id="base64">base64</h2><p>ida64打开，一眼看去像是base64编码格式的字符串，但直接base64解码显然不行</p><p><img src="5.png" /></p><p>题目提示需要修复base64编码，还需要运行linux命令</p><p>但幸运的事发生了！</p><p>做re题的习惯性做法，先查看字符串列表，直接发现了...</p><p><img src="4.png" /></p><p>这个就是base64替换的新表，上脚本，运行得到flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">str1 = <span class="string">&quot;ZXFWtmKgDZCyrmC5B+CiVfsyXUCQVfsyZRFzDU4yX2YCD/F5Ih8=&quot;</span></span><br><span class="line"></span><br><span class="line">string1 = <span class="string">&quot;QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbn/+m1234567890&quot;</span></span><br><span class="line">string2 = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64decode(str1.translate(<span class="built_in">str</span>.maketrans(string1,string2))))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="A.png" /></p><h2 id="odscript">odscript</h2><p>查壳，32位无壳，运行一下发现是弹窗输入注册码，随便输提示有错误，<del>然后再读读曹操身边的故事</del></p><p>输入注册码，显示结果都是以弹窗的形式，可以尝试去寻找Messagebox函数</p><p>ida打开，发现sub_4016E0和sub_401720中都有调用Messagebox函数</p><p><img src="QQ图片20231025202407.png" /></p><p>可以合理猜测是两个结果的弹窗，一个是显示正确，一个是显示错误</p><p>在x32dbg里这两处都下断点，随机输入注册码，发现程序停在sub_401720处，无弹窗，再F9出现错误弹窗，确定想法是对的</p><p>于是看sub_4016E0，通过IDA交叉引用看到，.text:00401617引用了该函数</p><p>来到.text:00401617</p><p><img src="QQ截图20231025205445.png" /></p><p>看到一些关键函数</p><p><img src="QQ截图20231025205708.png" /></p><p>跟进，发现是正是sub_401630调用了CString::CString函数</p><p><img src="QQ截图20231025210102.png" /></p><p>阅读代码，大致意思是判断a2指向的一段内存和this指向的一段内存是否相等</p><p>那么调试时停在sub_401630处F7单步即可查看里面的内容</p><p>那么问题来了</p><p>上面试过，随便输的注册码，即使在sub_401630处添加了断点，F9也是停在sub_401720处</p><p>说明上方还有跳转，直接跳过sub_401630起的正确弹窗区域，跳到sub_401720错误弹窗去了</p><p>向上查看，果然有问题</p><p><img src="QQ截图20231025212258.png" /></p><p>阅读最上面红框内容，知道需要满足输入的字符串长度为0x21，即33个字符</p><p>得到以上信息，就可以开始调试了，x32dbg打开</p><p>在00401630处设置断点，F9，输入随机的长度为33字符的字符串</p><p>程序停在00401630处，F7单步步入，跳转比较函数后发现flag</p><p><img src="QQ截图20231025213613.png" /></p><p><img src="QQ截图20231025213750.png" /></p><p>（或者我写wp的时候才发现00401666处已经有了</p>]]></content>
      
      
      <categories>
          
          <category> WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
